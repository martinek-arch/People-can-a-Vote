<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>People Can Vote</title>
<style>
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 24px; }
  #boot { position: fixed; bottom: 10px; left: 10px; font-size: 12px; color: #555; background: rgba(255,255,255,0.9); padding: 6px 8px; border-radius: 8px; }
  .hidden { display:none; }
  button { padding:8px 12px; margin:4px; }
</style>
</head>
<body>
<div id="app">
  <h1>People Can Vote</h1>

  <div id="auth-status">Načítání uživatele…</div>

  <div id="auth-actions">
    <button id="loginBtn">Přihlásit</button>
    <button id="logoutBtn" class="hidden">Odhlásit</button>
  </div>

  <hr>

  <div id="stats">
    <p><b>Statistiky</b> – viditelné pro každého.</p>
  </div>

  <div id="vote-area" class="hidden">
    <button id="voteBtn">Hlasovat</button>
  </div>

  <div id="vote-disabled" class="hidden">
    <p><b>Hlasování je dostupné pouze pro přihlášené a ověřené uživatele.</b></p>
  </div>
</div>

<div id="boot">Booting…</div>

<script>
if (window.__PCV_INIT_DONE__) {
  console.warn("PCV: duplicate init prevented");
} else {
  window.__PCV_INIT_DONE__ = true;

  function boot(msg) {
    const el = document.getElementById("boot");
    if (el) el.textContent = msg;
    console.log(msg);
  }

  async function loadSupabase() {
    boot("Init: loading Supabase…");
    return new Promise((resolve, reject) => {
      const s = document.createElement("script");
      s.src = "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2";
      s.async = true;
      s.onload = () => resolve(window.supabase);
      s.onerror = () => reject(new Error("Supabase load failed"));
      document.head.appendChild(s);
      setTimeout(() => reject(new Error("Supabase load timeout")), 12000);
    });
  }

  (async function init() {
    try {
      boot("Init: JS running");

      const supabaseLib = await loadSupabase();

      const SUPABASE_URL = "https://YOUR_PROJECT_ID.supabase.co";
      const SUPABASE_ANON_KEY = "YOUR_PUBLIC_ANON_KEY";

      const supabaseClient = supabaseLib.createClient(
        SUPABASE_URL,
        SUPABASE_ANON_KEY
      );

      boot("Init: Supabase ready");

      const { data: { session } } = await supabaseClient.auth.getSession();

      const authStatus = document.getElementById("auth-status");
      const loginBtn = document.getElementById("loginBtn");
      const logoutBtn = document.getElementById("logoutBtn");
      const voteArea = document.getElementById("vote-area");
      const voteDisabled = document.getElementById("vote-disabled");

      if (!session) {
        authStatus.textContent = "Nepřihlášený uživatel";
        loginBtn.onclick = () => supabaseClient.auth.signInWithOtp({
          email: prompt("Zadej email")
        });
        voteDisabled.classList.remove("hidden");
      } else {
        const user = session.user;
        const verified = !!user.email_confirmed_at;

        authStatus.textContent = verified
          ? "Přihlášený a ověřený uživatel"
          : "Přihlášený, ale NEověřený uživatel";

        loginBtn.classList.add("hidden");
        logoutBtn.classList.remove("hidden");
        logoutBtn.onclick = () => supabaseClient.auth.signOut();

        if (verified) {
          voteArea.classList.remove("hidden");
        } else {
          voteDisabled.classList.remove("hidden");
        }
      }

      boot("Boot: ready");
    } catch (err) {
      boot("Startup error: " + err.message);
      console.error(err);
    }
  })();
}
</script>
</body>
</html>
