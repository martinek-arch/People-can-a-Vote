<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>People can a Vote</title>

<!-- Mapbox CSS -->
<link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet"/>

<style>
  body { margin:0; font-family: Arial,sans-serif; background:#f4f6f8; }
  header { padding:20px; background:#fff; box-shadow:0 2px 4px rgba(0,0,0,0.1); }
  h1 { margin:0 0 5px 0; }
  section { padding:20px; }
  .event { background:#fff; padding:15px; border-radius:6px; margin-bottom:10px; }
  #map { width:100%; height:500px; }
  button { margin-right:5px; padding:5px 10px; cursor:pointer; }
</style>
</head>
<body>

<header>
  <h1>People can a Vote</h1>
  <p>Global view of opinions from around the world</p>
</header>

<!-- Přihlášení / Registrace -->
<section id="auth" style="background:#fff; border-radius:6px; margin:20px; padding:20px;">
  <div id="auth-forms">
    <input type="email" id="email" placeholder="Email" />
    <input type="password" id="password" placeholder="Heslo" />
    <button id="signup-btn">Registrovat</button>
    <button id="login-btn">Přihlásit</button>
  </div>
  <div id="auth-logged" style="display:none;">
    <span id="auth-message"></span>
    <button id="logout-btn">Odhlásit</button>
  </div>
</section>

<!-- Události -->
<section id="events">
  <h2>Aktuální hlasovací události</h2>
</section>

<!-- Hlasování -->
<div id="vote-buttons" style="padding:20px; background:#fff; border-radius:6px; margin:20px; display:none;">
  <h3>Hlasujte:</h3>
  <button id="vote-yes">Ano</button>
  <button id="vote-no">Ne</button>
  <button id="vote-neutral">Nemám názor</button>
  <p id="vote-message"></p>
</div>

<div id="vote-stats" style="padding:20px;"></div>

<!-- Mapa -->
<div id="map"></div>

<!-- Mapbox JS -->
<script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>

<!-- Supabase JS -->
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<script>
/* -------------------------------
   Supabase klient
------------------------------- */
const SUPABASE_URL = 'https://jqoomnhpyuikbntnrukw.supabase.co';
const SUPABASE_ANON_KEY = 'sb_publishable_SjZ_HQWN0XRE9ebbf_OwQg_kmJeS43h';
const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* -------------------------------
   Proměnné pro hlasování
------------------------------- */
const voteButtons = document.getElementById('vote-buttons');
const voteMessage = document.getElementById('vote-message');
const voteStats = document.getElementById('vote-stats');
let currentEventId = null;

/* -------------------------------
   Přihlášení / Registrace
------------------------------- */
const emailInput = document.getElementById('email');
const passwordInput = document.getElementById('password');
const signupBtn = document.getElementById('signup-btn');
const loginBtn = document.getElementById('login-btn');
const logoutBtn = document.getElementById('logout-btn');
const authMessage = document.getElementById('auth-message');

signupBtn.addEventListener('click', async () => {
  const { data, error } = await client.auth.signUp({
    email: emailInput.value,
    password: passwordInput.value
  });
  if (error) authMessage.textContent = `Chyba: ${error.message}`;
  else authMessage.textContent = 'Registrace úspěšná! Zkontrolujte email.';
  updateAuthUI();
});

loginBtn.addEventListener('click', async () => {
  const { data, error } = await client.auth.signInWithPassword({
    email: emailInput.value,
    password: passwordInput.value
  });
  if (error) authMessage.textContent = `Chyba: ${error.message}`;
  updateAuthUI();
});

logoutBtn.addEventListener('click', async () => {
  await client.auth.signOut();
  authMessage.textContent = 'Odhlášen';
  updateAuthUI();
});

function updateAuthUI() {
  client.auth.getSession().then(res => {
    const user = res.data.session?.user;
    if (user) {
      document.getElementById('auth-forms').style.display = 'none';
      document.getElementById('auth-logged').style.display = 'block';
      document.getElementById('auth-message').textContent = `Přihlášen jako: ${user.email}`;
      voteButtons.style.display = 'block';
    } else {
      document.getElementById('auth-forms').style.display = 'block';
      document.getElementById('auth-logged').style.display = 'none';
      voteButtons.style.display = 'none';
    }
  });
}

/* -------------------------------
   Načtení událostí
------------------------------- */
async function loadEvents() {
  const { data, error } = await client
    .from('events')
    .select('id, title, description, country_id')
    .eq('is_active', true);

  if (error) { console.error(error); return; }

  const container = document.getElementById('events');
  container.innerHTML = '<h2>Aktuální hlasovací události</h2>';

  if (data.length > 0) currentEventId = data[0].id;

  data.forEach(event => {
    const div = document.createElement('div');
    div.className = 'event';
    div.innerHTML = `<strong>${event.title}</strong><br><small>${event.description || ''}</small>`;
    container.appendChild(div);
  });

  if (currentEventId) {
    await loadVoteStats(currentEventId);
    await checkUserVote(currentEventId);
  }
}

/* -------------------------------
   Kontrola, jestli už hlasoval
------------------------------- */
async function checkUserVote(eventId) {
  const session = await client.auth.getSession();
  const user = session.data.session?.user;
  if (!user) { voteButtons.style.display = 'none'; return false; }

  const { data: existing } = await client
    .from('votes')
    .select('id')
    .eq('user_id', user.id)
    .eq('event_id', eventId)
    .single();

  if (existing) {
    voteButtons.style.display = 'none';
    voteMessage.textContent = 'Už jste hlasoval pro tuto událost.';
    return true;
  } else {
    voteButtons.style.display = 'block';
    voteMessage.textContent = '';
    return false;
  }
}

/* -------------------------------
   Hlasování
------------------------------- */
async function submitVote(voteValue) {
  const session = await client.auth.getSession();
  const user = session.data.session?.user;
  if (!user) { voteMessage.textContent = 'Musíte být přihlášeni.'; return; }

  const { data: existing } = await client
    .from('votes')
    .select('id')
    .eq('user_id', user.id)
    .eq('event_id', currentEventId)
    .single();

  if (existing) {
    voteMessage.textContent = 'Už jste hlasoval pro tuto událost.';
    voteButtons.style.display = 'none';
    return;
  }

  const { error } = await client
    .from('votes')
    .insert([{
      user_id: user.id,
      event_id: currentEventId,
      vote: voteValue,
      country_code: 'GL'
    }]);

  if (error) voteMessage.textContent = `Chyba: ${error.message}`;
  else {
    voteMessage.textContent = 'Hlas uložen!';
    voteButtons.style.display = 'none';
    await loadVoteStats(currentEventId);
  }
}

document.getElementById('vote-yes').addEventListener('click', () => submitVote('yes'));
document.getElementById('vote-no').addEventListener('click', () => submitVote('no'));
document.getElementById('vote-neutral').addEventListener('click', () => submitVote('neutral'));

/* -------------------------------
   Statistiky hlasování
------------------------------- */
async function loadVoteStats(eventId) {
  const { data, error } = await client
    .from('votes')
    .select('vote, country_code')
    .eq('event_id', eventId);

  if (error) { console.error(error); return; }

  const total = data.length;
  const fromGL = data.filter(v => v.country_code === 'GL').length;
  const others = total - fromGL;
  const yes = data.filter(v => v.vote === 'yes').length;
  const no = data.filter(v => v.vote === 'no').length;
  const neutral = data.filter(v => v.vote === 'neutral').length;

  voteStats.innerHTML = `
    <h3>Statistiky hlasování</h3>
    <p>Celkem hlasů: ${total}</p>
    <p>Ano: ${yes} | Ne: ${no} | Nemám názor: ${neutral}</p>
    <p>Hlasy občanů Grónska: ${fromGL} (${fromGL/total*100 || 0}%)</p>
    <p>Ostatní státy: ${others} (${others/total*100 || 0}%)</p>
  `;
}

/* -------------------------------
   Inicializace
------------------------------- */
loadEvents();
updateAuthUI();

/* -------------------------------
   Mapbox mapa
------------------------------- */
mapboxgl.accessToken = 'pk.eyJ1IjoiaGVyZ290dCIsImEiOiJjbWttdHQ3cmYwZ2hmM2pyMjd2bmk1c3ZmIn0.-9CViuw1h3-gy49EsKvFiQ';
const map = new mapboxgl.Map({
  container: 'map',
  style: 'mapbox://styles/mapbox/light-v11',
  center: [-42, 72],
  zoom: 2
});

map.on('load', () => {
  map.addSource('greenland', {
    type: 'geojson',
    data: 'https://raw.githubusercontent.com/johan/world.geo.json/master/countries/GRL.geo.json'
  });

  map.addLayer({
    id: 'greenland-fill',
    type: 'fill',
    source: 'greenland',
    paint: {
      'fill-color': '#4CAF50',
      'fill-opacity': 0.6
    }
  });

  map.addLayer({
    id: 'greenland-border',
    type: 'line',
    source: 'greenland',
    paint: {
      'line-color': '#2E7D32',
      'line-width': 2
    }
  });
});
</script>

</body>
</html>
