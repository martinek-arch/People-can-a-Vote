<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<title>People can a Vote</title>

<link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet"/>

<style>
  body { margin:0; font-family:Arial, sans-serif; background:#f4f6f8; }
  .wrap { max-width:1100px; margin:0 auto; }

  /* Top nav (sticky) */
  header { background:#fff; box-shadow:0 2px 4px rgba(0,0,0,.1); position:sticky; top:0; z-index:20; }
  .nav { display:flex; align-items:center; justify-content:space-between; gap:12px; padding:12px 16px; }
  .brand { display:flex; flex-direction:column; }
  .brand h1 { margin:0; font-size:18px; }
  .brand .muted { margin:2px 0 0; color:#666; font-size:12px; }

  .nav-left, .nav-right { display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
  button { padding:10px 14px; cursor:pointer; border:0; border-radius:10px; }
  button.primary { background:#111; color:#fff; }
  button.ghost { background:#eee; }
  button:disabled { opacity:.5; cursor:not-allowed; }

  input, select { padding:10px; border-radius:10px; border:1px solid #ddd; background:#fff; }
  input { min-width:260px; }

  .card { background:#fff; padding:16px; border-radius:12px; margin:16px; }
  .muted { color:#666; }
  .pill { background:#f1f1f1; padding:6px 10px; border-radius:999px; font-size:12px; }

  /* Home */
  #map { height:480px; margin:16px; border-radius:12px; overflow:hidden; }
  .topGrid { display:grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap:12px; }
  @media (max-width: 900px) { .topGrid { grid-template-columns: 1fr; } }
  .topCard { border:1px solid #eee; border-radius:12px; padding:14px; cursor:pointer; }
  .topCard:hover { border-color:#ddd; }
  .topCount { font-size:12px; color:#666; margin-top:8px; }

  /* Country list */
  .event { background:#fff; padding:14px; border-radius:12px; margin:10px 16px; cursor:pointer; border:1px solid #eee; }
  .event:hover { border-color:#ddd; }
  .event small { color:#666; display:block; margin-top:6px; }

  /* Event detail */
  .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
  .barWrap { margin:10px 0 14px; }
  .barRow { display:flex; align-items:center; gap:10px; margin:8px 0; }
  .barLabel { width:140px; font-size:14px; }
  .barOuter { flex:1; background:#eee; border-radius:999px; overflow:hidden; height:14px; }
  .barInner { height:100%; width:0%; background:#111; }
  .barValue { width:150px; text-align:right; font-size:13px; color:#333; }

  /* mini map */
  #mini-map-wrap{
    position:absolute;
    right:12px;
    bottom:12px;
    width:240px;
    height:170px;
    border-radius:12px;
    overflow:hidden;
    border:1px solid #eee;
    box-shadow:0 6px 14px rgba(0,0,0,.08);
    background:#fafafa;
  }
  #mini-map{ width:100%; height:100%; }
  #mini-badge{
    position:absolute;
    left:10px;
    top:10px;
    background:rgba(255,255,255,.92);
    border:1px solid #eee;
    padding:6px 10px;
    border-radius:999px;
    font-size:12px;
    color:#333;
  }
  .relative { position:relative; }

  @media (max-width: 700px){
    input{ min-width:180px; }
    #mini-map-wrap{ position:relative; right:auto; bottom:auto; width:100%; height:220px; margin-top:12px; }
  }

  /* Screens */
  .screen { display:none; }
  .screen.active { display:block; }
</style>
</head>

<body>

<header>
  <div class="wrap nav">
    <div class="nav-left">
      <div class="brand">
        <h1>People can a Vote</h1>
        <div class="muted">Global view of opinions from around the world</div>
      </div>

      <button class="ghost" id="homeBtn">Home</button>
      <button class="ghost" id="backBtn" disabled>← Zpět</button>

      <span class="pill" id="crumb">Home</span>
    </div>

    <div class="nav-right">
      <input id="search" type="text" placeholder="Hledej událost…">
      <span class="pill" id="selectedCountryPill">Země: (vše)</span>

      <!-- Auth compact -->
      <span class="pill" id="authPill">Nepřihlášen</span>
      <button class="ghost" id="openAuthBtn">Přihlásit</button>
      <button class="ghost" id="logoutBtn" style="display:none;">Odhlásit</button>
    </div>
  </div>
</header>

<div class="wrap">

  <!-- AUTH MODAL-ish card -->
  <section class="card" id="authCard" style="display:none;">
    <h3 style="margin:0 0 10px 0;">Přihlášení / Registrace</h3>
    <div class="row">
      <input id="email" type="email" placeholder="Email">
      <input id="password" type="password" placeholder="Heslo">
      <select id="countrySelect">
        <option value="">Načítám země…</option>
      </select>
    </div>
    <div class="row" style="margin-top:10px;">
      <button class="primary" id="signupBtn">Registrovat</button>
      <button class="ghost" id="loginBtn">Přihlásit</button>
      <button class="ghost" id="closeAuthBtn">Zavřít</button>
    </div>
    <p id="authError" style="color:#b00020; margin:10px 0 0;"></p>
    <div class="muted" style="margin-top:10px; font-size:13px;">
      Země je povinná jen při registraci. Při přihlášení se ignoruje.
    </div>
  </section>

  <!-- SCREEN: HOME -->
  <section id="screenHome" class="screen active">
    <section class="card">
      <div class="row" style="justify-content:space-between;">
        <div>
          <h3 style="margin:0 0 6px 0;">TOP 3 události (globálně)</h3>
          <div class="muted">Události s největším počtem hlasů.</div>
        </div>
        <button class="ghost" id="refreshTop">Obnovit</button>
      </div>
      <div id="top3" class="topGrid" style="margin-top:12px;">
        <div class="muted">Načítám…</div>
      </div>
    </section>

    <section class="card">
      <div class="row" style="justify-content:space-between;">
        <div>
          <h3 style="margin:0 0 6px 0;">Mapa</h3>
          <div class="muted">Klikni na zemi → uvidíš události pro danou zemi.</div>
        </div>
        <button class="ghost" id="clearCountry">Zrušit výběr</button>
      </div>
      <div id="map"></div>
    </section>
  </section>

  <!-- SCREEN: COUNTRY (list of events only) -->
  <section id="screenCountry" class="screen">
    <section class="card">
      <h2 style="margin:0 0 6px 0;">Události</h2>
      <div class="muted" id="countrySubtitle">Vyber z mapy zemi, nebo použij vyhledávání.</div>
    </section>
    <div id="events"></div>
  </section>

  <!-- SCREEN: EVENT (question + minimap + stats) -->
  <section id="screenEvent" class="screen">
    <section class="card relative" id="eventCard">
      <h2 id="eventTitle" style="margin:0 0 6px 0;">—</h2>
      <div class="muted" id="eventDesc"></div>

      <div id="voteButtons" style="display:none; margin-top:12px;">
        <div class="row">
          <button class="primary" id="voteYes">Ano</button>
          <button class="primary" id="voteNo">Ne</button>
          <button class="primary" id="voteNeutral">Nemám názor</button>
        </div>
      </div>

      <p id="voteMsg" style="margin:12px 0 0;"></p>

      <!-- MINI MAP -->
      <div id="mini-map-wrap">
        <div id="mini-map"></div>
        <div id="mini-badge">Země události: —</div>
      </div>
    </section>

    <section class="card">
      <h3 style="margin:0 0 10px 0;">Statistiky</h3>
      <div id="stats" class="muted">Načítám…</div>
    </section>
  </section>

</div>

<script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<script>
/* ================== KONFIG ================== */
const supabaseClient = supabase.createClient(
  'https://jqoomnhpyuikbntnrukw.supabase.co',
  'sb_publishable_SjZ_HQWN0XRE9ebbf_OwQg_kmJeS43h'
);

mapboxgl.accessToken =
  'pk.eyJ1IjoiaGVyZ290dCIsImEiOiJjbWttdHQ3cmYwZ2hmM2pyMjd2bmk1c3ZmIn0.-9CViuw1h3-gy49EsKvFiQ';

/* ================== STATE ================== */
let screen = "HOME"; // HOME | COUNTRY | EVENT
let selectedCountryCode = ""; // ISO-2
let selectedCountryName = "";
let currentEventId = null;
let currentEventCountryCode = null;
let userCountryCode = null;
let countries = [];

/* ================== UI refs ================== */
const crumb = document.getElementById('crumb');
const homeBtn = document.getElementById('homeBtn');
const backBtn = document.getElementById('backBtn');
const selectedCountryPill = document.getElementById('selectedCountryPill');

const screenHome = document.getElementById('screenHome');
const screenCountry = document.getElementById('screenCountry');
const screenEvent = document.getElementById('screenEvent');

const top3Div = document.getElementById('top3');
const refreshTop = document.getElementById('refreshTop');
const clearCountry = document.getElementById('clearCountry');

const eventsDiv = document.getElementById('events');
const countrySubtitle = document.getElementById('countrySubtitle');

const eventTitle = document.getElementById('eventTitle');
const eventDesc = document.getElementById('eventDesc');
const voteButtons = document.getElementById('voteButtons');
const voteMsg = document.getElementById('voteMsg');
const stats = document.getElementById('stats');
const miniBadge = document.getElementById('mini-badge');

const search = document.getElementById('search');

const authCard = document.getElementById('authCard');
const openAuthBtn = document.getElementById('openAuthBtn');
const closeAuthBtn = document.getElementById('closeAuthBtn');
const logoutBtn = document.getElementById('logoutBtn');
const authPill = document.getElementById('authPill');

const email = document.getElementById('email');
const password = document.getElementById('password');
const countrySelect = document.getElementById('countrySelect');
const authError = document.getElementById('authError');

const loginBtn = document.getElementById('loginBtn');
const signupBtn = document.getElementById('signupBtn');

/* ================== Helpers ================== */
function showScreen(next){
  screen = next;
  screenHome.classList.toggle('active', next === "HOME");
  screenCountry.classList.toggle('active', next === "COUNTRY");
  screenEvent.classList.toggle('active', next === "EVENT");

  // Back button logic
  backBtn.disabled = (next === "HOME");
  if (next === "HOME") crumb.textContent = "Home";
  if (next === "COUNTRY") crumb.textContent = selectedCountryCode ? `Země: ${selectedCountryName} (${selectedCountryCode})` : "Události";
  if (next === "EVENT") crumb.textContent = "Událost";
}

function setCountryPill(){
  selectedCountryPill.textContent = selectedCountryCode ? `Země: ${selectedCountryName} (${selectedCountryCode})` : "Země: (vše)";
}

function getCountryNameByCode(code){
  const c = countries.find(x => x.code === code);
  return c ? c.name : code;
}

function safePct(part, total){ return total ? Math.round((part/total)*100) : 0; }

function barHTML(label, count, total) {
  const pct = safePct(count, total);
  return `
    <div class="barRow">
      <div class="barLabel">${label}</div>
      <div class="barOuter"><div class="barInner" style="width:${pct}%;"></div></div>
      <div class="barValue">${count} (${pct}%)</div>
    </div>
  `;
}

/* ================== Navigation buttons ================== */
homeBtn.onclick = () => goHome();
backBtn.onclick = () => goBack();

function goHome(){
  currentEventId = null;
  showScreen("HOME");
}

function goBack(){
  if (screen === "EVENT") {
    showScreen("COUNTRY");
  } else if (screen === "COUNTRY") {
    showScreen("HOME");
  }
}

/* ================== Auth UI ================== */
openAuthBtn.onclick = () => { authCard.style.display = "block"; };
closeAuthBtn.onclick = () => { authCard.style.display = "none"; };
logoutBtn.onclick = async () => { await supabaseClient.auth.signOut(); };

loginBtn.onclick = async () => {
  authError.textContent = "";
  const { error } = await supabaseClient.auth.signInWithPassword({ email: email.value, password: password.value });
  if (error) authError.textContent = error.message;
};

signupBtn.onclick = async () => {
  authError.textContent = "";
  const cc = countrySelect.value;
  if (!cc) { authError.textContent = "Vyber zemi při registraci."; return; }

  const { error: e1 } = await supabaseClient.auth.signUp({ email: email.value, password: password.value });
  if (e1) { authError.textContent = e1.message; return; }

  const { error: e2 } = await supabaseClient.auth.signInWithPassword({ email: email.value, password: password.value });
  if (e2) { authError.textContent = e2.message; return; }

  const { data: sess } = await supabaseClient.auth.getSession();
  const user = sess.session?.user;
  if (!user) return;

  const { error: e3 } = await supabaseClient.from('profiles').insert([{ id: user.id, country_code: cc }]);
  if (e3 && e3.code !== '23505') authError.textContent = e3.message;
};

supabaseClient.auth.onAuthStateChange(async () => {
  await refreshAuthPill();
  if (screen === "EVENT" && currentEventId) await refreshEventDetail(currentEventId);
});

async function refreshAuthPill(){
  const { data } = await supabaseClient.auth.getSession();
  const user = data.session?.user;

  if (!user){
    authPill.textContent = "Nepřihlášen";
    openAuthBtn.style.display = "inline-block";
    logoutBtn.style.display = "none";
    userCountryCode = null;
    return;
  }

  openAuthBtn.style.display = "none";
  logoutBtn.style.display = "inline-block";

  const { data: prof } = await supabaseClient
    .from('profiles')
    .select('country_code')
    .eq('id', user.id)
    .maybeSingle();

  userCountryCode = prof?.country_code || null;
  authPill.textContent = userCountryCode ? `Přihlášen • ${userCountryCode}` : `Přihlášen`;
}

/* ================== Countries ================== */
async function loadCountries(){
  const { data, error } = await supabaseClient.from('countries').select('code,name').order('name', { ascending: true });
  if (error) return;
  countries = data || [];

  // for registration select
  countrySelect.innerHTML = ['<option value="">Vyber zemi (pro registraci)</option>']
    .concat(countries.map(c => `<option value="${c.code}">${c.name} (${c.code})</option>`)).join('');
}

/* ================== HOME: Top 3 ================== */
async function loadTop3(){
  top3Div.innerHTML = '<div class="muted">Načítám…</div>';

  const { data: votes, error: vErr } = await supabaseClient.from('votes').select('event_id');
  if (vErr) { top3Div.innerHTML = '<div class="muted">Nelze načíst TOP.</div>'; return; }

  const counts = new Map();
  for (const v of (votes || [])) counts.set(v.event_id, (counts.get(v.event_id) || 0) + 1);

  if (counts.size === 0) { top3Div.innerHTML = '<div class="muted">Zatím žádné hlasy.</div>'; return; }

  const top = [...counts.entries()].sort((a,b) => b[1] - a[1]).slice(0, 3);
  const ids = top.map(t => t[0]);

  const { data: evs, error: eErr } = await supabaseClient.from('events')
    .select('id,title,description,country_code,is_active')
    .in('id', ids);

  if (eErr) { top3Div.innerHTML = '<div class="muted">Nelze načíst TOP detail.</div>'; return; }

  const byId = new Map((evs||[]).map(e => [e.id, e]));
  const cards = [];

  for (const [id, cnt] of top){
    const e = byId.get(id);
    if (!e) continue;
    cards.push(`
      <div class="topCard" data-id="${e.id}">
        <strong>${e.title}</strong>
        <div class="muted" style="margin-top:6px;">${e.description || ""}</div>
        <div class="topCount">Hlasů: <strong>${cnt}</strong> • Země: ${e.country_code || "?"}</div>
      </div>
    `);
  }

  top3Div.innerHTML = cards.join('');

  for (const el of top3Div.querySelectorAll('.topCard')){
    el.addEventListener('click', async () => {
      const id = Number(el.getAttribute('data-id'));
      await openEvent(id);
    });
  }
}
refreshTop.onclick = loadTop3;

/* ================== COUNTRY: Events list ================== */
async function loadEvents(){
  eventsDiv.innerHTML = "";

  let q = supabaseClient
    .from('events')
    .select('id,title,description,country_code,created_at')
    .eq('is_active', true);

  if (selectedCountryCode) q = q.eq('country_code', selectedCountryCode);

  // search: filter by title/description (client-side for MVP)
  const { data, error } = await q.order('created_at', { ascending: false });
  if (error) { eventsDiv.innerHTML = '<div class="muted" style="margin:0 16px;">Nelze načíst události.</div>'; return; }

  let list = data || [];
  const term = (search.value || "").trim().toLowerCase();
  if (term) {
    list = list.filter(e =>
      (e.title || "").toLowerCase().includes(term) ||
      (e.description || "").toLowerCase().includes(term)
    );
  }

  if (!list.length){
    eventsDiv.innerHTML = '<div class="muted" style="margin:0 16px;">Žádné události pro tento výběr / hledání.</div>';
    return;
  }

  for (const e of list){
    const div = document.createElement('div');
    div.className = 'event';
    div.innerHTML = `<strong>${e.title}</strong><small>${e.description || ""}</small>`;
    div.onclick = async () => { await openEvent(e.id); };
    eventsDiv.appendChild(div);
  }
}

search.addEventListener('input', async () => {
  if (screen === "COUNTRY") await loadEvents();
});

/* ================== EVENT: Detail ================== */
async function openEvent(eventId){
  // načti event
  const { data: evt, error } = await supabaseClient
    .from('events')
    .select('id,title,description,country_code,is_active')
    .eq('id', eventId)
    .maybeSingle();

  if (error || !evt) return;

  currentEventId = evt.id;
  currentEventCountryCode = evt.country_code || "";

  // nastav country kontext (aby dávalo smysl, odkud se na událost přišlo)
  selectedCountryCode = currentEventCountryCode || selectedCountryCode;
  selectedCountryName = selectedCountryCode ? getCountryNameByCode(selectedCountryCode) : "";
  setCountryPill();

  // přepni screen
  showScreen("EVENT");

  // vykresli detail
  await refreshEventDetail(eventId);

  // zjemnění: zavřít auth card, pokud je otevřená
  authCard.style.display = "none";
}

async function refreshEventDetail(eventId){
  voteButtons.style.display = "none";
  voteMsg.textContent = "";
  stats.textContent = "Načítám…";

  const { data: evt, error } = await supabaseClient
    .from('events')
    .select('id,title,description,country_code')
    .eq('id', eventId)
    .maybeSingle();

  if (error || !evt) return;

  currentEventCountryCode = evt.country_code || "";
  eventTitle.textContent = evt.title || "—";
  eventDesc.textContent = evt.description || "";

  // mini map update
  miniBadge.textContent = currentEventCountryCode ? `Země události: ${currentEventCountryCode}` : "Země události: —";
  updateMiniMapSelected(currentEventCountryCode || "");

  // stats
  await loadStats(eventId, currentEventCountryCode);

  // vote availability
  const { data: sess } = await supabaseClient.auth.getSession();
  const user = sess.session?.user;

  if (!user){
    voteMsg.textContent = "Pro hlasování se přihlas.";
    return;
  }

  if (!userCountryCode) await refreshAuthPill();

  const { data: existing } = await supabaseClient
    .from('votes')
    .select('vote')
    .eq('user_id', user.id)
    .eq('event_id', eventId)
    .maybeSingle();

  if (existing){
    voteMsg.textContent = `Už jste hlasoval (${existing.vote}).`;
    voteButtons.style.display = "none";
  } else {
    voteButtons.style.display = "block";
  }
}

document.getElementById('voteYes').onclick = () => submitVote("Ano");
document.getElementById('voteNo').onclick = () => submitVote("Ne");
document.getElementById('voteNeutral').onclick = () => submitVote("Nemám názor");

async function submitVote(value){
  voteMsg.textContent = "";

  const { data: sess } = await supabaseClient.auth.getSession();
  const user = sess.session?.user;
  if (!user){ voteMsg.textContent = "Musíš být přihlášen."; return; }

  if (!userCountryCode) await refreshAuthPill();
  if (!userCountryCode){ voteMsg.textContent = "Nemáš nastavenou zemi v profilu."; return; }

  const { error } = await supabaseClient.from('votes').insert({
    user_id: user.id,
    event_id: currentEventId,
    vote: value,
    country_code: userCountryCode
  });

  if (error){
    if (error.code === "23505"){
      voteMsg.textContent = "Už jste hlasoval pro tuto událost.";
      voteButtons.style.display = "none";
    } else {
      voteMsg.textContent = error.message;
    }
    return;
  }

  voteButtons.style.display = "none";
  voteMsg.textContent = "Hlas uložen.";
  await loadTop3(); // může změnit pořadí
  await refreshEventDetail(currentEventId);
}

/* ================== Stats ================== */
async function loadStats(eventId, eventCountryCode){
  const { data, error } = await supabaseClient
    .from('votes')
    .select('vote,country_code')
    .eq('event_id', eventId);

  if (error){ stats.textContent = "Nelze načíst statistiky."; return; }

  const total = (data||[]).length;

  const yes = (data||[]).filter(v => v.vote === 'Ano').length;
  const no = (data||[]).filter(v => v.vote === 'Ne').length;
  const neutral = (data||[]).filter(v => v.vote === 'Nemám názor').length;

  const citizens = eventCountryCode ? (data||[]).filter(v => v.country_code === eventCountryCode) : [];
  const others = eventCountryCode ? (data||[]).filter(v => v.country_code !== eventCountryCode) : (data||[]);

  const cTotal = citizens.length, oTotal = others.length;

  const cYes = citizens.filter(v => v.vote === 'Ano').length;
  const cNo = citizens.filter(v => v.vote === 'Ne').length;
  const cNeutral = citizens.filter(v => v.vote === 'Nemám názor').length;

  const oYes = others.filter(v => v.vote === 'Ano').length;
  const oNo = others.filter(v => v.vote === 'Ne').length;
  const oNeutral = others.filter(v => v.vote === 'Nemám názor').length;

  stats.innerHTML = `
    <div><strong>Celkem:</strong> ${total} hlasů</div>
    <div class="barWrap">
      ${barHTML('Ano', yes, total)}
      ${barHTML('Ne', no, total)}
      ${barHTML('Nemám názor', neutral, total)}
    </div>

    <div style="margin-top:10px;"><strong>Občané země události</strong> ${eventCountryCode ? `(${eventCountryCode})` : ''}: ${cTotal} hlasů</div>
    <div class="barWrap">
      ${barHTML('Ano', cYes, cTotal)}
      ${barHTML('Ne', cNo, cTotal)}
      ${barHTML('Nemám názor', cNeutral, cTotal)}
    </div>

    <div style="margin-top:10px;"><strong>Ostatní státy:</strong> ${oTotal} hlasů</div>
    <div class="barWrap">
      ${barHTML('Ano', oYes, oTotal)}
      ${barHTML('Ne', oNo, oTotal)}
      ${barHTML('Nemám názor', oNeutral, oTotal)}
    </div>
  `;
}

/* ================== HOME: Map (select country) ================== */
clearCountry.onclick = () => {
  selectedCountryCode = "";
  selectedCountryName = "";
  setCountryPill();
  // zůstáváme na home, jen zrušíme highlight
  setBigMapSelected("");
};

let map, miniMap;

function selectCountry(code){
  selectedCountryCode = code || "";
  selectedCountryName = selectedCountryCode ? getCountryNameByCode(selectedCountryCode) : "";
  setCountryPill();
  countrySubtitle.textContent = selectedCountryCode
    ? `Vybraná země: ${selectedCountryName} (${selectedCountryCode})`
    : "Vyber z mapy zemi, nebo použij vyhledávání.";

  showScreen("COUNTRY");
  loadEvents();
}

function setBigMapSelected(code){
  if (!map || !map.getLayer('country-selected')) return;
  map.setFilter('country-selected', ['==', ['get', 'iso_3166_1'], code || '']);
}

function updateMiniMapSelected(countryCode){
  if (!miniMap || !miniMap.getLayer('mini-country-selected')) return;
  miniMap.setFilter('mini-country-selected', ['==', ['get', 'iso_3166_1'], countryCode || '']);

  if (!countryCode) return;
  const feats = miniMap.querySourceFeatures('miniCountryBoundaries', {
    sourceLayer: 'country_boundaries',
    filter: ['==', ['get', 'iso_3166_1'], countryCode]
  });
  if (!feats || !feats.length) return;

  // bbox
  let minX=180, minY=90, maxX=-180, maxY=-90;
  const geom = feats[0].geometry;
  function scan(coords){
    if (typeof coords[0] === 'number'){
      const x=coords[0], y=coords[1];
      minX=Math.min(minX,x); maxX=Math.max(maxX,x);
      minY=Math.min(minY,y); maxY=Math.max(maxY,y);
      return;
    }
    for (const c of coords) scan(c);
  }
  scan(geom.coordinates);
  miniMap.fitBounds([[minX,minY],[maxX,maxY]], { padding:18, duration:300 });
}

/* Big map init */
function initMaps(){
  map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/light-v11',
    center: [10, 20],
    zoom: 1.2
  });

  map.on('load', () => {
    map.addSource('countryBoundaries', { type:'vector', url:'mapbox://mapbox.country-boundaries-v1' });

    map.addLayer({
      id: 'country-fill',
      type: 'fill',
      source: 'countryBoundaries',
      'source-layer': 'country_boundaries',
      paint: { 'fill-color': '#000', 'fill-opacity': 0.05 }
    });

    map.addLayer({
      id: 'country-selected',
      type: 'fill',
      source: 'countryBoundaries',
      'source-layer': 'country_boundaries',
      paint: { 'fill-color': '#000', 'fill-opacity': 0.18 },
      filter: ['==', ['get', 'iso_3166_1'], '']
    });

    let hoveredISO = "";
    map.addLayer({
      id: 'country-hover',
      type: 'fill',
      source: 'countryBoundaries',
      'source-layer': 'country_boundaries',
      paint: { 'fill-color': '#000', 'fill-opacity': 0.12 },
      filter: ['==', ['get', 'iso_3166_1'], '']
    });

    map.on('mousemove','country-fill',(e)=>{
      const iso = e.features?.[0]?.properties?.iso_3166_1 || "";
      if (iso !== hoveredISO){
        hoveredISO = iso;
        map.setFilter('country-hover', ['==', ['get', 'iso_3166_1'], hoveredISO]);
      }
      map.getCanvas().style.cursor='pointer';
    });

    map.on('mouseleave','country-fill',()=>{
      hoveredISO="";
      map.setFilter('country-hover', ['==', ['get', 'iso_3166_1'], '']);
      map.getCanvas().style.cursor='';
    });

    map.on('click','country-fill',(e)=>{
      const iso = e.features?.[0]?.properties?.iso_3166_1 || "";
      if (!iso) return;
      setBigMapSelected(iso);
      selectCountry(iso);
    });
  });

  // mini map
  miniMap = new mapboxgl.Map({
    container: 'mini-map',
    style: 'mapbox://styles/mapbox/light-v11',
    center: [10,20],
    zoom: 0.6,
    interactive: false
  });

  miniMap.on('load', () => {
    miniMap.addSource('miniCountryBoundaries', { type:'vector', url:'mapbox://mapbox.country-boundaries-v1' });

    miniMap.addLayer({
      id: 'mini-country-fill',
      type: 'fill',
      source: 'miniCountryBoundaries',
      'source-layer': 'country_boundaries',
      paint: { 'fill-color': '#000', 'fill-opacity': 0.05 }
    });

    miniMap.addLayer({
      id: 'mini-country-selected',
      type: 'fill',
      source: 'miniCountryBoundaries',
      'source-layer': 'country_boundaries',
      paint: { 'fill-color': '#000', 'fill-opacity': 0.25 },
      filter: ['==', ['get', 'iso_3166_1'], '']
    });

    miniMap.addLayer({
      id: 'mini-country-line',
      type: 'line',
      source: 'miniCountryBoundaries',
      'source-layer': 'country_boundaries',
      paint: { 'line-color': '#000', 'line-width': 1, 'line-opacity': 0.2 }
    });
  });
}

/* ================== INIT ================== */
(async function init(){
  await loadCountries();
  await refreshAuthPill();
  setCountryPill();
  initMaps();
  await loadTop3();
})();
</script>

</body>
</html>
