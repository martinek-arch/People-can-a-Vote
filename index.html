<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>People can a Vote</title>

<link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet"/>

<style>
  body { margin:0; font-family: Arial, sans-serif; background:#f4f6f8; }
  .wrap { max-width:1100px; margin:0 auto; }
  header { background:#fff; box-shadow:0 2px 4px rgba(0,0,0,.08); position:sticky; top:0; z-index:30; }
  .nav { display:flex; align-items:center; justify-content:space-between; gap:12px; padding:12px 16px; }
  .nav-left, .nav-right { display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
  .brand { display:flex; flex-direction:column; }
  .brand h1 { margin:0; font-size:18px; }
  .brand .muted { margin:2px 0 0; font-size:12px; color:#666; }

  button { padding:8px 12px; border:0; border-radius:10px; cursor:pointer; }
  button.ghost { background:#eee; }
  button.primary { background:#111; color:#fff; }
  button:disabled { opacity:.5; cursor:not-allowed; }

  input { padding:9px 10px; border-radius:10px; border:1px solid #ddd; min-width:260px; }
  .pill { background:#f1f1f1; padding:6px 10px; border-radius:999px; font-size:12px; color:#333; }
  .card { background:#fff; padding:16px; border-radius:12px; margin:16px; }
  .muted { color:#666; }
  .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }

  /* Continent bar */
  #continentsBarWrap { padding:6px 16px; }
  #continentsBar {
    display:flex; gap:8px; flex-wrap:wrap; align-items:center;
    background:#fff; border:1px solid #eee; border-radius:12px; padding:8px 10px;
  }
  #continentsBar button { padding:6px 10px; font-size:13px; }

  /* Search suggest */
  .searchWrap { position:relative; }
  #searchSuggest{
    position:absolute; top:42px; left:0; right:0;
    background:#fff; border:1px solid #ddd; border-radius:12px;
    display:none; max-height:320px; overflow:auto;
    box-shadow:0 10px 25px rgba(0,0,0,.12);
    z-index:50;
  }
  .sItem { padding:10px 12px; cursor:pointer; border-top:1px solid #f1f1f1; display:flex; justify-content:space-between; gap:10px; }
  .sItem:first-child{ border-top:none; }
  .sItem:hover{ background:#f6f6f6; }
  .sLeft { display:flex; flex-direction:column; gap:2px; }
  .sTitle { font-weight:600; }
  .sSub { font-size:12px; color:#666; }
  .tag { font-size:11px; color:#555; background:#f1f1f1; padding:4px 8px; border-radius:999px; white-space:nowrap; align-self:flex-start; }


  .countryChip{
    padding:6px 10px;
    border-radius:999px;
    border:1px solid #e6e6e6;
    background:#fafafa;
    cursor:pointer;
    font-size:13px;
  }
  .countryChip:hover{ border-color:#cfcfcf; background:#f3f3f3; }
  .countryChip.active{ background:#e9e9e9; border-color:#bdbdbd; }


  /* Screens */
  .screen { display:none; }
  .screen.active { display:block; }

  #map { height:460px; border-radius:12px; overflow:hidden; }

  .eventItem { background:#fff; border:1px solid #eee; border-radius:12px; padding:14px; margin:10px 16px; cursor:pointer; }
  .eventItem:hover { border-color:#ddd; }
  .eventItem small { display:block; color:#666; margin-top:6px; }

  .titleRow { display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
  .backInline { padding:8px 12px; border-radius:10px; background:#eee; }

  @media (max-width: 700px){
    input{ min-width:180px; }
  }
</style>
</head>

<body>

<header>
  <div class="wrap nav">
    <div class="nav-left">
      <div class="brand">
        <h1>People can a Vote</h1>
        <div class="muted">Global view of opinions from around the world</div>
      </div>
      <button class="ghost" id="homeBtn">Home</button>
    </div>

    <div class="nav-right">
      <div class="searchWrap">
        <input id="search" placeholder="Search country or event‚Ä¶" autocomplete="off" />
        <div id="searchSuggest"></div>
      </div>

      <span class="pill" id="selectedCountryPill">Country: (all)</span>
      <span class="pill" id="selectedContinentPill">Continent: All</span>
    </div>
  </div>
</header>

<div class="wrap" id="continentsBarWrap">
  <div id="continentsBar">
    <button class="ghost" data-cont="ALL">üåç All</button>
    <button class="ghost" data-cont="Europe">Europe</button>
    <button class="ghost" data-cont="Asia">Asia</button>
    <button class="ghost" data-cont="Africa">Africa</button>
    <button class="ghost" data-cont="North America">North America</button>
    <button class="ghost" data-cont="South America">South America</button>
    <button class="ghost" data-cont="Oceania">Oceania</button>
  </div>
</div>

<div class="wrap" id="continentCountriesWrap" style="padding:0 16px 10px 16px; display:none;">
  <div style="background:#fff;border:1px solid #eee;border-radius:12px;padding:10px 12px;">
    <div class="row" style="justify-content:space-between;">
      <div>
        <strong id="continentCountriesTitle">Countries</strong>
        <div class="muted" id="continentCountriesSub" style="margin-top:2px;font-size:12px;">Pick a country to see events.</div>
      </div>
      <button class="ghost" id="hideCountriesBtn" style="padding:6px 10px;">Hide</button>
    </div>
    <div id="continentCountriesList" style="margin-top:10px; display:flex; flex-wrap:wrap; gap:8px;"></div>
  </div>
</div>

<div class="wrap">

  <!-- HOME -->
  <section id="screenHome" class="screen active">
    <section class="card">
      <div class="row" style="justify-content:space-between;">
        <div>
          <h3 style="margin:0 0 6px 0;">Map</h3>
          <div class="muted">Click a country to see its events. Or use search.</div>
        </div>
        <button class="ghost" id="clearCountryBtn">Clear country</button>
      </div>
      <div id="map" style="margin-top:12px;"></div>
    </section>
  </section>

  <!-- COUNTRY -->
  <section id="screenCountry" class="screen">
    <section class="card">
      <div class="titleRow">
        <button class="backInline" id="backFromCountry">‚Üê Back</button>
        <h2 id="countryTitle" style="margin:0;">Events</h2>
      </div>
      <div class="muted" id="countrySubtitle" style="margin-top:8px;"></div>
    </section>
    <div id="eventsList"></div>
  </section>

  <!-- EVENT -->
  <section id="screenEvent" class="screen">
    <section class="card">
      <div class="titleRow">
        <button class="backInline" id="backFromEvent">‚Üê Back</button>
        <h2 id="eventTitle" style="margin:0;">‚Äî</h2>
      </div>
      <div class="muted" id="eventMeta" style="margin-top:8px;"></div>
      <div id="eventDesc" style="margin-top:12px; white-space:pre-wrap;"></div>
    </section>

    <section class="card">
      <div class="muted">Voting and statistics will be added next.</div>
    </section>
  </section>

</div>

<script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<script>
/* ================== CONFIG ================== */
const supabaseClient = supabase.createClient(
  "https://jqoomnhpyuikbntnrukw.supabase.co",
  "sb_publishable_SjZ_HQWN0XRE9ebbf_OwQg_kmJeS43h"
);

mapboxgl.accessToken = "pk.eyJ1IjoiaGVyZ290dCIsImEiOiJjbWttdHQ3cmYwZ2hmM2pyMjd2bmk1c3ZmIn0.-9CViuw1h3-gy49EsKvFiQ";

/* ================== STATE ================== */
let continentsById = {};   // {id: name}
let countries = [];        // [{code,name,continent_id,continent_name}]
let countriesByCode = {};  // { "US": {...} }
let eventsCache = [];      // active events for search [{id,title,description,country_code}]
let selectedContinent = "ALL";
let selectedCountryCode = "";
let selectedCountryName = "";
let currentEventId = null;

let map;

/* ================== Helpers ================== */
function escapeHtml(s){
  return (s||"").toString()
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;");
}
function norm(s){
  return (s||"").toString().toLowerCase()
    .normalize("NFD").replace(/[\u0300-\u036f]/g,"").trim();
}
function countriesForSearch(){
  if (selectedContinent === "ALL") return countries;
  return countries.filter(c => (c.continent_name || "") === selectedContinent);
}
function continentOfCountry(code){
  return countriesByCode[code]?.continent_name || "";
}
function eventsForSearch(){
  if (selectedContinent === "ALL") return eventsCache;
  return eventsCache.filter(e => continentOfCountry(e.country_code) === selectedContinent);
}

/* ================== UI refs ================== */
const screenHome = document.getElementById("screenHome");
const screenCountry = document.getElementById("screenCountry");
const screenEvent = document.getElementById("screenEvent");

const selectedCountryPill = document.getElementById("selectedCountryPill");
const selectedContinentPill = document.getElementById("selectedContinentPill");

const continentsBar = document.getElementById("continentsBar");

const searchInput = document.getElementById("search");
const suggestBox = document.getElementById("searchSuggest");

const countryTitle = document.getElementById("countryTitle");
const countrySubtitle = document.getElementById("countrySubtitle");
const eventsList = document.getElementById("eventsList");

const eventTitle = document.getElementById("eventTitle");
const eventMeta = document.getElementById("eventMeta");
const eventDesc = document.getElementById("eventDesc");


/* ================== Continent countries UI ================== */
const continentCountriesWrap = document.getElementById("continentCountriesWrap");
const continentCountriesTitle = document.getElementById("continentCountriesTitle");
const continentCountriesSub = document.getElementById("continentCountriesSub");
const continentCountriesList = document.getElementById("continentCountriesList");
const hideCountriesBtn = document.getElementById("hideCountriesBtn");

hideCountriesBtn.onclick = () => {
  continentCountriesWrap.style.display = "none";
};

/* Rough map bounds per continent (lng/lat). We can refine later. */
const CONTINENT_BOUNDS = {
  "Europe": [[-25, 34], [45, 72]],
  "Asia": [[25, -10], [180, 80]],
  "Africa": [[-25, -40], [60, 38]],
  "North America": [[-170, 7], [-50, 83]],
  "South America": [[-92, -56], [-30, 13]],
  "Oceania": [[110, -50], [180, 5]],
};

function renderContinentCountries(){
  // Only show this panel when a specific continent is selected
  if (selectedContinent === "ALL"){
    continentCountriesWrap.style.display = "none";
    continentCountriesList.innerHTML = "";
    return;
  }

  continentCountriesWrap.style.display = "block";

  // If a country is selected, collapse to a single chip + back button (more room for events)
  if (selectedCountryCode){
    const c = countriesByCode[selectedCountryCode];
    const label = c ? `${c.name} (${c.code})` : selectedCountryCode;

    continentCountriesTitle.textContent = `Selected country`;
    continentCountriesSub.textContent = `Click back to choose another country in ${selectedContinent}.`;

    // two-column layout: left selected country chip, right back button
    continentCountriesList.innerHTML = `
      <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;width:100%;">
        <button class="countryChip active" data-cc="${escapeHtml(selectedCountryCode)}" style="cursor:default;">${escapeHtml(label)}</button>
        <button class="ghost" id="continentBackBtn" style="padding:6px 10px;">‚Üê Back</button>
      </div>
    `;

    const backBtn = document.getElementById("continentBackBtn");
    if (backBtn){
      backBtn.onclick = async () => {
        // clear current selection but keep continent
        selectedCountryCode = "";
        selectedCountryName = "";
        setCountryPill();
        setBigMapSelected("");
        // go back to country list + home (so user can pick again)
        showScreen("HOME");
        renderContinentCountries();
      };
    }
    return;
  }

  // Otherwise render all countries for this continent
  const list = countriesForSearch().slice().sort((a,b)=>a.name.localeCompare(b.name));
  continentCountriesTitle.textContent = `Countries in ${selectedContinent}`;
  continentCountriesSub.textContent = `Found: ${list.length}. Click a country to see its events.`;

  continentCountriesList.innerHTML = list.map(c => {
    return `<button class="countryChip" data-cc="${escapeHtml(c.code)}">${escapeHtml(c.name)} (${escapeHtml(c.code)})</button>`;
  }).join("");

  for (const btn of continentCountriesList.querySelectorAll("button[data-cc]")){
    btn.addEventListener("click", async () => {
      const cc = btn.getAttribute("data-cc");
      await selectCountry(cc);
      // collapse to selected view
      renderContinentCountries();
    });
  }
}

let pendingContinentView = "ALL";
function applyContinentView(){
  // Called when continent changes; zoom map if available.
  const c = selectedContinent;
  pendingContinentView = c;

  if (!map) return;

  if (c === "ALL"){
    map.easeTo({ center:[10,20], zoom:1.2, duration:450 });
    return;
  }

  const b = CONTINENT_BOUNDS[c];
  if (b){
    map.fitBounds(b, { padding: 30, duration: 450 });
  }
}


/* ================== Navigation ================== */
function showScreen(name){
  screenHome.classList.toggle("active", name === "HOME");
  screenCountry.classList.toggle("active", name === "COUNTRY");
  screenEvent.classList.toggle("active", name === "EVENT");
  if (name === "HOME" && map) setTimeout(() => map.resize(), 0);
}
document.getElementById("homeBtn").onclick = () => {
  currentEventId = null;
  hideSuggest();
  showScreen("HOME");
};
document.getElementById("backFromCountry").onclick = () => {
  hideSuggest();
  showScreen("HOME");
};
document.getElementById("backFromEvent").onclick = () => {
  hideSuggest();
  showScreen("COUNTRY");
};
document.getElementById("clearCountryBtn").onclick = () => {
  selectedCountryCode = "";
  selectedCountryName = "";
  setCountryPill();
  setBigMapSelected("");
  renderContinentCountries();
};

/* ================== Pills ================== */
function setCountryPill(){
  selectedCountryPill.textContent = selectedCountryCode
    ? `Country: ${selectedCountryName} (${selectedCountryCode})`
    : "Country: (all)";
}
function setContinentPill(){
  selectedContinentPill.textContent = `Continent: ${selectedContinent === "ALL" ? "All" : selectedContinent}`;
}

/* ================== Continents bar ================== */
(function bindContinentBar(){
  continentsBar.addEventListener("click", (e) => {
    const btn = e.target.closest("button[data-cont]");
    if (!btn) return;

    selectedContinent = btn.getAttribute("data-cont") || "ALL";
    setContinentPill();

    // visual active
    for (const b of continentsBar.querySelectorAll("button[data-cont]")){
      const active = (b === btn);
      b.style.border = active ? "1px solid #bbb" : "0";
      b.style.background = active ? "#ddd" : "#eee";
    }

    // reset country selection when continent changes
    selectedCountryCode = "";
    selectedCountryName = "";
    setCountryPill();
    setBigMapSelected("");

    hideSuggest();
    showScreen("HOME");

    // show list of countries under the continent bar and zoom map
    renderContinentCountries();
    applyContinentView();
  });
})();

/* ================== Search suggest ================== */
function hideSuggest(){
  suggestBox.style.display = "none";
  suggestBox.innerHTML = "";
}
document.addEventListener("click", (e) => {
  if (!e.target.closest(".searchWrap")) hideSuggest();
});

searchInput.addEventListener("input", () => buildSuggest(searchInput.value));
searchInput.addEventListener("focus", () => buildSuggest(searchInput.value));

function buildSuggest(raw){
  const term = norm(raw);
  if (term.length < 2){ hideSuggest(); return; }

  const cMatches = countriesForSearch()
    .filter(c => norm(c.name).includes(term) || norm(c.code).startsWith(term))
    .slice(0, 6)
    .map(c => ({
      type: "country",
      key: c.code,
      title: `${c.name} (${c.code})`,
      sub: c.continent_name || ""
    }));

  const eMatches = eventsForSearch()
    .filter(e => norm(e.title).includes(term) || norm(e.description).includes(term))
    .slice(0, 6)
    .map(e => ({
      type: "event",
      key: String(e.id),
      title: e.title || "(no title)",
      sub: e.country_code ? `${e.country_code} ‚Ä¢ ${countriesByCode[e.country_code]?.name || ""}` : ""
    }));

  const merged = [...cMatches, ...eMatches].slice(0, 10);
  if (!merged.length){ hideSuggest(); return; }

  suggestBox.innerHTML = merged.map(item => `
    <div class="sItem" data-type="${item.type}" data-key="${escapeHtml(item.key)}">
      <div class="sLeft">
        <div class="sTitle">${escapeHtml(item.title)}</div>
        <div class="sSub">${escapeHtml(item.sub)}</div>
      </div>
      <div class="tag">${item.type === "country" ? "Country" : "Event"}</div>
    </div>
  `).join("");

  suggestBox.style.display = "block";

  for (const el of suggestBox.querySelectorAll(".sItem")){
    el.addEventListener("click", async () => {
      const type = el.getAttribute("data-type");
      const key = el.getAttribute("data-key");
      hideSuggest();
      searchInput.value = "";

      if (type === "country") {
        await selectCountry(key);
        renderContinentCountries();
      } else {
        await openEvent(Number(key));
      }
    });
  }
}

/* ================== Country selection + events list ================== */
async function selectCountry(code){
  selectedCountryCode = code || "";
  selectedCountryName = countriesByCode[selectedCountryCode]?.name || selectedCountryCode;
  setCountryPill();
  setBigMapSelected(selectedCountryCode);

  countryTitle.textContent = `Events`;
  countrySubtitle.textContent = selectedCountryCode
    ? `${selectedCountryName} (${selectedCountryCode})`
    : "Select a country.";

  showScreen("COUNTRY");
  await loadEventsForCountry(selectedCountryCode);
}

async function loadEventsForCountry(code){
  eventsList.innerHTML = `<div class="muted" style="margin:0 16px;">Loading‚Ä¶</div>`;

  if (!code){
    eventsList.innerHTML = `<div class="muted" style="margin:0 16px;">No country selected.</div>`;
    return;
  }

  const { data, error } = await supabaseClient
    .from("events")
    .select("id,title,description,country_code,created_at,is_active")
    .eq("is_active", true)
    .eq("country_code", code)
    .order("created_at", { ascending:false });

  if (error){
    console.error("loadEventsForCountry error:", error);
    eventsList.innerHTML = `<div class="muted" style="margin:0 16px;">Cannot load events.</div>`;
    return;
  }

  const list = data || [];
  if (!list.length){
    eventsList.innerHTML = `<div class="muted" style="margin:0 16px;">No events for this country yet.</div>`;
    return;
  }

  eventsList.innerHTML = "";
  for (const e of list){
    const div = document.createElement("div");
    div.className = "eventItem";
    div.innerHTML = `<strong>${escapeHtml(e.title||"")}</strong><small>${escapeHtml(e.description||"")}</small>`;
    div.onclick = async () => openEvent(e.id);
    eventsList.appendChild(div);
  }
}

/* ================== Event detail ================== */
async function openEvent(id){
  if (!id) return;
  currentEventId = id;

  // Try cache first
  let evt = eventsCache.find(x => x.id === id);
  if (!evt){
    const { data, error } = await supabaseClient
      .from("events")
      .select("id,title,description,country_code,created_at,is_active")
      .eq("id", id)
      .maybeSingle();
    if (error || !data) return;
    evt = data;
  }

  // ensure country pill sync
  if (evt.country_code){
    selectedCountryCode = evt.country_code;
    selectedCountryName = countriesByCode[selectedCountryCode]?.name || selectedCountryCode;
    setCountryPill();
    setBigMapSelected(selectedCountryCode);
  }

  eventTitle.textContent = evt.title || "‚Äî";
  const cName = evt.country_code ? (countriesByCode[evt.country_code]?.name || "") : "";
  eventMeta.textContent = evt.country_code ? `Country: ${cName} (${evt.country_code})` : "";
  eventDesc.textContent = evt.description || "";

  showScreen("EVENT");
  renderContinentCountries();
}

/* ================== Data loading ================== */
async function loadContinents(){
  const { data, error } = await supabaseClient.from("continents").select("id,name").order("id", { ascending:true });
  if (error){ console.error("loadContinents error:", error); continentsById = {}; return; }
  continentsById = {};
  for (const c of (data || [])) continentsById[c.id] = c.name;
}

async function loadCountries(){
  const { data, error } = await supabaseClient
    .from("countries")
    .select("code,name,continent_id")
    .order("name", { ascending:true });

  if (error){ console.error("loadCountries error:", error); countries = []; countriesByCode = {}; return; }

  countries = (data || []).map(c => ({
    ...c,
    continent_name: continentsById[c.continent_id] || ""
  }));

  countriesByCode = {};
  for (const c of countries) countriesByCode[c.code] = c;
}

async function loadEventsCache(){
  const { data, error } = await supabaseClient
    .from("events")
    .select("id,title,description,country_code,is_active,created_at")
    .eq("is_active", true)
    .order("created_at", { ascending:false })
    .limit(1000);

  if (error){ console.error("loadEventsCache error:", error); eventsCache = []; return; }
  eventsCache = data || [];
}

/* ================== Map ================== */
function initMap(){
  map = new mapboxgl.Map({
    container: "map",
    style: "mapbox://styles/mapbox/light-v11",
    center: [10, 20],
    zoom: 1.2
  });

  map.on("load", () => {
    // apply continent view after style loads
    setTimeout(() => applyContinentView(), 0);

    map.addSource("countryBoundaries", { type:"vector", url:"mapbox://mapbox.country-boundaries-v1" });

    map.addLayer({
      id: "country-fill",
      type: "fill",
      source: "countryBoundaries",
      "source-layer": "country_boundaries",
      paint: { "fill-color":"#000", "fill-opacity":0.05 }
    });

    map.addLayer({
      id: "country-selected",
      type: "fill",
      source: "countryBoundaries",
      "source-layer": "country_boundaries",
      paint: { "fill-color":"#000", "fill-opacity":0.18 },
      filter: ["==", ["get","iso_3166_1"], ""]
    });

    let hoveredISO = "";
    map.addLayer({
      id: "country-hover",
      type: "fill",
      source: "countryBoundaries",
      "source-layer": "country_boundaries",
      paint: { "fill-color":"#000", "fill-opacity":0.12 },
      filter: ["==", ["get","iso_3166_1"], ""]
    });

    map.on("mousemove", "country-fill", (e) => {
      const iso = e.features?.[0]?.properties?.iso_3166_1 || "";
      if (iso !== hoveredISO){
        hoveredISO = iso;
        map.setFilter("country-hover", ["==", ["get","iso_3166_1"], hoveredISO]);
      }
      map.getCanvas().style.cursor = "pointer";
    });

    map.on("mouseleave", "country-fill", () => {
      hoveredISO = "";
      map.setFilter("country-hover", ["==", ["get","iso_3166_1"], ""]);
      map.getCanvas().style.cursor = "";
    });

    map.on("click", "country-fill", async (e) => {
      const iso = e.features?.[0]?.properties?.iso_3166_1 || "";
      if (!iso) return;

      // If continent filter is active, ignore clicks outside it
      if (selectedContinent !== "ALL"){
        const cont = continentOfCountry(iso);
        if (cont !== selectedContinent){
          // brief feedback
          console.log("Country outside selected continent:", iso, cont, "selected:", selectedContinent);
          return;
        }
      }

      await selectCountry(iso);
    });
  });
}

function setBigMapSelected(code){
  if (!map || !map.getLayer("country-selected")) return;
  map.setFilter("country-selected", ["==", ["get","iso_3166_1"], code || ""]);
}

/* ================== INIT ================== */
(async function init(){
  // default pills
  setContinentPill();
  setCountryPill();

  await loadContinents();
  await loadCountries();
  await loadEventsCache();

  initMap();
  renderContinentCountries();
  applyContinentView();
})();
</script>

</body>
</html>
