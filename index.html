<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<title>People can a Vote</title>

<link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet"/>

<style>
body { margin:0; font-family:Arial, sans-serif; background:#f4f6f8; }
header { background:#fff; padding:20px; box-shadow:0 2px 4px rgba(0,0,0,.1); }
section { padding:20px; }
.event { background:#fff; padding:12px; border-radius:6px; margin-bottom:10px; cursor:pointer; }
button { padding:6px 12px; margin-right:6px; cursor:pointer; }
#map { height:450px; }
</style>
</head>

<body>

<header>
  <h1>People can a Vote</h1>
  <p>Global view of opinions from around the world</p>
</header>

<section id="auth">
  <div id="auth-forms">
    <input id="email" type="email" placeholder="Email">
    <input id="password" type="password" placeholder="Heslo">
    <button id="signup-btn">Registrovat</button>
    <button id="login-btn">Přihlásit</button>
  </div>

  <div id="auth-logged" style="display:none;">
    <span id="auth-message"></span>
    <button id="logout-btn">Odhlásit</button>
  </div>
</section>

<section id="events">
  <h2>Hlasovací události</h2>
</section>

<section id="vote-section" style="background:#fff; border-radius:6px; margin:20px; padding:15px;">
  <h3>Hlasování</h3>

  <div id="vote-buttons" style="display:none;">
    <button id="vote-yes">Ano</button>
    <button id="vote-no">Ne</button>
    <button id="vote-neutral">Nemám názor</button>
  </div>

  <p id="vote-message"></p>
</section>

<section id="vote-stats"></section>

<div id="map"></div>

<script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<script>
/* ================= SUPABASE ================= */
const supabaseClient = supabase.createClient(
  'https://jqoomnhpyuikbntnrukw.supabase.co',
  'sb_publishable_SjZ_HQWN0XRE9ebbf_OwQg_kmJeS43h'
);

let currentEventId = null;

/* ================= ELEMENTY ================= */
const voteButtons = document.getElementById('vote-buttons');
const voteMessage = document.getElementById('vote-message');
const voteStats = document.getElementById('vote-stats');

voteButtons.style.display = 'none';

/* ================= AUTH ================= */
const email = document.getElementById('email');
const password = document.getElementById('password');

document.getElementById('login-btn').onclick = async () => {
  const { error } = await supabaseClient.auth.signInWithPassword({
    email: email.value,
    password: password.value
  });
  if (error) alert(error.message);
};

document.getElementById('signup-btn').onclick = async () => {
  const { error } = await supabaseClient.auth.signUp({
    email: email.value,
    password: password.value
  });
  if (error) alert(error.message);
};

document.getElementById('logout-btn').onclick = async () => {
  await supabaseClient.auth.signOut();
};

/* ================= AUTH STATE ================= */
supabaseClient.auth.onAuthStateChange((event, session) => {
  updateAuthUI();

  if (session && currentEventId) {
    checkUserVote(currentEventId);
  }
});

/* ================= UI ================= */
async function updateAuthUI() {
  const { data } = await supabaseClient.auth.getSession();
  const user = data.session?.user;

  if (user) {
    document.getElementById('auth-forms').style.display = 'none';
    document.getElementById('auth-logged').style.display = 'block';
    document.getElementById('auth-message').textContent =
      `Přihlášen jako: ${user.email}`;
  } else {
    document.getElementById('auth-forms').style.display = 'block';
    document.getElementById('auth-logged').style.display = 'none';
    voteButtons.style.display = 'none';
    voteMessage.textContent = '';
  }
}

/* ================= EVENTS ================= */
async function loadEvents() {
  const { data } = await supabaseClient
    .from('events')
    .select('*')
    .eq('is_active', true);

  const container = document.getElementById('events');

  data.forEach(event => {
    const div = document.createElement('div');
    div.className = 'event';
    div.textContent = event.title;

    div.onclick = () => {
      currentEventId = event.id;
      loadVoteStats(event.id);

      const { data } = supabaseClient.auth.getSession();
      if (data?.session) checkUserVote(event.id);
    };

    container.appendChild(div);
  });

  if (data.length) {
    currentEventId = data[0].id;
    loadVoteStats(currentEventId);
  }
}

/* ================= CHECK VOTE ================= */
async function checkUserVote(eventId) {
  voteButtons.style.display = 'none';
  voteMessage.textContent = '';

  const { data } = await supabaseClient.auth.getSession();
  const user = data.session?.user;
  if (!user) return;

  const { data: existing } = await supabaseClient
    .from('votes')
    .select('vote')
    .eq('user_id', user.id)
    .eq('event_id', eventId)
    .maybeSingle();

  if (existing) {
    voteMessage.textContent = `Už jste hlasoval (${existing.vote}).`;
  } else {
    voteButtons.style.display = 'block';
  }
}

/* ================= SUBMIT VOTE ================= */
async function submitVote(value) {
  const { data } = await supabaseClient.auth.getSession();
  const user = data.session?.user;
  if (!user) return;

  const { error } = await supabaseClient.from('votes').insert({
    user_id: user.id,
    event_id: currentEventId,
    vote: value,
    country_code: 'GL'
  });

  if (error) {
    if (error.code === '23505') {
      voteMessage.textContent = 'Už jste hlasoval.';
      voteButtons.style.display = 'none';
    } else {
      voteMessage.textContent = error.message;
    }
    return;
  }

  voteButtons.style.display = 'none';
  voteMessage.textContent = 'Hlas uložen.';
  loadVoteStats(currentEventId);
}

/* ================= BUTTONS ================= */
document.getElementById('vote-yes').onclick = () => submitVote('Ano');
document.getElementById('vote-no').onclick = () => submitVote('Ne');
document.getElementById('vote-neutral').onclick = () => submitVote('Nemám názor');

/* ================= STATS ================= */
async function loadVoteStats(eventId) {
  const { data } = await supabaseClient
    .from('votes')
    .select('vote')
    .eq('event_id', eventId);

  voteStats.innerHTML = `<p>Celkem hlasů: ${data.length}</p>`;
}

/* ================= MAP ================= */
mapboxgl.accessToken =
  'pk.eyJ1IjoiaGVyZ290dCIsImEiOiJjbWttdHQ3cmYwZ2hmM2pyMjd2bmk1c3ZmIn0.-9CViuw1h3-gy49EsKvFiQ';

new mapboxgl.Map({
  container: 'map',
  style: 'mapbox://styles/mapbox/light-v11',
  center: [-42, 72],
  zoom: 2
});

/* ================= INIT ================= */
updateAuthUI();
loadEvents();

document.addEventListener('visibilitychange', () => {
  if (!document.hidden && currentEventId) {
    checkUserVote(currentEventId);
  }
});


</script>

</body>
</html>
