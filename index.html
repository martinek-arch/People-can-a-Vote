<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>People can a Vote</title>

<link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet"/>

<style>
  body { margin:0; font-family:Arial, sans-serif; background:#f4f6f8; }
  .wrap { max-width:1100px; margin:0 auto; }

  header { background:#fff; box-shadow:0 2px 4px rgba(0,0,0,.1); position:sticky; top:0; z-index:20; }
  .nav { display:flex; align-items:center; justify-content:space-between; gap:12px; padding:12px 16px; }
  .brand { display:flex; flex-direction:column; }
  .brand h1 { margin:0; font-size:18px; }
  .brand .muted { margin:2px 0 0; color:#666; font-size:12px; }

  .nav-left, .nav-right { display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
  button { padding:10px 14px; cursor:pointer; border:0; border-radius:10px; }
  button.primary { background:#111; color:#fff; }
  button.ghost { background:#eee; }
  button:disabled { opacity:.5; cursor:not-allowed; }

  input, select { padding:10px; border-radius:10px; border:1px solid #ddd; background:#fff; }
  input { min-width:260px; }

  .card { background:#fff; padding:16px; border-radius:12px; margin:16px; }
  .muted { color:#666; }
  .pill { background:#f1f1f1; padding:6px 10px; border-radius:999px; font-size:12px; }

  #map { height:480px; margin:16px; border-radius:12px; overflow:hidden; }

  .topGrid { display:grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap:12px; }
  @media (max-width: 900px) { .topGrid { grid-template-columns: 1fr; } }
  .topCard { border:1px solid #eee; border-radius:12px; padding:14px; cursor:pointer; }
  .topCard:hover { border-color:#ddd; }
  .topCount { font-size:12px; color:#666; margin-top:8px; }

  .event { background:#fff; padding:14px; border-radius:12px; margin:10px 16px; cursor:pointer; border:1px solid #eee; }
  .event:hover { border-color:#ddd; }
  .event small { color:#666; display:block; margin-top:6px; }

  .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
  .barWrap { margin:10px 0 14px; }
  .barRow { display:flex; align-items:center; gap:10px; margin:8px 0; }
  .barLabel { width:160px; font-size:14px; }
  .barOuter { flex:1; background:#eee; border-radius:999px; overflow:hidden; height:14px; }
  .barInner { height:100%; width:0%; background:#111; }
  .barValue { width:160px; text-align:right; font-size:13px; color:#333; }

  .screen { display:none; }
  .screen.active { display:block; }

  /* back buttons near titles */
  .titleRow { display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
  .backInline { padding:8px 12px; border-radius:10px; background:#eee; }

  /* mini map */
  #mini-map-wrap{
    position:absolute;
    right:12px;
    bottom:12px;
    width:240px;
    height:170px;
    border-radius:12px;
    overflow:hidden;
    border:1px solid #eee;
    box-shadow:0 6px 14px rgba(0,0,0,.08);
    background:#fafafa;
  }
  #mini-map{ width:100%; height:100%; }
  #mini-badge{
    position:absolute;
    left:10px;
    top:10px;
    background:rgba(255,255,255,.92);
    border:1px solid #eee;
    padding:6px 10px;
    border-radius:999px;
    font-size:12px;
    color:#333;
  }
  .relative { position:relative; }

  @media (max-width: 700px){
    input{ min-width:180px; }
    #mini-map-wrap{ position:relative; right:auto; bottom:auto; width:100%; height:220px; margin-top:12px; }
  }

  /* Search suggest dropdown */
  .searchWrap { position:relative; }
  #suggest {
    position:absolute;
    top:44px;
    left:0;
    right:0;
    background:#fff;
    border:1px solid #ddd;
    border-radius:12px;
    overflow:hidden;
    box-shadow:0 10px 24px rgba(0,0,0,.10);
    display:none;
    max-height:320px;
    overflow-y:auto;
    z-index:30;
  }
  .suggestItem{
    padding:10px 12px;
    cursor:pointer;
    display:flex;
    justify-content:space-between;
    gap:10px;
    border-top:1px solid #f2f2f2;
  }
  .suggestItem:first-child{ border-top:none; }
  .suggestItem:hover{ background:#f6f6f6; }
  .suggestLeft{ display:flex; flex-direction:column; }
  .tag{ font-size:11px; color:#666; background:#f1f1f1; padding:4px 8px; border-radius:999px; white-space:nowrap; align-self:flex-start; }
  .suggestTitle{ font-weight:600; }
  .suggestSub{ color:#666; font-size:12px; margin-top:2px; }
</style>
</head>

<body>

<header>
  <div class="wrap nav">
    <div class="nav-left">
      <div class="brand">
        <h1>People can a Vote</h1>
        <div class="muted">Global view of opinions from around the world</div>
      </div>

      <button class="ghost" id="homeBtn">Home</button>
      <!-- crumb (skryjeme na HOME) -->
      <span class="pill" id="crumb" style="display:none;"></span>
    </div>

    <div class="nav-right">
      <div class="searchWrap">
        <input id="search" type="text" placeholder="Search country or event…">
        <div id="suggest"></div>
      </div>

      <span class="pill" id="selectedCountryPill">Country: (all)</span>

      <span class="pill" id="authPill">Not signed in</span>
      <button class="ghost" id="openAuthBtn">Log in</button>
      <button class="ghost" id="logoutBtn" style="display:none;">Log out</button>
    </div>
  </div>
</header>

<div class="wrap">

  <!-- AUTH -->
  <section class="card" id="authCard" style="display:none;">
    <h3 id="authTitle" style="margin:0 0 10px 0;">Log in / Sign up</h3>

    <div class="row">
      <input id="email" type="email" placeholder="Email">
      <input id="password" type="password" placeholder="Password">

      <select id="countrySelect">
        <option value="">Loading countries…</option>
      </select>

      <select id="languageSelect">
        <option value="en">English</option>
        <option value="es">Español</option>
        <option value="fr">Français</option>
        <option value="ar">العربية</option>
        <option value="ru">Русский</option>
        <option value="zh">中文 (简体)</option>
        <option value="cs">Čeština</option>
      </select>
    </div>

    <div class="row" style="margin-top:10px;">
      <button class="primary" id="signupBtn">Sign up</button>
      <button class="ghost" id="loginBtn">Log in</button>
      <button class="ghost" id="closeAuthBtn">Close</button>
    </div>

    <p id="authError" style="color:#b00020; margin:10px 0 0;"></p>
    <div id="authHint" class="muted" style="margin-top:10px; font-size:13px;">
      Country is required only for sign up. For login it’s ignored.
    </div>
  </section>

  <!-- HOME -->
  <section id="screenHome" class="screen active">
    <section class="card">
      <div class="row" style="justify-content:space-between;">
        <div>
          <h3 id="top3Title" style="margin:0 0 6px 0;">Top 3 events (global)</h3>
          <div id="top3Sub" class="muted">Events with the most votes.</div>
        </div>
        <button class="ghost" id="refreshTop">Refresh</button>
      </div>
      <div id="top3" class="topGrid" style="margin-top:12px;">
        <div class="muted">Loading…</div>
      </div>
    </section>

    <section class="card">
      <div class="row" style="justify-content:space-between;">
        <div>
          <h3 id="mapTitle" style="margin:0 0 6px 0;">Map</h3>
          <div id="mapSub" class="muted">Click a country → see events for that country.</div>
        </div>
        <button class="ghost" id="clearCountry">Clear selection</button>
      </div>
      <div id="map"></div>
    </section>
  </section>

  <!-- COUNTRY -->
  <section id="screenCountry" class="screen">
    <section class="card">
      <div class="titleRow">
        <button class="backInline" id="backFromCountry">← Back</button>
        <h2 id="eventsTitle" style="margin:0;">Events</h2>
      </div>
      <div class="muted" id="countrySubtitle" style="margin-top:8px;">
        Select a country on the map or search.
      </div>
    </section>
    <div id="events"></div>
  </section>

  <!-- EVENT -->
  <section id="screenEvent" class="screen">
    <section class="card relative" id="eventCard">
      <div class="titleRow">
        <button class="backInline" id="backFromEvent">← Back</button>
        <h2 id="eventTitle" style="margin:0;">—</h2>
      </div>

      <div class="muted" id="eventDesc" style="margin-top:8px;"></div>

      <div id="voteButtons" style="display:none; margin-top:12px;">
        <div class="row">
          <button class="primary" id="voteYes">Yes</button>
          <button class="primary" id="voteNo">No</button>
          <button class="primary" id="voteNeutral">No opinion</button>
        </div>
      </div>

      <p id="voteMsg" style="margin:12px 0 0;"></p>

      <div id="mini-map-wrap">
        <div id="mini-map"></div>
        <div id="mini-badge">Country: —</div>
      </div>
    </section>

    <section class="card">
      <h3 id="statsTitle" style="margin:0 0 10px 0;">Statistics</h3>
      <div id="stats" class="muted">Loading…</div>
    </section>
  </section>

</div>

<script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<script>
/* ================== CONFIG ================== */
const supabaseClient = supabase.createClient(
  'https://jqoomnhpyuikbntnrukw.supabase.co',
  'sb_publishable_SjZ_HQWN0XRE9ebbf_OwQg_kmJeS43h'
);

mapboxgl.accessToken =
  'pk.eyJ1IjoiaGVyZ290dCIsImEiOiJjbWttdHQ3cmYwZ2hmM2pyMjd2bmk1c3ZmIn0.-9CViuw1h3-gy49EsKvFiQ';

/* ================== i18n ================== */
const I18N = {
  en: { home:"Home", back:"Back", events:"Events", stats:"Statistics", map:"Map",
        top3:"Top 3 events (global)", top3Sub:"Events with the most votes.",
        mapSub:"Click a country → see events for that country.",
        login:"Log in", logout:"Log out", authTitle:"Log in / Sign up", signUp:"Sign up", signIn:"Log in", close:"Close",
        signedAs:"Signed in as", notLogged:"Not signed in",
        voteLogin:"Please log in to vote.", alreadyVoted:"You already voted", saved:"Vote saved.",
        yes:"Yes", no:"No", neutral:"No opinion", searchPh:"Search country or event…",
        clearCountry:"Clear selection", chooseCountry:"Select a country on the map or search.",
        noEvents:"No events for this selection.",
        countryPrefix:"Country:", all:"(all)", eventBreadcrumb:"Event",
        other:"Other"
  },
  cs: { home:"Home", back:"Zpět", events:"Události", stats:"Statistiky", map:"Mapa",
        top3:"TOP 3 události (globálně)", top3Sub:"Události s největším počtem hlasů.",
        mapSub:"Klikni na zemi → uvidíš události pro danou zemi.",
        login:"Přihlásit", logout:"Odhlásit", authTitle:"Přihlášení / Registrace", signUp:"Registrovat", signIn:"Přihlásit", close:"Zavřít",
        signedAs:"Přihlášen jako", notLogged:"Nepřihlášen",
        voteLogin:"Pro hlasování se přihlas.", alreadyVoted:"Už jste hlasoval", saved:"Hlas uložen.",
        yes:"Ano", no:"Ne", neutral:"Nemám názor", searchPh:"Hledej zemi nebo událost…",
        clearCountry:"Zrušit výběr", chooseCountry:"Vyber z mapy zemi, nebo použij vyhledávání.",
        noEvents:"Žádné události pro tento výběr.",
        countryPrefix:"Země:", all:"(vše)", eventBreadcrumb:"Událost",
        other:"Ostatní"
  },
  es: { home:"Inicio", back:"Atrás", events:"Eventos", stats:"Estadísticas", map:"Mapa",
        top3:"Top 3 eventos (global)", top3Sub:"Eventos con más votos.",
        mapSub:"Haz clic en un país → ver eventos de ese país.",
        login:"Iniciar sesión", logout:"Cerrar sesión", authTitle:"Iniciar sesión / Registrarse", signUp:"Registrarse", signIn:"Iniciar sesión", close:"Cerrar",
        signedAs:"Conectado como", notLogged:"No conectado",
        voteLogin:"Inicia sesión para votar.", alreadyVoted:"Ya has votado", saved:"Voto guardado.",
        yes:"Sí", no:"No", neutral:"Sin opinión", searchPh:"Buscar país o evento…",
        clearCountry:"Borrar selección", chooseCountry:"Selecciona un país en el mapa o busca.",
        noEvents:"No hay eventos para esta selección.",
        countryPrefix:"País:", all:"(todos)", eventBreadcrumb:"Evento",
        other:"Otros"
  },
  fr: { home:"Accueil", back:"Retour", events:"Événements", stats:"Statistiques", map:"Carte",
        top3:"Top 3 événements (global)", top3Sub:"Événements avec le plus de votes.",
        mapSub:"Cliquez sur un pays → voir les événements de ce pays.",
        login:"Se connecter", logout:"Se déconnecter", authTitle:"Connexion / Inscription", signUp:"S'inscrire", signIn:"Se connecter", close:"Fermer",
        signedAs:"Connecté en tant que", notLogged:"Non connecté",
        voteLogin:"Connectez-vous pour voter.", alreadyVoted:"Vous avez déjà voté", saved:"Vote enregistré.",
        yes:"Oui", no:"Non", neutral:"Sans avis", searchPh:"Rechercher un pays ou un événement…",
        clearCountry:"Effacer la sélection", chooseCountry:"Sélectionnez un pays sur la carte ou recherchez.",
        noEvents:"Aucun événement pour cette sélection.",
        countryPrefix:"Pays:", all:"(tous)", eventBreadcrumb:"Événement",
        other:"Autres"
  },
  ar: { home:"الرئيسية", back:"رجوع", events:"الأحداث", stats:"الإحصائيات", map:"الخريطة",
        top3:"أفضل 3 أحداث (عالميًا)", top3Sub:"الأحداث الأكثر تصويتًا.",
        mapSub:"انقر على دولة → عرض أحداث تلك الدولة.",
        login:"تسجيل الدخول", logout:"تسجيل الخروج", authTitle:"تسجيل الدخول / إنشاء حساب", signUp:"إنشاء حساب", signIn:"تسجيل الدخول", close:"إغلاق",
        signedAs:"تم تسجيل الدخول كـ", notLogged:"غير مسجل",
        voteLogin:"سجّل الدخول للتصويت.", alreadyVoted:"لقد صوّت بالفعل", saved:"تم حفظ التصويت.",
        yes:"نعم", no:"لا", neutral:"لا رأي", searchPh:"ابحث عن دولة أو حدث…",
        clearCountry:"مسح الاختيار", chooseCountry:"اختر دولة على الخريطة أو ابحث.",
        noEvents:"لا توجد أحداث لهذا الاختيار.",
        countryPrefix:"الدولة:", all:"(الكل)", eventBreadcrumb:"الحدث",
        other:"آخرون"
  },
  ru: { home:"Главная", back:"Назад", events:"События", stats:"Статистика", map:"Карта",
        top3:"Топ 3 событий (в мире)", top3Sub:"События с наибольшим числом голосов.",
        mapSub:"Нажмите на страну → увидеть события этой страны.",
        login:"Войти", logout:"Выйти", authTitle:"Вход / Регистрация", signUp:"Регистрация", signIn:"Войти", close:"Закрыть",
        signedAs:"Вошли как", notLogged:"Не вошли",
        voteLogin:"Войдите, чтобы голосовать.", alreadyVoted:"Вы уже голосовали", saved:"Голос сохранён.",
        yes:"Да", no:"Нет", neutral:"Нет мнения", searchPh:"Поиск страны или события…",
        clearCountry:"Сбросить выбор", chooseCountry:"Выберите страну на карте или воспользуйтесь поиском.",
        noEvents:"Нет событий для этого выбора.",
        countryPrefix:"Страна:", all:"(все)", eventBreadcrumb:"Событие",
        other:"Другие"
  },
  zh: { home:"主页", back:"返回", events:"事件", stats:"统计", map:"地图",
        top3:"全球热门前3事件", top3Sub:"投票最多的事件。",
        mapSub:"点击国家 → 查看该国事件。",
        login:"登录", logout:"退出", authTitle:"登录 / 注册", signUp:"注册", signIn:"登录", close:"关闭",
        signedAs:"已登录为", notLogged:"未登录",
        voteLogin:"请先登录再投票。", alreadyVoted:"你已投票", saved:"投票已保存。",
        yes:"是", no:"否", neutral:"无意见", searchPh:"搜索国家或事件…",
        clearCountry:"清除选择", chooseCountry:"在地图上选择国家或搜索。",
        noEvents:"该选择暂无事件。",
        countryPrefix:"国家：", all:"(全部)", eventBreadcrumb:"事件",
        other:"其他"
  }
};

let currentLang = 'en';
function t(key){
  return (I18N[currentLang] && I18N[currentLang][key]) ? I18N[currentLang][key]
       : (I18N.en[key] || key);
}
function getBrowserLang(){
  const lang = (navigator.language || 'en').toLowerCase();
  if (lang.startsWith('cs')) return 'cs';
  if (lang.startsWith('es')) return 'es';
  if (lang.startsWith('fr')) return 'fr';
  if (lang.startsWith('ar')) return 'ar';
  if (lang.startsWith('ru')) return 'ru';
  if (lang.startsWith('zh')) return 'zh';
  return 'en';
}
function applyI18n(){
  document.documentElement.lang = currentLang;
  document.documentElement.dir = (currentLang === 'ar') ? 'rtl' : 'ltr';

  document.getElementById('homeBtn').textContent = t('home');
  document.getElementById('openAuthBtn').textContent = t('login');
  document.getElementById('logoutBtn').textContent = t('logout');
  document.getElementById('search').placeholder = t('searchPh');

  document.getElementById('authTitle').textContent = t('authTitle');
  document.getElementById('signupBtn').textContent = t('signUp');
  document.getElementById('loginBtn').textContent = t('signIn');
  document.getElementById('closeAuthBtn').textContent = t('close');

  document.getElementById('top3Title').textContent = t('top3');
  document.getElementById('top3Sub').textContent = t('top3Sub');
  document.getElementById('mapTitle').textContent = t('map');
  document.getElementById('mapSub').textContent = t('mapSub');
  document.getElementById('clearCountry').textContent = t('clearCountry');

  document.getElementById('eventsTitle').textContent = t('events');
  document.getElementById('backFromCountry').textContent = "← " + t('back');
  document.getElementById('backFromEvent').textContent = "← " + t('back');
  document.getElementById('statsTitle').textContent = t('stats');

  document.getElementById('voteYes').textContent = t('yes');
  document.getElementById('voteNo').textContent = t('no');
  document.getElementById('voteNeutral').textContent = t('neutral');

  setCountryPill();
}

/* ================== STATE ================== */
let screen = "HOME";
let selectedCountryCode = "";
let selectedCountryName = "";
let currentEventId = null;
let currentEventCountryCode = null;
let userCountryCode = null;

let countries = [];
let eventsCache = [];

const VOTE_VALUES = { YES: "YES", NO: "NO", NEUTRAL: "NEUTRAL" };

/* ================== UI refs ================== */
const crumb = document.getElementById('crumb');

const screenHome = document.getElementById('screenHome');
const screenCountry = document.getElementById('screenCountry');
const screenEvent = document.getElementById('screenEvent');

const top3Div = document.getElementById('top3');
const clearCountry = document.getElementById('clearCountry');
const eventsDiv = document.getElementById('events');
const countrySubtitle = document.getElementById('countrySubtitle');

const eventTitle = document.getElementById('eventTitle');
const eventDesc = document.getElementById('eventDesc');
const voteButtons = document.getElementById('voteButtons');
const voteMsg = document.getElementById('voteMsg');
const stats = document.getElementById('stats');
const miniBadge = document.getElementById('mini-badge');

const search = document.getElementById('search');
const suggest = document.getElementById('suggest');

document.getElementById('homeBtn').onclick = () => goHome();
document.getElementById('backFromCountry').onclick = () => goBackFromCountry();
document.getElementById('backFromEvent').onclick = () => goBackFromEvent();
document.getElementById('refreshTop').onclick = () => loadTop3();

const authCard = document.getElementById('authCard');
const openAuthBtn = document.getElementById('openAuthBtn');
const closeAuthBtn = document.getElementById('closeAuthBtn');
const logoutBtn = document.getElementById('logoutBtn');
const authPill = document.getElementById('authPill');

const email = document.getElementById('email');
const password = document.getElementById('password');
const countrySelect = document.getElementById('countrySelect');
const languageSelect = document.getElementById('languageSelect');
const authError = document.getElementById('authError');

const loginBtn = document.getElementById('loginBtn');
const signupBtn = document.getElementById('signupBtn');

const selectedCountryPill = document.getElementById('selectedCountryPill');

/* ================== Helpers ================== */
function escapeHtml(s){
  return (s||"").toString()
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;");
}
function norm(s){
  return (s || "")
    .toString()
    .toLowerCase()
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "")
    .trim();
}

function showScreen(next){
  screen = next;
  screenHome.classList.toggle('active', next === "HOME");
  screenCountry.classList.toggle('active', next === "COUNTRY");
  screenEvent.classList.toggle('active', next === "EVENT");

  // crumb: hide on HOME
  if (next === "HOME") {
    crumb.style.display = "none";
    crumb.textContent = "";
  } else {
    crumb.style.display = "inline-block";
    if (next === "COUNTRY") crumb.textContent = selectedCountryCode ? `${t('countryPrefix')} ${selectedCountryName} (${selectedCountryCode})` : t('events');
    if (next === "EVENT") crumb.textContent = t('eventBreadcrumb');
  }
}

function goHome(){
  currentEventId = null;
  hideSuggest();
  showScreen("HOME");
}
function goBackFromCountry(){
  hideSuggest();
  showScreen("HOME");
}
function goBackFromEvent(){
  hideSuggest();
  showScreen("COUNTRY");
}

function setCountryPill(){
  selectedCountryPill.textContent = selectedCountryCode
    ? `${t('countryPrefix')} ${selectedCountryName} (${selectedCountryCode})`
    : `${t('countryPrefix')} ${t('all')}`;
}

function getCountryNameByCode(code){
  const c = countries.find(x => x.code === code);
  return c ? c.name : code;
}

function safePct(part, total){ return total ? Math.round((part/total)*100) : 0; }
function barHTML(label, count, total) {
  const pct = safePct(count, total);
  return `
    <div class="barRow">
      <div class="barLabel">${escapeHtml(label)}</div>
      <div class="barOuter"><div class="barInner" style="width:${pct}%;"></div></div>
      <div class="barValue">${count} (${pct}%)</div>
    </div>
  `;
}

// Backward-compatible vote normalization (old CZ strings vs new codes)
function voteCode(v){
  if (v === "YES" || v === "NO" || v === "NEUTRAL") return v;
  if (v === "Ano") return "YES";
  if (v === "Ne") return "NO";
  if (v === "Nemám názor") return "NEUTRAL";
  return v;
}

/* ================== Search suggest ================== */
function hideSuggest(){
  suggest.style.display = "none";
  suggest.innerHTML = "";
}
function showSuggest(items){
  if (!items.length){ hideSuggest(); return; }
  suggest.innerHTML = items.join("");
  suggest.style.display = "block";
}

function buildSuggest(termRaw){
  const term = norm(termRaw);
  if (term.length < 2) { hideSuggest(); return; }

  const cMatches = countries
    .filter(c => norm(c.name).includes(term) || norm(c.code).startsWith(term))
    .slice(0, 5)
    .map(c => ({
      type: "country",
      key: c.code,
      title: `${c.name} (${c.code})`,
      sub: t('events')
    }));

  const eMatches = eventsCache
    .filter(e => norm(e.title).includes(term) || norm(e.description).includes(term))
    .slice(0, 5)
    .map(e => ({
      type: "event",
      key: String(e.id),
      title: e.title || "(no title)",
      sub: `${e.country_code || "?"}`
    }));

  const merged = [...cMatches, ...eMatches].slice(0, 10);

  const html = merged.map(item => `
    <div class="suggestItem" data-type="${item.type}" data-key="${escapeHtml(item.key)}">
      <div class="suggestLeft">
        <div class="suggestTitle">${escapeHtml(item.title)}</div>
        <div class="suggestSub">${escapeHtml(item.sub)}</div>
      </div>
      <div class="tag">${item.type === "country" ? "Country" : "Event"}</div>
    </div>
  `);

  showSuggest(html);

  for (const el of suggest.querySelectorAll('.suggestItem')){
    el.addEventListener('click', async () => {
      const type = el.getAttribute('data-type');
      const key = el.getAttribute('data-key');
      hideSuggest();
      search.blur();
      if (type === "country") await selectCountry(key);
      else await openEvent(Number(key));
    });
  }
}

search.addEventListener('input', () => buildSuggest(search.value));
search.addEventListener('focus', () => buildSuggest(search.value));
document.addEventListener('click', (e) => {
  if (!e.target.closest('.searchWrap')) hideSuggest();
});

/* ================== Auth ================== */
openAuthBtn.onclick = async () => {
  authCard.style.display = "block";
  authError.textContent = "";
  if (!countries.length) await loadCountries();
};
closeAuthBtn.onclick = () => { authCard.style.display = "none"; };
logoutBtn.onclick = async () => { await supabaseClient.auth.signOut(); };

loginBtn.onclick = async () => {
  authError.textContent = "";
  const { error } = await supabaseClient.auth.signInWithPassword({ email: email.value, password: password.value });
  if (error) {
    authError.textContent = error.message;
  } else {
    authCard.style.display = "none";
  }
};

signupBtn.onclick = async () => {
  authError.textContent = "";

  const cc = countrySelect.value;
  if (!cc) { authError.textContent = "Select country for sign up."; return; }

  const lang = languageSelect?.value || 'en';

  // instant UI switch for new user
  currentLang = lang;
  applyI18n();
  showScreen(screen);

  const { error: e1 } = await supabaseClient.auth.signUp({ email: email.value, password: password.value });
  if (e1) { authError.textContent = e1.message; return; }

  const { error: e2 } = await supabaseClient.auth.signInWithPassword({ email: email.value, password: password.value });
  if (e2) { authError.textContent = e2.message; return; }

  const { data: sess } = await supabaseClient.auth.getSession();
  const user = sess.session?.user;
  if (!user) return;

  const { error: e3 } = await supabaseClient.from('profiles').insert([{ id: user.id, country_code: cc, language: lang }]);
  if (e3 && e3.code !== '23505') {
    authError.textContent = e3.message;
    return;
  }

  authCard.style.display = "none";
  await refreshAuthPill();
};

supabaseClient.auth.onAuthStateChange(async () => {
  await refreshAuthPill();
  if (screen === "EVENT" && currentEventId) await refreshEventDetail(currentEventId);
});

async function refreshAuthPill(){
  const { data } = await supabaseClient.auth.getSession();
  const user = data.session?.user;

  if (!user){
    authPill.textContent = t('notLogged');
    openAuthBtn.style.display = "inline-block";
    logoutBtn.style.display = "none";
    userCountryCode = null;

    currentLang = getBrowserLang();
    applyI18n();
    showScreen(screen);
    countrySubtitle.textContent = t('chooseCountry');
    return;
  }

  openAuthBtn.style.display = "none";
  logoutBtn.style.display = "inline-block";

  const { data: prof, error } = await supabaseClient
    .from('profiles')
    .select('country_code, language')
    .eq('id', user.id)
    .maybeSingle();

  if (error) console.error("profile load error:", error);

  userCountryCode = prof?.country_code || null;
  currentLang = prof?.language || 'en';
  applyI18n();
  showScreen(screen);

  authPill.textContent = `${t('signedAs')}: ${user.email}`;
}

/* ================== Data loading ================== */
async function loadCountries(){
  const { data, error } = await supabaseClient
    .from('countries')
    .select('code,name')
    .order('name', { ascending:true });

  if (error) {
    console.error("loadCountries error:", error);
    countrySelect.innerHTML = '<option value="">Cannot load countries</option>';
    return;
  }

  countries = data || [];
  countrySelect.innerHTML = ['<option value="">Select country (required for sign up)</option>']
    .concat(countries.map(c => `<option value="${c.code}">${escapeHtml(c.name)} (${c.code})</option>`))
    .join('');
}

async function loadEventsCache(){
  const { data, error } = await supabaseClient
    .from('events')
    .select('id,title,description,country_code,is_active,created_at')
    .eq('is_active', true)
    .order('created_at', { ascending:false })
    .limit(1000);

  if (error) {
    console.error("loadEventsCache error:", error);
    eventsCache = [];
    return;
  }
  eventsCache = data || [];
}

/* ================== HOME: Top 3 ================== */
async function loadTop3(){
  top3Div.innerHTML = `<div class="muted">${escapeHtml("Loading…")}</div>`;

  const { data: votes, error: vErr } = await supabaseClient.from('votes').select('event_id');
  if (vErr) { top3Div.innerHTML = '<div class="muted">Cannot load TOP.</div>'; return; }

  const counts = new Map();
  for (const v of (votes || [])) counts.set(v.event_id, (counts.get(v.event_id) || 0) + 1);

  if (counts.size === 0) { top3Div.innerHTML = '<div class="muted">No votes yet.</div>'; return; }

  const top = [...counts.entries()].sort((a,b)=>b[1]-a[1]).slice(0,3);
  const ids = top.map(t=>t[0]);

  const { data: evs, error: eErr } = await supabaseClient.from('events')
    .select('id,title,description,country_code')
    .in('id', ids);

  if (eErr) { top3Div.innerHTML = '<div class="muted">Cannot load TOP detail.</div>'; return; }

  const byId = new Map((evs||[]).map(e=>[e.id,e]));
  top3Div.innerHTML = top.map(([id,cnt])=>{
    const e = byId.get(id);
    if (!e) return '';
    return `
      <div class="topCard" data-id="${e.id}">
        <strong>${escapeHtml(e.title||'')}</strong>
        <div class="muted" style="margin-top:6px;">${escapeHtml(e.description||'')}</div>
        <div class="topCount">Votes: <strong>${cnt}</strong> • ${escapeHtml(e.country_code||'?')}</div>
      </div>
    `;
  }).join("");

  for (const el of top3Div.querySelectorAll('.topCard')){
    el.addEventListener('click', async () => {
      const id = Number(el.getAttribute('data-id'));
      await openEvent(id);
    });
  }
}

/* ================== COUNTRY: events list ================== */
async function loadEvents(){
  eventsDiv.innerHTML = "";

  let q = supabaseClient
    .from('events')
    .select('id,title,description,country_code,created_at')
    .eq('is_active', true);

  if (selectedCountryCode) q = q.eq('country_code', selectedCountryCode);

  const { data, error } = await q.order('created_at', { ascending:false });
  if (error) { eventsDiv.innerHTML = '<div class="muted" style="margin:0 16px;">Cannot load events.</div>'; return; }

  const list = data || [];
  if (!list.length){
    eventsDiv.innerHTML = `<div class="muted" style="margin:0 16px;">${escapeHtml(t('noEvents'))}</div>`;
    return;
  }

  for (const e of list){
    const div = document.createElement('div');
    div.className = 'event';
    div.innerHTML = `<strong>${escapeHtml(e.title||'')}</strong><small>${escapeHtml(e.description||'')}</small>`;
    div.onclick = async () => { await openEvent(e.id); };
    eventsDiv.appendChild(div);
  }
}

async function selectCountry(code){
  selectedCountryCode = code || "";
  selectedCountryName = selectedCountryCode ? getCountryNameByCode(selectedCountryCode) : "";
  setCountryPill();

  countrySubtitle.textContent = selectedCountryCode
    ? `${t('countryPrefix')} ${selectedCountryName} (${selectedCountryCode})`
    : t('chooseCountry');

  showScreen("COUNTRY");
  setBigMapSelected(selectedCountryCode);
  await loadEvents();
}

/* ================== EVENT detail ================== */
async function openEvent(eventId){
  const { data: evt, error } = await supabaseClient
    .from('events')
    .select('id,title,description,country_code')
    .eq('id', eventId)
    .maybeSingle();

  if (error || !evt) return;

  currentEventId = evt.id;
  currentEventCountryCode = evt.country_code || "";

  if (currentEventCountryCode){
    selectedCountryCode = currentEventCountryCode;
    selectedCountryName = getCountryNameByCode(selectedCountryCode);
    setCountryPill();
    setBigMapSelected(selectedCountryCode);
  }

  showScreen("EVENT");
  authCard.style.display = "none";

  await refreshEventDetail(eventId);
}

async function refreshEventDetail(eventId){
  voteButtons.style.display = "none";
  voteMsg.textContent = "";
  stats.textContent = "Loading…";

  const { data: evt, error } = await supabaseClient
    .from('events')
    .select('id,title,description,country_code')
    .eq('id', eventId)
    .maybeSingle();

  if (error || !evt) return;

  currentEventCountryCode = evt.country_code || "";
  eventTitle.textContent = evt.title || "—";
  eventDesc.textContent = evt.description || "";

  miniBadge.textContent = currentEventCountryCode ? `${t('countryPrefix')} ${currentEventCountryCode}` : `${t('countryPrefix')} —`;
  updateMiniMapSelected(currentEventCountryCode || "");

  await loadStats(eventId, currentEventCountryCode);

  const { data: sess } = await supabaseClient.auth.getSession();
  const user = sess.session?.user;
  if (!user){
    voteMsg.textContent = t('voteLogin');
    return;
  }

  if (!userCountryCode) await refreshAuthPill();

  const { data: existing } = await supabaseClient
    .from('votes')
    .select('vote')
    .eq('user_id', user.id)
    .eq('event_id', eventId)
    .maybeSingle();

  if (existing){
    voteMsg.textContent = `${t('alreadyVoted')} (${voteCode(existing.vote)}).`;
    voteButtons.style.display = "none";
  } else {
    voteButtons.style.display = "block";
  }
}

document.getElementById('voteYes').onclick = () => submitVote(VOTE_VALUES.YES);
document.getElementById('voteNo').onclick = () => submitVote(VOTE_VALUES.NO);
document.getElementById('voteNeutral').onclick = () => submitVote(VOTE_VALUES.NEUTRAL);

async function submitVote(value){
  voteMsg.textContent = "";

  const { data: sess } = await supabaseClient.auth.getSession();
  const user = sess.session?.user;
  if (!user){ voteMsg.textContent = t('voteLogin'); return; }

  if (!userCountryCode) await refreshAuthPill();
  if (!userCountryCode){ voteMsg.textContent = "Missing profile country."; return; }

  const { error } = await supabaseClient.from('votes').insert({
    user_id: user.id,
    event_id: currentEventId,
    vote: value,
    country_code: userCountryCode
  });

  if (error){
    if (error.code === "23505"){
      voteMsg.textContent = t('alreadyVoted');
      voteButtons.style.display = "none";
    } else {
      voteMsg.textContent = error.message;
    }
    return;
  }

  voteButtons.style.display = "none";
  voteMsg.textContent = t('saved');
  await loadTop3();
  await refreshEventDetail(currentEventId);
}

/* ================== Stats ================== */
async function loadStats(eventId, eventCountryCode){
  const { data, error } = await supabaseClient
    .from('votes')
    .select('vote,country_code')
    .eq('event_id', eventId);

  if (error){ stats.textContent = "Cannot load statistics."; return; }

  const rows = data || [];
  const total = rows.length;

  const yes = rows.filter(v => voteCode(v.vote) === 'YES').length;
  const no = rows.filter(v => voteCode(v.vote) === 'NO').length;
  const neutral = rows.filter(v => voteCode(v.vote) === 'NEUTRAL').length;

  const citizens = eventCountryCode ? rows.filter(v => v.country_code === eventCountryCode) : [];
  const others = eventCountryCode ? rows.filter(v => v.country_code !== eventCountryCode) : rows;

  const cTotal = citizens.length, oTotal = others.length;

  const cYes = citizens.filter(v => voteCode(v.vote) === 'YES').length;
  const cNo = citizens.filter(v => voteCode(v.vote) === 'NO').length;
  const cNeutral = citizens.filter(v => voteCode(v.vote) === 'NEUTRAL').length;

  const oYes = others.filter(v => voteCode(v.vote) === 'YES').length;
  const oNo = others.filter(v => voteCode(v.vote) === 'NO').length;
  const oNeutral = others.filter(v => voteCode(v.vote) === 'NEUTRAL').length;

  stats.innerHTML = `
    <div><strong>${escapeHtml(t('stats'))}:</strong> ${total}</div>
    <div class="barWrap">
      ${barHTML(t('yes'), yes, total)}
      ${barHTML(t('no'), no, total)}
      ${barHTML(t('neutral'), neutral, total)}
    </div>

    <div style="margin-top:10px;"><strong>${escapeHtml(t('countryPrefix'))}</strong> ${eventCountryCode ? `(${escapeHtml(eventCountryCode)})` : ''}: ${cTotal}</div>
    <div class="barWrap">
      ${barHTML(t('yes'), cYes, cTotal)}
      ${barHTML(t('no'), cNo, cTotal)}
      ${barHTML(t('neutral'), cNeutral, cTotal)}
    </div>

    <div style="margin-top:10px;"><strong>${escapeHtml(t('other'))}:</strong> ${oTotal}</div>
    <div class="barWrap">
      ${barHTML(t('yes'), oYes, oTotal)}
      ${barHTML(t('no'), oNo, oTotal)}
      ${barHTML(t('neutral'), oNeutral, oTotal)}
    </div>
  `;
}

/* ================== MAPS ================== */
let map, miniMap;

document.getElementById('clearCountry').onclick = () => {
  selectedCountryCode = "";
  selectedCountryName = "";
  setCountryPill();
  setBigMapSelected("");
};

function setBigMapSelected(code){
  if (!map || !map.getLayer('country-selected')) return;
  map.setFilter('country-selected', ['==', ['get', 'iso_3166_1'], code || '']);
}

function updateMiniMapSelected(countryCode){
  if (!miniMap || !miniMap.getLayer('mini-country-selected')) return;
  miniMap.setFilter('mini-country-selected', ['==', ['get', 'iso_3166_1'], countryCode || '']);

  if (!countryCode) return;
  const feats = miniMap.querySourceFeatures('miniCountryBoundaries', {
    sourceLayer: 'country_boundaries',
    filter: ['==', ['get', 'iso_3166_1'], countryCode]
  });
  if (!feats || !feats.length) return;

  let minX=180, minY=90, maxX=-180, maxY=-90;
  const geom = feats[0].geometry;

  function scan(coords){
    if (typeof coords[0] === 'number'){
      const x=coords[0], y=coords[1];
      minX=Math.min(minX,x); maxX=Math.max(maxX,x);
      minY=Math.min(minY,y); maxY=Math.max(maxY,y);
      return;
    }
    for (const c of coords) scan(c);
  }
  scan(geom.coordinates);
  miniMap.fitBounds([[minX,minY],[maxX,maxY]], { padding:18, duration:300 });
}

function initMaps(){
  map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/light-v11',
    center: [10, 20],
    zoom: 1.2
  });

  map.on('load', () => {
    map.addSource('countryBoundaries', { type:'vector', url:'mapbox://mapbox.country-boundaries-v1' });

    map.addLayer({
      id: 'country-fill',
      type: 'fill',
      source: 'countryBoundaries',
      'source-layer': 'country_boundaries',
      paint: { 'fill-color': '#000', 'fill-opacity': 0.05 }
    });

    map.addLayer({
      id: 'country-selected',
      type: 'fill',
      source: 'countryBoundaries',
      'source-layer': 'country_boundaries',
      paint: { 'fill-color': '#000', 'fill-opacity': 0.18 },
      filter: ['==', ['get', 'iso_3166_1'], '']
    });

    let hoveredISO = "";
    map.addLayer({
      id: 'country-hover',
      type: 'fill',
      source: 'countryBoundaries',
      'source-layer': 'country_boundaries',
      paint: { 'fill-color': '#000', 'fill-opacity': 0.12 },
      filter: ['==', ['get', 'iso_3166_1'], '']
    });

    map.on('mousemove','country-fill',(e)=>{
      const iso = e.features?.[0]?.properties?.iso_3166_1 || "";
      if (iso !== hoveredISO){
        hoveredISO = iso;
        map.setFilter('country-hover', ['==', ['get', 'iso_3166_1'], hoveredISO]);
      }
      map.getCanvas().style.cursor='pointer';
    });

    map.on('mouseleave','country-fill',()=>{
      hoveredISO="";
      map.setFilter('country-hover', ['==', ['get', 'iso_3166_1'], '']);
      map.getCanvas().style.cursor='';
    });

    map.on('click','country-fill', async (e)=>{
      const iso = e.features?.[0]?.properties?.iso_3166_1 || "";
      if (!iso) return;
      setBigMapSelected(iso);
      await selectCountry(iso);
    });
  });

  miniMap = new mapboxgl.Map({
    container: 'mini-map',
    style: 'mapbox://styles/mapbox/light-v11',
    center: [10,20],
    zoom: 0.6,
    interactive: false
  });

  miniMap.on('load', () => {
    miniMap.addSource('miniCountryBoundaries', { type:'vector', url:'mapbox://mapbox.country-boundaries-v1' });

    miniMap.addLayer({
      id: 'mini-country-fill',
      type: 'fill',
      source: 'miniCountryBoundaries',
      'source-layer': 'country_boundaries',
      paint: { 'fill-color': '#000', 'fill-opacity': 0.05 }
    });

    miniMap.addLayer({
      id: 'mini-country-selected',
      type: 'fill',
      source: 'miniCountryBoundaries',
      'source-layer': 'country_boundaries',
      paint: { 'fill-color': '#000', 'fill-opacity': 0.25 },
      filter: ['==', ['get', 'iso_3166_1'], '']
    });

    miniMap.addLayer({
      id: 'mini-country-line',
      type: 'line',
      source: 'miniCountryBoundaries',
      'source-layer': 'country_boundaries',
      paint: { 'line-color': '#000', 'line-width': 1, 'line-opacity': 0.2 }
    });
  });
}

/* ================== INIT ================== */
(async function init(){
  currentLang = getBrowserLang();
  applyI18n();

  countrySubtitle.textContent = t('chooseCountry');
  showScreen("HOME");

  await loadCountries();
  await loadEventsCache();
  await refreshAuthPill();

  initMaps();
  await loadTop3();
})();
</script>

</body>
</html>
