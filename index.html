<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<title>People can a Vote</title>

<link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet"/>

<style>
  body { margin:0; font-family:Arial, sans-serif; background:#f4f6f8; }
  header { background:#fff; padding:20px; box-shadow:0 2px 4px rgba(0,0,0,.1); position:sticky; top:0; z-index:10; }
  header h1 { margin:0 0 6px 0; }
  header .muted { color:#666; margin:0; }
  .wrap { max-width:1100px; margin:0 auto; }
  .card { background:#fff; padding:16px; border-radius:10px; margin:16px; position:relative; }
  .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
  input, select { padding:10px; min-width:240px; }
  button { padding:10px 14px; cursor:pointer; border:0; border-radius:8px; }
  button.primary { background:#111; color:#fff; }
  button.ghost { background:#eee; }
  .muted { color:#666; }
  .event { background:#fff; padding:14px; border-radius:10px; margin:10px 16px; cursor:pointer; border:1px solid #eee; }
  .event:hover { border-color:#ddd; }
  .event small { color:#666; display:block; margin-top:6px; }
  #map { height:460px; margin:16px; border-radius:12px; overflow:hidden; }
  .pill { background:#f1f1f1; padding:6px 10px; border-radius:999px; font-size:12px; }
  .barWrap { margin:10px 0 14px; }
  .barRow { display:flex; align-items:center; gap:10px; margin:8px 0; }
  .barLabel { width:140px; font-size:14px; }
  .barOuter { flex:1; background:#eee; border-radius:999px; overflow:hidden; height:14px; }
  .barInner { height:100%; width:0%; }
  .barValue { width:150px; text-align:right; font-size:13px; color:#333; }
  .sectionTitle { margin:0 0 10px 0; }
  .hint { font-size:13px; color:#666; margin-top:10px; }
  .topGrid { display:grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap:12px; }
  @media (max-width: 900px) { .topGrid { grid-template-columns: 1fr; } }
  .topCard { border:1px solid #eee; border-radius:12px; padding:14px; cursor:pointer; }
  .topCard:hover { border-color:#ddd; }
  .topCount { font-size:12px; color:#666; margin-top:8px; }

  /* mini map */
  #mini-map-wrap{
    position:absolute;
    right:12px;
    bottom:12px;
    width:220px;
    height:160px;
    border-radius:12px;
    overflow:hidden;
    border:1px solid #eee;
    box-shadow:0 6px 14px rgba(0,0,0,.08);
    background:#fafafa;
  }
  #mini-map{
    width:100%;
    height:100%;
  }
  #mini-badge{
    position:absolute;
    left:10px;
    top:10px;
    background:rgba(255,255,255,.92);
    border:1px solid #eee;
    padding:6px 10px;
    border-radius:999px;
    font-size:12px;
    color:#333;
  }

  /* space for mini map on small screens */
  @media (max-width: 700px){
    #mini-map-wrap{ position:relative; right:auto; bottom:auto; width:100%; height:200px; margin-top:12px; }
  }
</style>
</head>

<body>

<header>
  <div class="wrap">
    <h1>People can a Vote</h1>
    <p class="muted">Global view of opinions from around the world</p>
  </div>
</header>

<div class="wrap">

  <!-- AUTH -->
  <section class="card" id="auth">
    <div id="auth-forms">
      <h3 class="sectionTitle">Přihlášení / Registrace</h3>
      <div class="row">
        <input id="email" type="email" placeholder="Email">
        <input id="password" type="password" placeholder="Heslo">
        <select id="country-select">
          <option value="">Načítám země…</option>
        </select>
      </div>
      <div class="row" style="margin-top:10px;">
        <button class="primary" id="signup-btn">Registrovat</button>
        <button class="ghost" id="login-btn">Přihlásit</button>
      </div>
      <p id="auth-error" style="color:#b00020; margin:10px 0 0;"></p>
      <p class="hint">Pozn.: země je povinná jen při registraci. Při přihlášení se ignoruje.</p>
    </div>

    <div id="auth-logged" style="display:none;">
      <div class="row">
        <strong id="auth-message"></strong>
        <span class="pill" id="auth-country"></span>
        <button class="ghost" id="logout-btn">Odhlásit</button>
      </div>
      <p id="auth-hint" class="hint"></p>
    </div>
  </section>

  <!-- TOP 3 -->
  <section class="card">
    <div class="row" style="justify-content:space-between;">
      <div>
        <h3 class="sectionTitle">TOP 3 události (globálně)</h3>
        <div class="muted">Události s největším počtem hlasů.</div>
      </div>
      <button class="ghost" id="refresh-top">Obnovit</button>
    </div>
    <div id="top3" class="topGrid">
      <div class="muted">Načítám…</div>
    </div>
  </section>

  <!-- MAP + FILTER -->
  <section class="card">
    <div class="row" style="justify-content:space-between;">
      <div>
        <h3 class="sectionTitle">Mapa</h3>
        <div class="muted">Klikni na zemi na mapě, nebo vyber zemi v seznamu.</div>
      </div>
      <div class="row">
        <span class="pill" id="selected-country-pill">Země: (vše)</span>
        <button class="ghost" id="clear-country">Zrušit filtr</button>
      </div>
    </div>
    <div id="map"></div>

    <div class="row" style="margin-top:10px;">
      <select id="country-filter">
        <option value="">Všechny země</option>
      </select>
      <span class="muted">Filtrovat události podle země</span>
    </div>
  </section>

  <!-- EVENTS -->
  <section>
    <h2 style="margin:0 16px;">Události</h2>
    <div id="events"></div>
  </section>

  <!-- VOTE -->
  <section class="card" id="vote-card">
    <h3 class="sectionTitle" id="vote-title">Vyber událost</h3>
    <div class="muted" id="vote-subtitle"></div>

    <div id="vote-buttons" style="display:none; margin-top:12px;">
      <div class="row">
        <button class="primary" id="vote-yes">Ano</button>
        <button class="primary" id="vote-no">Ne</button>
        <button class="primary" id="vote-neutral">Nemám názor</button>
      </div>
    </div>

    <p id="vote-message" style="margin:12px 0 0;"></p>

    <!-- MINI MAP -->
    <div id="mini-map-wrap">
      <div id="mini-map"></div>
      <div id="mini-badge">Země události: —</div>
    </div>
  </section>

  <!-- STATS -->
  <section class="card">
    <h3 class="sectionTitle">Statistiky</h3>
    <div id="vote-stats" class="muted">Vyber událost.</div>
  </section>

</div>

<script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<script>
/* ================== KONFIG ================== */
const supabaseClient = supabase.createClient(
  'https://jqoomnhpyuikbntnrukw.supabase.co',
  'sb_publishable_SjZ_HQWN0XRE9ebbf_OwQg_kmJeS43h'
);

mapboxgl.accessToken =
  'pk.eyJ1IjoiaGVyZ290dCIsImEiOiJjbWttdHQ3cmYwZ2hmM2pyMjd2bmk1c3ZmIn0.-9CViuw1h3-gy49EsKvFiQ';

/* ================== STAV ================== */
let currentEventId = null;
let currentEventCountryCode = null;
let currentUserCountryCode = null;
let selectedCountryCode = "";

/* ================== ELEMENTY ================== */
const voteButtons = document.getElementById('vote-buttons');
const voteMessage = document.getElementById('vote-message');
const voteStats = document.getElementById('vote-stats');
const voteTitle = document.getElementById('vote-title');
const voteSubtitle = document.getElementById('vote-subtitle');

const authForms = document.getElementById('auth-forms');
const authLogged = document.getElementById('auth-logged');
const authMessage = document.getElementById('auth-message');
const authCountry = document.getElementById('auth-country');
const authHint = document.getElementById('auth-hint');
const authError = document.getElementById('auth-error');

const email = document.getElementById('email');
const password = document.getElementById('password');
const countrySelect = document.getElementById('country-select');

const countryFilter = document.getElementById('country-filter');
const selectedCountryPill = document.getElementById('selected-country-pill');
const clearCountryBtn = document.getElementById('clear-country');

const top3Div = document.getElementById('top3');

const miniBadge = document.getElementById('mini-badge');

voteButtons.style.display = 'none';

/* ================== POMOCNÉ ================== */
function setAuthError(msg){ authError.textContent = msg || ""; }
function setVoteMessage(msg){ voteMessage.textContent = msg || ""; }
function safePct(part, total){ return total ? Math.round((part/total)*100) : 0; }
function setSelectedCountryUI(code, nameMaybe){
  const label = code ? `Země: ${nameMaybe ? nameMaybe + ' ' : ''}(${code})` : "Země: (vše)";
  selectedCountryPill.textContent = label;
}
function cleanCountryLabel(optionText){
  return (optionText || "").replace(/\s*\(.+\)\s*$/, '').trim();
}

/* ================== NAČTI ZEMĚ ================== */
async function loadCountries() {
  const { data, error } = await supabaseClient
    .from('countries')
    .select('code, name')
    .order('name', { ascending: true });

  if (error) {
    countrySelect.innerHTML = '<option value="">Země nelze načíst</option>';
    return [];
  }

  countrySelect.innerHTML = ['<option value="">Vyber zemi (pro registraci)</option>']
    .concat(data.map(c => `<option value="${c.code}">${c.name} (${c.code})</option>`))
    .join('');

  countryFilter.innerHTML = ['<option value="">Všechny země</option>']
    .concat(data.map(c => `<option value="${c.code}">${c.name} (${c.code})</option>`))
    .join('');

  return data;
}

/* ================== PROFILES ================== */
async function loadMyProfile() {
  currentUserCountryCode = null;
  const { data: sess } = await supabaseClient.auth.getSession();
  const user = sess.session?.user;
  if (!user) return;

  const { data, error } = await supabaseClient
    .from('profiles')
    .select('country_code')
    .eq('id', user.id)
    .maybeSingle();

  if (!error && data?.country_code) currentUserCountryCode = data.country_code;
}

/* ================== AUTH ================== */
document.getElementById('login-btn').onclick = async () => {
  setAuthError("");
  const { error } = await supabaseClient.auth.signInWithPassword({
    email: email.value,
    password: password.value
  });
  if (error) setAuthError(error.message);
};

document.getElementById('signup-btn').onclick = async () => {
  setAuthError("");
  const selected = countrySelect.value;
  if (!selected) { setAuthError("Při registraci vyber svoji zemi."); return; }

  const { error: signUpErr } = await supabaseClient.auth.signUp({
    email: email.value,
    password: password.value
  });
  if (signUpErr) { setAuthError(signUpErr.message); return; }

  const { error: signInErr } = await supabaseClient.auth.signInWithPassword({
    email: email.value,
    password: password.value
  });
  if (signInErr) {
    setAuthError(signInErr.message);
    authHint.textContent = "Pokud máš zapnuté potvrzení emailu, musíš nejdřív potvrdit registraci.";
    return;
  }

  const { data: sess } = await supabaseClient.auth.getSession();
  const user = sess.session?.user;
  if (!user) return;

  const { error: profErr } = await supabaseClient
    .from('profiles')
    .insert([{ id: user.id, country_code: selected }]);

  if (profErr && profErr.code !== '23505') setAuthError(profErr.message);
};

document.getElementById('logout-btn').onclick = async () => {
  await supabaseClient.auth.signOut();
};

supabaseClient.auth.onAuthStateChange(async () => {
  await updateAuthUI();
  if (currentEventId) await refreshVoteAndStats();
});

async function updateAuthUI() {
  const { data } = await supabaseClient.auth.getSession();
  const user = data.session?.user;

  if (user) {
    authForms.style.display = "none";
    authLogged.style.display = "block";
    authMessage.textContent = `Přihlášen jako: ${user.email}`;
    authHint.textContent = "";
    await loadMyProfile();
    authCountry.textContent = currentUserCountryCode ? `Země: ${currentUserCountryCode}` : "Země: (nenastavena)";
  } else {
    authForms.style.display = "block";
    authLogged.style.display = "none";
    authMessage.textContent = "";
    authCountry.textContent = "";
    authHint.textContent = "";
    currentUserCountryCode = null;

    voteButtons.style.display = "none";
    setVoteMessage("");
  }
}

/* ================== TOP 3 (GLOBÁLNĚ) ================== */
async function loadTop3Global() {
  top3Div.innerHTML = '<div class="muted">Načítám…</div>';

  const { data: votes, error: vErr } = await supabaseClient
    .from('votes')
    .select('event_id');

  if (vErr) { top3Div.innerHTML = '<div class="muted">Nelze načíst TOP události.</div>'; return; }

  const counts = new Map();
  for (const v of (votes || [])) counts.set(v.event_id, (counts.get(v.event_id) || 0) + 1);

  if (counts.size === 0) { top3Div.innerHTML = '<div class="muted">Zatím žádné hlasy.</div>'; return; }

  const top = [...counts.entries()].sort((a,b) => b[1] - a[1]).slice(0, 3);
  const ids = top.map(t => t[0]);

  const { data: evs, error: eErr } = await supabaseClient
    .from('events')
    .select('id, title, description, country_code')
    .in('id', ids);

  if (eErr) { top3Div.innerHTML = '<div class="muted">Nelze načíst detail TOP událostí.</div>'; return; }

  const byId = new Map((evs || []).map(e => [e.id, e]));
  const cards = [];

  for (const [id, cnt] of top) {
    const e = byId.get(id);
    if (!e) continue;
    cards.push(`
      <div class="topCard" data-event-id="${e.id}">
        <strong>${e.title}</strong>
        <div class="muted" style="margin-top:6px;">${e.description || ""}</div>
        <div class="topCount">Hlasů: <strong>${cnt}</strong> • Země: ${e.country_code || "?"}</div>
      </div>
    `);
  }

  top3Div.innerHTML = cards.join('');
  for (const el of top3Div.querySelectorAll('.topCard')) {
    el.addEventListener('click', async () => {
      const eventId = Number(el.getAttribute('data-event-id'));
      await openEventFromTop(eventId);
    });
  }
}
document.getElementById('refresh-top').onclick = loadTop3Global;

async function openEventFromTop(eventId) {
  const { data: evt, error } = await supabaseClient
    .from('events')
    .select('id, country_code')
    .eq('id', eventId)
    .maybeSingle();

  if (error || !evt) return;

  selectedCountryCode = evt.country_code || "";
  countryFilter.value = selectedCountryCode;

  const label = countryFilter.options[countryFilter.selectedIndex]?.text || selectedCountryCode;
  setSelectedCountryUI(selectedCountryCode, cleanCountryLabel(label));

  await loadEventsList();

  currentEventId = eventId;
  currentEventCountryCode = evt.country_code;

  document.getElementById('vote-card').scrollIntoView({ behavior: 'smooth', block: 'start' });
  await refreshVoteAndStats();
}

/* ================== EVENTS LIST ================== */
async function loadEventsList() {
  const eventsDiv = document.getElementById('events');
  eventsDiv.innerHTML = "";

  let q = supabaseClient
    .from('events')
    .select('id, title, description, country_code, created_at')
    .eq('is_active', true);

  if (selectedCountryCode) q = q.eq('country_code', selectedCountryCode);

  const { data, error } = await q.order('created_at', { ascending: false });

  if (error) {
    eventsDiv.innerHTML = '<div class="muted" style="margin:0 16px;">Nelze načíst události.</div>';
    return;
  }

  if (!data.length) {
    eventsDiv.innerHTML = '<div class="muted" style="margin:0 16px;">Žádné aktivní události pro tento filtr.</div>';
    currentEventId = null;
    voteTitle.textContent = "Vyber událost";
    voteSubtitle.textContent = "";
    voteButtons.style.display = "none";
    voteStats.textContent = "Vyber událost.";
    miniBadge.textContent = "Země události: —";
    updateMiniMapSelected("");
    return;
  }

  currentEventId = data[0].id;
  currentEventCountryCode = data[0].country_code;

  for (const e of data) {
    const div = document.createElement('div');
    div.className = 'event';
    div.innerHTML = `<strong>${e.title}</strong><small>${e.description || ""}</small>`;
    div.onclick = async () => {
      currentEventId = e.id;
      currentEventCountryCode = e.country_code;
      await refreshVoteAndStats();
      document.getElementById('vote-card').scrollIntoView({ behavior: 'smooth', block: 'start' });
    };
    eventsDiv.appendChild(div);
  }

  await refreshVoteAndStats();
}

/* ================== VOTE + STATS ================== */
async function refreshVoteAndStats() {
  voteButtons.style.display = "none";
  setVoteMessage("");

  if (!currentEventId) return;

  const { data: evt, error: evtErr } = await supabaseClient
    .from('events')
    .select('id, title, description, country_code')
    .eq('id', currentEventId)
    .maybeSingle();

  if (evtErr || !evt) return;

  currentEventCountryCode = evt.country_code;
  voteTitle.textContent = evt.title || "Hlasování";
  voteSubtitle.textContent = evt.description || "";

  // update mini map
  const cc = currentEventCountryCode || "";
  miniBadge.textContent = cc ? `Země události: ${cc}` : "Země události: —";
  updateMiniMapSelected(cc);

  await loadVoteStats(currentEventId, currentEventCountryCode);

  const { data: sess } = await supabaseClient.auth.getSession();
  const user = sess.session?.user;
  if (!user) {
    setVoteMessage("Pro hlasování se přihlas.");
    return;
  }

  if (!currentUserCountryCode) await loadMyProfile();

  const { data: existing } = await supabaseClient
    .from('votes')
    .select('vote')
    .eq('user_id', user.id)
    .eq('event_id', currentEventId)
    .maybeSingle();

  if (existing) {
    setVoteMessage(`Už jste hlasoval (${existing.vote}).`);
    voteButtons.style.display = "none";
  } else {
    voteButtons.style.display = "block";
  }
}

async function submitVote(value) {
  setVoteMessage("");

  const { data: sess } = await supabaseClient.auth.getSession();
  const user = sess.session?.user;
  if (!user) { setVoteMessage("Musíš být přihlášen."); return; }

  if (!currentUserCountryCode) await loadMyProfile();
  if (!currentUserCountryCode) { setVoteMessage("Nemáš nastavenou zemi v profilu."); return; }

  const { error } = await supabaseClient
    .from('votes')
    .insert({
      user_id: user.id,
      event_id: currentEventId,
      vote: value,
      country_code: currentUserCountryCode
    });

  if (error) {
    if (error.code === "23505") {
      setVoteMessage("Už jste hlasoval pro tuto událost.");
      voteButtons.style.display = "none";
    } else {
      setVoteMessage(error.message);
    }
    return;
  }

  voteButtons.style.display = "none";
  setVoteMessage("Hlas uložen.");
  await loadTop3Global();
  await refreshVoteAndStats();
}

document.getElementById('vote-yes').onclick = () => submitVote('Ano');
document.getElementById('vote-no').onclick = () => submitVote('Ne');
document.getElementById('vote-neutral').onclick = () => submitVote('Nemám názor');

function barHTML(label, count, total) {
  const pct = safePct(count, total);
  return `
    <div class="barRow">
      <div class="barLabel">${label}</div>
      <div class="barOuter"><div class="barInner" style="width:${pct}%; background:#111;"></div></div>
      <div class="barValue">${count} (${pct}%)</div>
    </div>
  `;
}

async function loadVoteStats(eventId, eventCountryCode) {
  const { data, error } = await supabaseClient
    .from('votes')
    .select('vote, country_code')
    .eq('event_id', eventId);

  if (error) { voteStats.textContent = "Nelze načíst statistiky."; return; }

  const total = data.length;

  const yes = data.filter(v => v.vote === 'Ano').length;
  const no = data.filter(v => v.vote === 'Ne').length;
  const neutral = data.filter(v => v.vote === 'Nemám názor').length;

  const citizens = eventCountryCode ? data.filter(v => v.country_code === eventCountryCode) : [];
  const others = eventCountryCode ? data.filter(v => v.country_code !== eventCountryCode) : data;

  const cTotal = citizens.length;
  const oTotal = others.length;

  const cYes = citizens.filter(v => v.vote === 'Ano').length;
  const cNo = citizens.filter(v => v.vote === 'Ne').length;
  const cNeutral = citizens.filter(v => v.vote === 'Nemám názor').length;

  const oYes = others.filter(v => v.vote === 'Ano').length;
  const oNo = others.filter(v => v.vote === 'Ne').length;
  const oNeutral = others.filter(v => v.vote === 'Nemám názor').length;

  voteStats.innerHTML = `
    <div><strong>Celkem:</strong> ${total} hlasů</div>
    <div class="barWrap">
      ${barHTML('Ano', yes, total)}
      ${barHTML('Ne', no, total)}
      ${barHTML('Nemám názor', neutral, total)}
    </div>

    <div style="margin-top:10px;"><strong>Občané země události</strong> ${eventCountryCode ? `(${eventCountryCode})` : ''}: ${cTotal} hlasů</div>
    <div class="barWrap">
      ${barHTML('Ano', cYes, cTotal)}
      ${barHTML('Ne', cNo, cTotal)}
      ${barHTML('Nemám názor', cNeutral, cTotal)}
    </div>

    <div style="margin-top:10px;"><strong>Ostatní státy:</strong> ${oTotal} hlasů</div>
    <div class="barWrap">
      ${barHTML('Ano', oYes, oTotal)}
      ${barHTML('Ne', oNo, oTotal)}
      ${barHTML('Nemám názor', oNeutral, oTotal)}
    </div>
  `;
}

/* ================== FILTER UI ================== */
countryFilter.onchange = async () => {
  selectedCountryCode = countryFilter.value || "";
  const name = countryFilter.options[countryFilter.selectedIndex]?.text || "";
  setSelectedCountryUI(selectedCountryCode, cleanCountryLabel(name));
  await loadEventsList();
};

clearCountryBtn.onclick = async () => {
  selectedCountryCode = "";
  countryFilter.value = "";
  setSelectedCountryUI("", "");
  await loadEventsList();
};

/* ================== MAPBOX (BIG MAP) ================== */
const map = new mapboxgl.Map({
  container: 'map',
  style: 'mapbox://styles/mapbox/light-v11',
  center: [10, 20],
  zoom: 1.2
});

map.on('load', () => {
  map.addSource('countryBoundaries', { type: 'vector', url: 'mapbox://mapbox.country-boundaries-v1' });

  map.addLayer({
    id: 'country-fill',
    type: 'fill',
    source: 'countryBoundaries',
    'source-layer': 'country_boundaries',
    paint: { 'fill-color': '#000', 'fill-opacity': 0.05 }
  });

  map.addLayer({
    id: 'country-line',
    type: 'line',
    source: 'countryBoundaries',
    'source-layer': 'country_boundaries',
    paint: { 'line-color': '#000', 'line-width': 1, 'line-opacity': 0.15 }
  });

  map.addLayer({
    id: 'country-hover',
    type: 'fill',
    source: 'countryBoundaries',
    'source-layer': 'country_boundaries',
    paint: { 'fill-color': '#000', 'fill-opacity': 0.12 },
    filter: ['==', ['get', 'iso_3166_1'], '']
  });

  map.addLayer({
    id: 'country-selected',
    type: 'fill',
    source: 'countryBoundaries',
    'source-layer': 'country_boundaries',
    paint: { 'fill-color': '#000', 'fill-opacity': 0.18 },
    filter: ['==', ['get', 'iso_3166_1'], '']
  });

  let hoveredISO = "";

  map.on('mousemove', 'country-fill', (e) => {
    const iso = e.features?.[0]?.properties?.iso_3166_1 || "";
    if (iso !== hoveredISO) {
      hoveredISO = iso;
      map.setFilter('country-hover', ['==', ['get', 'iso_3166_1'], hoveredISO]);
    }
    map.getCanvas().style.cursor = 'pointer';
  });

  map.on('mouseleave', 'country-fill', () => {
    hoveredISO = "";
    map.setFilter('country-hover', ['==', ['get', 'iso_3166_1'], '']);
    map.getCanvas().style.cursor = '';
  });

  map.on('click', 'country-fill', async (e) => {
    const iso = e.features?.[0]?.properties?.iso_3166_1 || "";
    if (!iso) return;

    selectedCountryCode = iso;
    countryFilter.value = iso;

    map.setFilter('country-selected', ['==', ['get', 'iso_3166_1'], iso]);

    const label = countryFilter.options[countryFilter.selectedIndex]?.text || iso;
    setSelectedCountryUI(iso, cleanCountryLabel(label));

    await loadEventsList();
  });
});

/* ================== MINI MAP ================== */
const miniMap = new mapboxgl.Map({
  container: 'mini-map',
  style: 'mapbox://styles/mapbox/light-v11',
  center: [10, 20],
  zoom: 0.6,
  interactive: false
});

miniMap.on('load', () => {
  miniMap.addSource('miniCountryBoundaries', { type: 'vector', url: 'mapbox://mapbox.country-boundaries-v1' });

  miniMap.addLayer({
    id: 'mini-country-fill',
    type: 'fill',
    source: 'miniCountryBoundaries',
    'source-layer': 'country_boundaries',
    paint: { 'fill-color': '#000', 'fill-opacity': 0.05 }
  });

  miniMap.addLayer({
    id: 'mini-country-selected',
    type: 'fill',
    source: 'miniCountryBoundaries',
    'source-layer': 'country_boundaries',
    paint: { 'fill-color': '#000', 'fill-opacity': 0.25 },
    filter: ['==', ['get', 'iso_3166_1'], '']
  });

  miniMap.addLayer({
    id: 'mini-country-line',
    type: 'line',
    source: 'miniCountryBoundaries',
    'source-layer': 'country_boundaries',
    paint: { 'line-color': '#000', 'line-width': 1, 'line-opacity': 0.2 }
  });
});

function updateMiniMapSelected(countryCode){
  if (!miniMap || !miniMap.getLayer('mini-country-selected')) return;
  miniMap.setFilter('mini-country-selected', ['==', ['get', 'iso_3166_1'], countryCode || '']);

  // Jemné přiblížení/centrování: použijeme query na feature a fitBounds
  if (!countryCode) return;

  const features = miniMap.querySourceFeatures('miniCountryBoundaries', {
    sourceLayer: 'country_boundaries',
    filter: ['==', ['get', 'iso_3166_1'], countryCode]
  });

  if (!features || !features.length) return;

  // vypočítat bbox
  let minX = 180, minY = 90, maxX = -180, maxY = -90;
  const geom = features[0].geometry;

  function scanCoords(coords){
    if (typeof coords[0] === 'number') {
      const x = coords[0], y = coords[1];
      minX = Math.min(minX, x); maxX = Math.max(maxX, x);
      minY = Math.min(minY, y); maxY = Math.max(maxY, y);
      return;
    }
    for (const c of coords) scanCoords(c);
  }
  scanCoords(geom.coordinates);

  miniMap.fitBounds([[minX, minY],[maxX, maxY]], { padding: 18, duration: 300 });
}

/* ================== INIT ================== */
(async function init(){
  await loadCountries();
  setSelectedCountryUI("", "");
  await updateAuthUI();
  await loadEventsList();
  await loadTop3Global();
})();
</script>

</body>
</html>
