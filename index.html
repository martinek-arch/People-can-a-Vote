<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>People can a Vote</title>

<link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet"/>

<style>
  body { margin:0; font-family: Arial, sans-serif; background:#f4f6f8; }
  .wrap { max-width:1100px; margin:0 auto; }
  header { background:#fff; box-shadow:0 2px 4px rgba(0,0,0,.08); position:sticky; top:0; z-index:30; }
  .nav { display:flex; align-items:center; justify-content:space-between; gap:12px; padding:12px 16px; }
  .nav-left, .nav-right { display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
  .brand { display:flex; flex-direction:column; }
  .brand h1 { margin:0; font-size:18px; }
  .brand .muted { margin:2px 0 0; font-size:12px; color:#666; }

  button { padding:8px 12px; border:0; border-radius:10px; cursor:pointer; }
  button.ghost { background:#eee; }
  button.primary { background:#111; color:#fff; }
  button:disabled { opacity:.5; cursor:not-allowed; }

  input { padding:9px 10px; border-radius:10px; border:1px solid #ddd; min-width:260px; }
  .pill { background:#f1f1f1; padding:6px 10px; border-radius:999px; font-size:12px; color:#333; }
  .card { background:#fff; padding:16px; border-radius:12px; margin:16px; }
  .muted { color:#666; }

  .errorText{ color:#b00020 !important; }
  .okText{ color:#0b6b2e !important; }

  .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }

  /* Continent bar */
  #continentsBarWrap { padding:6px 16px; }
  #continentsBar {
    display:flex; gap:8px; flex-wrap:wrap; align-items:center;
    background:#fff; border:1px solid #eee; border-radius:12px; padding:8px 10px;
  }
  #continentsBar button { padding:6px 10px; font-size:13px; }

  /* Search suggest */
  .searchWrap { position:relative; }
  #searchSuggest{
    position:absolute; top:42px; left:0; right:0;
    background:#fff; border:1px solid #ddd; border-radius:12px;
    display:none; max-height:320px; overflow:auto;
    box-shadow:0 10px 25px rgba(0,0,0,.12);
    z-index:50;
  }
  .sItem { padding:10px 12px; cursor:pointer; border-top:1px solid #f1f1f1; display:flex; justify-content:space-between; gap:10px; }
  .sItem:first-child{ border-top:none; }
  .sItem:hover{ background:#f6f6f6; }
  .sLeft { display:flex; flex-direction:column; gap:2px; }
  .sTitle { font-weight:600; }
  .sSub { font-size:12px; color:#666; }
  .tag { font-size:11px; color:#555; background:#f1f1f1; padding:4px 8px; border-radius:999px; white-space:nowrap; align-self:flex-start; }


  .countryChip{
    padding:6px 10px;
    border-radius:999px;
    border:1px solid #e6e6e6;
    background:#fafafa;
    cursor:pointer;
    font-size:13px;
  }
  .countryChip:hover{ border-color:#cfcfcf; background:#f3f3f3; }
  .countryChip.active{ background:#e9e9e9; border-color:#bdbdbd; }


  /* Screens */
  .screen { display:none; }
  .screen.active { display:block; }

  #map { height:460px; border-radius:12px; overflow:hidden; }

  .eventItem { background:#fff; border:1px solid #eee; border-radius:12px; padding:14px; margin:10px 16px; cursor:pointer; }
  .eventItem:hover { border-color:#ddd; }

  .topItem{ background:#fff;border:1px solid #eee;border-radius:12px;padding:12px;margin:10px 0;cursor:pointer; }
  .topItem:hover{ border-color:#ddd; }
  .topMeta{ font-size:12px;color:#666;margin-top:4px; }

  .eventItem small { display:block; color:#666; margin-top:6px; }

  .titleRow { display:flex; align-items:center; gap:10px; flex-wrap:wrap; }

  .barWrap{ margin:10px 0 14px; }
  .barRow{ display:flex; align-items:center; gap:10px; margin:8px 0; }
  .barLabel{ width:170px; font-size:14px; }
  .barOuter{ flex:1; background:#eee; border-radius:999px; overflow:hidden; height:14px; }
  .barInner{ height:100%; width:0%; background:#111; }
  .barValue{ width:170px; text-align:right; font-size:13px; color:#333; }

  .bars-large .barOuter{ height:18px; }
  .bars-large .barLabel{ font-weight:600; }
  .bars-medium .barOuter{ height:14px; }
  .bars-small .barOuter{ height:10px; opacity:0.9; }
  .bars-small .barLabel{ font-size:13px; }
  .bars-small .barValue{ font-size:12px; }

  /* Answer colors */
  .barYes .barInner{ background:#2e7d32; }     /* green */
  .barNo .barInner{ background:#c62828; }      /* red */
  .barNeutral .barInner{ background:#6d6d6d; } /* gray */

  /* Width groups for stats sections */
  .stats-wide{ max-width:100%; }
  .stats-medium{ max-width:85%; }
  .stats-narrow{ max-width:70%; }
  @media (max-width:700px){#miniMap{height:100px;}}



  .backInline { padding:8px 12px; border-radius:10px; background:#eee; }

  @media (max-width: 700px){
    input{ min-width:180px; }
  }
</style>
<script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
</head>

<body>

<header>
  <div class="wrap nav">
    <div class="nav-left">
      <div class="brand">
        <h1>People can a Vote</h1>
        <div class="muted">Global view of opinions from around the world</div>
      </div>
      <button class="ghost" id="homeBtn">Home</button>
    </div>

    <div class="nav-right">
      <div class="searchWrap">
        <input id="search" placeholder="Search country or event‚Ä¶" autocomplete="off" />
        <div id="searchSuggest"></div>
      </div>

      <span class="pill" id="selectedCountryPill">Country: (all)</span>
      <span class="pill" id="selectedContinentPill">Continent: All</span>
    
      <span class="pill" id="authPill">Not signed in</span>
      <button class="ghost" id="loginToggleBtn">Log in</button>
      <button class="ghost" id="registerNavBtn">Register</button>
      <button class="ghost" id="logoutBtn" style="display:none;">Log out</button>

      <select id="langSelect" style="padding:8px 10px;border-radius:10px;border:1px solid #ddd;">
        <option value="en">EN</option>
        <option value="cs">CS</option>
        <option value="es">ES</option>
        <option value="fr">FR</option>
        <option value="de">DE</option>
        <option value="ar">AR</option>
        <option value="ru">RU</option>
        <option value="zh">ZH</option>
      </select>
</div>
  </div>
</header>

<!-- LOGIN PANEL (inline dropdown) -->
<div class="wrap" id="loginPanelWrap" style="padding:0 16px; display:none;">
  <div style="background:#fff;border:1px solid #eee;border-radius:12px;padding:12px 12px; margin-top:10px;">
    <div class="row" style="justify-content:space-between;">
      <strong>Log in</strong>
      <button class="ghost" id="loginCloseBtn" style="padding:6px 10px;">Close</button>
    </div>
    <div class="row" style="margin-top:10px;">
      <input id="loginEmail" type="email" placeholder="Email" style="min-width:240px;">
      <input id="loginPassword" type="password" placeholder="Password" style="min-width:200px;">
      <button class="primary" id="loginBtn">Log in</button>
    </div>
    <div id="loginError" style="color:#b00020; margin-top:10px;"></div>
    <div class="muted" style="margin-top:10px; font-size:12px;">
      New here? Click <strong>Register</strong> in the top bar.
    </div>
  </div>
</div>


</header>

<div class="wrap" id="continentsBarWrap">
  <div id="continentsBar">
    <button class="ghost" data-cont="ALL">üåç All</button>
    <button class="ghost" data-cont="Europe">Europe</button>
    <button class="ghost" data-cont="Asia">Asia</button>
    <button class="ghost" data-cont="Africa">Africa</button>
    <button class="ghost" data-cont="North America">North America</button>
    <button class="ghost" data-cont="South America">South America</button>
    <button class="ghost" data-cont="Oceania">Oceania</button>
  </div>
</div>

<div class="wrap" id="continentCountriesWrap" style="padding:0 16px 10px 16px; display:none;">
  <div style="background:#fff;border:1px solid #eee;border-radius:12px;padding:10px 12px;">
    <div class="row" style="justify-content:space-between;">
      <div>
        <strong id="continentCountriesTitle">Countries</strong>
        <div class="muted" id="continentCountriesSub" style="margin-top:2px;font-size:12px;">Pick a country to see events.</div>
      </div>
      <button class="ghost" id="hideCountriesBtn" style="padding:6px 10px;">Hide</button>
    </div>
    <div id="continentCountriesList" style="margin-top:10px; display:flex; flex-wrap:wrap; gap:8px;"></div>
  </div>
</div>

<div class="wrap">

  <!-- HOME -->
  <section id="screenHome" class="screen active">
    <section class="card">
      <div class="row" style="justify-content:space-between;">
        <div>
          <h3 style="margin:0 0 6px 0;">Top 3 events</h3>
          <div class="muted">Most voted events right now</div>
        </div>
        <button class="ghost" id="refreshTopBtn">Refresh</button>
      </div>
      <div id="top3Box" class="muted" style="margin-top:12px;">Loading‚Ä¶</div>
    </section>

    <section class="card">
      <div class="row" style="justify-content:space-between;">
        <div>
          <h3 style="margin:0 0 6px 0;">Map</h3>
          <div class="muted">Click a country to see its events. Or use search.</div>
        </div>
        <button class="ghost" id="clearCountryBtn">Clear country</button>
      </div>
      <div id="map" style="margin-top:12px;"></div>
    </section>
  </section>

  <!-- COUNTRY -->
  <section id="screenCountry" class="screen">
    <section class="card">
      <div class="titleRow">
        <button class="backInline" id="backFromCountry">‚Üê Back</button>
        <h2 id="countryTitle" style="margin:0;">Events</h2>
      </div>
      <div class="muted" id="countrySubtitle" style="margin-top:8px;"></div>
    </section>
    <div id="eventsList"></div>
  </section>

  <!-- EVENT -->
  <section id="screenEvent" class="screen">
    <section class="card">
      <div class="titleRow">
        <button class="backInline" id="backFromEvent">‚Üê Back</button>
        <h2 id="eventTitle" style="margin:0;">‚Äî</h2>
        <div style="margin-left:auto; width:180px;">
          <div id="miniMap" style="width:100%;height:120px;border-radius:10px;overflow:hidden;border:1px solid #eee;"></div>
        </div>
      </div>
      <div class="muted" id="eventMeta" style="margin-top:8px;"></div>
      <div id="eventDesc" style="margin-top:12px; white-space:pre-wrap;"></div>
    </section>

    
<section class="card">
  <h3 style="margin:0 0 10px 0;">Vote</h3>
  <div id="voteArea">
    <div class="row" id="voteButtonsRow" style="margin-top:6px;">
      <button class="primary" id="voteYesBtn">Yes</button>
      <button class="primary" id="voteNoBtn">No</button>
      <button class="primary" id="voteNeutralBtn">No opinion</button>
    </div>
    <div id="voteMsg" class="muted" style="margin-top:10px;"></div>
  </div>
</section>

<section class="card">
  <h3 style="margin:0 0 10px 0;">Statistics</h3>
  <div id="statsBox" class="muted">Loading‚Ä¶</div>
</section>
</section>


  
  <!-- REGISTER -->
  <section id="screenRegister" class="screen">
    <section class="card">
      <div class="titleRow">
        <button class="backInline" id="backFromRegister">‚Üê Back</button>
        <h2 style="margin:0;">Create account</h2>
      </div>
      <div class="muted" style="margin-top:8px;">
        We‚Äôll send you a verification email. After confirming, you‚Äôll be redirected back here.
      </div>

      <div class="row" style="margin-top:14px;">
        <input id="regEmail" type="email" placeholder="Email" style="min-width:280px;">
        <input id="regPassword" type="password" placeholder="Password" style="min-width:220px;">
      </div>

      <div class="row" style="margin-top:10px;">
        <select id="regCountry" style="min-width:280px;">
          <option value="">Select your country</option>
        </select>
        <select id="regLanguage" style="min-width:220px;">
          <option value="en">English</option>
          <option value="cs">ƒåe≈°tina</option>
          <option value="es">Espa√±ol</option>
          <option value="fr">Fran√ßais</option>
          <option value="de">Deutsch</option>
          <option value="ar">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</option>
          <option value="ru">–†—É—Å—Å–∫–∏–π</option>
          <option value="zh">‰∏≠Êñá</option>
        </select>
      </div>

      <div class="row" style="margin-top:12px;">
        <button class="primary" id="regSubmitBtn">Register</button>
        <button class="ghost" id="regCancelBtn">Cancel</button>
      </div>

      <div id="regError" style="color:#b00020; margin-top:10px;"></div>
      <div class="muted" style="margin-top:10px; font-size:12px;">
        Tip: use a real email ‚Äî verification is required before voting.
      </div>
    </section>
  </section>

  <!-- VERIFIED -->
  <section id="screenVerified" class="screen">
    <section class="card">
      <h2 style="margin:0;">Your account was verified ‚úÖ</h2>
      <div class="muted" style="margin-top:8px;">
        You can now vote. We‚Äôll take you back to the home page automatically.
      </div>
      <div class="row" style="margin-top:14px;">
        <button class="primary" id="verifiedGoHomeBtn">Go to Home</button>
      </div>
    </section>
  </section>


</div>

<script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<script>

/* ===== i18n bootstrap (must be defined before anything calls t()) ===== */
var I18N = (typeof I18N !== "undefined" && I18N) ? I18N : { en: {
    top: "TOP",
    active_events: "Active events",
    ended_events: "Ended events",
    event_closed: "Voting closed",
    ends_on: "Ends on {date}",
    ended_on: "Ended on {date}",} };
var currentLang = (typeof currentLang !== "undefined" && currentLang) ? currentLang : "en";
function t(key, vars){
  if (!vars) vars = {};
  if (!currentLang) currentLang = "en";
  var dict = (I18N && I18N[currentLang]) ? I18N[currentLang] : (I18N ? I18N.en : {});
  var s = (dict && dict[key] != null) ? dict[key] : ((I18N && I18N.en && I18N.en[key] != null) ? I18N.en[key] : key);
  for (var k in vars){
    if (Object.prototype.hasOwnProperty.call(vars, k)){
      s = s.split("{" + k + "}").join(String(vars[k]));
    }
  }
  return s;
}
/* ===== end i18n bootstrap ===== */

// Persist language choice across refresh
function getStoredLang(){
  try{ return localStorage.getItem('pcav_lang') || ''; }catch(e){ return ''; }
}
function setStoredLang(lang){
  try{ localStorage.setItem('pcav_lang', lang); }catch(e){}
}


/* ================== CONFIG ================== */
const supabaseClient = supabase.createClient(
  "https://jqoomnhpyuikbntnrukw.supabase.co",
  "sb_publishable_SjZ_HQWN0XRE9ebbf_OwQg_kmJeS43h"
);

mapboxgl.accessToken = "pk.eyJ1IjoiaGVyZ290dCIsImEiOiJjbWttdHQ3cmYwZ2hmM2pyMjd2bmk1c3ZmIn0.-9CViuw1h3-gy49EsKvFiQ";

/* ================== STATE ================== */
let continentsById = {};   // {id: name}
let countries = [];        // [{code,name,continent_id,continent_name}]
let countriesByCode = {};  // { "US": {...} }
let eventsCache = [];
// Translations cache: { [eventId]: { [lang]: { title, description } } }
let eventTranslations = {};
      // active events for search [{id,title,description,country_code}]
let selectedContinent = "ALL";
let selectedCountryCode = "";
let selectedCountryName = "";
let currentEventId = null;
let currentEventCountryCode = null;
let currentEventEndsAt = null;

/* ================== MINI MAP ================== */
let miniMap = null;
let miniMapLoaded = false;

function initMiniMap(){
  if (miniMapLoaded) return;
  miniMapLoaded = true;

  miniMap = new mapboxgl.Map({
    container: "miniMap",
    style: "mapbox://styles/mapbox/light-v11",
    center: [10, 20],
    zoom: 1.3,
    interactive: false
  });

  miniMap.on("load", () => {
    // Use Mapbox's country boundaries vector tiles (no need for per-country GeoJSON in DB)
    miniMap.addSource("miniCountryBoundaries", {
      type:"vector",
      url:"mapbox://mapbox.country-boundaries-v1"
    });

    // very light base layer for context
    miniMap.addLayer({
      id: "mini-country-base",
      type: "fill",
      source: "miniCountryBoundaries",
      "source-layer": "country_boundaries",
      paint: { "fill-color":"#000", "fill-opacity": 0.04 }
    });

    // selected country highlight
    miniMap.addLayer({
      id: "mini-country-selected",
      type: "fill",
      source: "miniCountryBoundaries",
      "source-layer": "country_boundaries",
      paint: { "fill-color":"#111", "fill-opacity": 0.20 },
      filter: ["==", ["get","iso_3166_1"], "ZZ"]
    });

    // outline for selected
    miniMap.addLayer({
      id: "mini-country-outline",
      type: "line",
      source: "miniCountryBoundaries",
      "source-layer": "country_boundaries",
      paint: { "line-color":"#111", "line-width": 1.5, "line-opacity": 0.70 },
      filter: ["==", ["get","iso_3166_1"], "ZZ"]
    });
  });
}

async function updateMiniMap(countryCode){
  initMiniMap();
  if (!miniMap) return;

  if (!miniMap.isStyleLoaded()){
    await new Promise(resolve => miniMap.once("load", resolve));
  }

  const iso = (countryCode || "ZZ").toUpperCase();

  try{
    miniMap.setFilter("mini-country-selected", ["==", ["get","iso_3166_1"], iso]);
    miniMap.setFilter("mini-country-outline", ["==", ["get","iso_3166_1"], iso]);
  }catch(e){}

  // Zoom roughly to continent of the country for better framing (fast + stable)
  const cont = continentOfCountry(iso);
  const b = CONTINENT_BOUNDS[cont];
  if (b){
    try{ miniMap.fitBounds(b, { padding: 22, duration: 0 }); }catch(e){}
  }else{
    try{ miniMap.easeTo({ center:[10,20], zoom:1.3, duration: 0 }); }catch(e){}
  }
}


/* ================== AUTH (Supabase) ================== */
let currentUser = null;      // supabase user
let currentSession = null;   // session

const authPill = document.getElementById("authPill");
const loginToggleBtn = document.getElementById("loginToggleBtn");
const registerNavBtn = document.getElementById("registerNavBtn");
const logoutBtn = document.getElementById("logoutBtn");

const loginPanelWrap = document.getElementById("loginPanelWrap");
const loginCloseBtn = document.getElementById("loginCloseBtn");
const loginBtn = document.getElementById("loginBtn");
const loginEmail = document.getElementById("loginEmail");
const loginPassword = document.getElementById("loginPassword");
const loginError = document.getElementById("loginError");

const screenRegister = document.getElementById("screenRegister");
const screenVerified = document.getElementById("screenVerified");
const backFromRegister = document.getElementById("backFromRegister");
const regCancelBtn = document.getElementById("regCancelBtn");
const regSubmitBtn = document.getElementById("regSubmitBtn");
const regEmail = document.getElementById("regEmail");
const regPassword = document.getElementById("regPassword");
const regCountry = document.getElementById("regCountry");
const regLanguage = document.getElementById("regLanguage");
const regError = document.getElementById("regError");
const verifiedGoHomeBtn = document.getElementById("verifiedGoHomeBtn");

function safeHideSuggest(){
  try{ if (typeof hideSuggest === "function") hideSuggest(); }catch(e){}
}

function setAuthUI(){
  if (!currentUser){
    authPill.textContent = t("not_signed_in");
    loginToggleBtn.style.display = "inline-block";
    registerNavBtn.style.display = "inline-block";
    logoutBtn.style.display = "none";
  } else {
    authPill.textContent = t("signed_in_as", { email: currentUser.email });
    loginToggleBtn.style.display = "none";
    registerNavBtn.style.display = "none";
    logoutBtn.style.display = "inline-block";
    loginPanelWrap.style.display = "none";
    loginError.textContent = "";
  }
}

function openRegister(){
  loginPanelWrap.style.display = "none";
  safeHideSuggest();
  showScreen("REGISTER");
}



let map;

/* ================== Helpers ================== */
function escapeHtml(s){
  return (s||"").toString()
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;");
}

// ================== Event translations ==================
async function loadEventTranslations(eventIds, langs){
  if (!eventIds || !eventIds.length) return;
  if (!langs || !langs.length) return;

  for (const id of eventIds){
    if (!eventTranslations[id]) eventTranslations[id] = {};
  }

  const { data, error } = await supabaseClient
    .from("event_translations")
    .select("event_id, lang, title, description")
    .in("event_id", eventIds)
    .in("lang", langs);

  if (error){
    console.warn("loadEventTranslations error:", error);
    return;
  }

  for (const row of (data || [])){
    const id = row.event_id;
    if (!eventTranslations[id]) eventTranslations[id] = {};
    eventTranslations[id][row.lang] = {
      title: row.title || "",
      description: row.description || ""
    };
  }
}

function getEventText(evt, field){
  const id = evt?.id;
  if (!id) return (evt?.[field] || "");

function getEventTextSource(evt, field){
  // returns: "cur" | "en" | "orig"
  const id = evt?.id;
  if (!id) return "orig";

  const pack = eventTranslations[id] || {};
  const cur = (pack[currentLang] && pack[currentLang][field]) ? pack[currentLang][field] : "";
  if (cur) return "cur";

  const en = (pack["en"] && pack["en"][field]) ? pack["en"][field] : "";
  if (en) return "en";

  return "orig";
}

function fallbackBadgeHTML(evt){
  // If current language is EN, no need to show fallback badge.
  if ((currentLang || "en") === "en") return "";

  const srcTitle = getEventTextSource(evt, "title");
  const srcDesc  = getEventTextSource(evt, "description");
  const src = (srcTitle === "cur" || srcDesc === "cur") ? "cur" : (srcTitle === "en" || srcDesc === "en") ? "en" : "orig";

  if (src === "cur") return "";
  if (src === "en") return `<span class="pill" style="background:#fff7e6;border-color:#ffe0b2;">EN</span>`;
  return `<span class="pill" style="background:#f5f5f5;border-color:#e0e0e0;">ORIG</span>`;
}

  const pack = eventTranslations[id] || {};
  const cur = (pack[currentLang] && pack[currentLang][field]) ? pack[currentLang][field] : "";
  if (cur) return cur;

  const en = (pack["en"] && pack["en"][field]) ? pack["en"][field] : "";
  if (en) return en;

  return (evt?.[field] || "");
}
function norm(s){
  return (s||"").toString().toLowerCase()
    .normalize("NFD").replace(/[\u0300-\u036f]/g,"").trim();
}


/* ================== i18n ================== */
I18N = I18N = {
  en: {
    brand_sub: "Global view of opinions from around the world",
    home: "Home",
    map_title: "Map",
    map_sub: "Click a country to see its events. Or use search.",
    clear_country: "Clear country",
    top3_title: "Top 3 events",
    top3_sub: "Most voted events right now",
    refresh: "Refresh",
    search_ph: "Search country or event‚Ä¶",
    country_pill_all: t("country_pill_all"),
    continent_pill_all: "Continent: All",
    not_signed_in: "Not signed in",
    signed_in_as: "Signed in as: {email}",
    login: "Log in",
    logout: "Log out",
    register: "Register",
    login_title: "Log in",
    close: "Close",
    email: "Email",
    password: "Password",
    register_title: "Create account",
    register_sub: "We‚Äôll send you a verification email. After confirming, you‚Äôll be redirected back here.",
    select_country: "Select your country",
    cancel: "Cancel",
    verified_title: "Your account was verified ‚úÖ",
    verified_sub: "You can now vote. We‚Äôll take you back to the home page automatically.",
    go_home: "Go to Home",
    back: "‚Üê Back",
    events: "Events",
    loading: "Loading‚Ä¶",
    no_events: "No events for this country yet.",
    vote_title: "Vote",
    vote_yes: "Yes",
    vote_no: "No",
    vote_neutral: "No opinion",
    vote_need_login: "Please log in to vote.",
    vote_need_verify: "Please verify your email to vote.",
    voted_already: "You already voted on this event.",
    voted_saved: "Vote saved ‚úÖ",
    stats_title: "Statistics",
    stats_total_votes: "Total votes:",
    citizens_of: "Citizens of {country} ({code})",
    other_countries: "Other countries",
    location: "Location",
    countries_in: "Countries in {continent}",
    selected_country: "Selected country",
    found_countries: "Found: {n}. Click a country to see its events.",
    pick_country_sub: "Pick a country to see events.",
    back_to_countries: "Click back to choose another country in {continent}.",
  },
  cs: {
    brand_sub: "Glob√°ln√≠ pohled na n√°zory lid√≠ z cel√©ho svƒõta",
    home: "Dom≈Ø",
    map_title: "Mapa",
    map_sub: "Klikni na zemi a zobraz ud√°losti. Nebo pou≈æij vyhled√°v√°n√≠.",
    clear_country: "Zru≈°it zemi",
    top3_title: "TOP 3 ud√°losti",
    top3_sub: "Nejv√≠c hlasovan√© ud√°losti",
    refresh: "Obnovit",
    search_ph: "Hledej zemi nebo ud√°lost‚Ä¶",
    country_pill_all: "Zemƒõ: (v≈°e)",
    continent_pill_all: "Kontinent: V≈°e",
    not_signed_in: "Nep≈ôihl√°≈°en",
    signed_in_as: "P≈ôihl√°≈°en jako: {email}",
    login: "P≈ôihl√°sit",
    logout: "Odhl√°sit",
    register: "Registrace",
    login_title: "P≈ôihl√°≈°en√≠",
    close: "Zav≈ô√≠t",
    email: "Email",
    password: "Heslo",
    register_title: "Vytvo≈ôit √∫ƒçet",
    register_sub: "Po≈°leme ti ovƒõ≈ôovac√≠ email. Po potvrzen√≠ se vr√°t√≠≈° zpƒõt na web.",
    select_country: "Vyber svou zemi",
    cancel: "Zru≈°it",
    verified_title: "√öƒçet byl ovƒõ≈ôen ‚úÖ",
    verified_sub: "Teƒè m≈Ø≈æe≈° hlasovat. Za chv√≠li tƒõ vr√°t√≠me na hlavn√≠ str√°nku.",
    go_home: "Dom≈Ø",
    back: "‚Üê Zpƒõt",
    events: "Ud√°losti",
    loading: "Naƒç√≠t√°m‚Ä¶",
    no_events: "Pro tuto zemi zat√≠m nejsou ud√°losti.",
    vote_title: "Hlasov√°n√≠",
    vote_yes: "Ano",
    vote_no: "Ne",
    vote_neutral: "Nem√°m n√°zor",
    vote_need_login: "Pro hlasov√°n√≠ se pros√≠m p≈ôihlas.",
    vote_need_verify: "Nejd≈ô√≠v ovƒõ≈ô email, abys mohl hlasovat.",
    voted_already: "Pro tuto ud√°lost jste ji≈æ hlasoval.",
    voted_saved: "Hlas byl ulo≈æen ‚úÖ",
    stats_title: "Statistiky",
    stats_total_votes: "Celkem hlas≈Ø:",
    citizens_of: "Obƒçan√© {country} ({code})",
    other_countries: "Ostatn√≠ st√°ty",
    location: "Lokace",
    countries_in: "Zemƒõ v kontinentu {continent}",
    selected_country: "Vybran√° zemƒõ",
    found_countries: "Nalezeno: {n}. Klikni na zemi pro ud√°losti.",
    pick_country_sub: "Vyber zemi pro zobrazen√≠ ud√°lost√≠.",
    back_to_countries: "Klikni na zpƒõt pro v√Ωbƒõr jin√© zemƒõ v {continent}.",
  
    top: "TOP",
    active_events: "Aktivn√≠ ud√°losti",
    ended_events: "Skonƒçen√© ud√°losti",
    event_closed: "Hlasov√°n√≠ ukonƒçeno",
    ends_on: "Konƒç√≠ {date}",
    ended_on: "Skonƒçilo {date}",
  },
  es: {
    brand_sub: "Visi√≥n global de opiniones de todo el mundo",
    home: "Inicio",
    map_title: "Mapa",
    map_sub: "Haz clic en un pa√≠s para ver sus eventos. O usa la b√∫squeda.",
    clear_country: "Quitar pa√≠s",
    top3_title: "Top 3 eventos",
    top3_sub: "Eventos con m√°s votos",
    refresh: "Actualizar",
    search_ph: "Buscar pa√≠s o evento‚Ä¶",
    country_pill_all: "Pa√≠s: (todos)",
    continent_pill_all: "Continente: Todos",
    not_signed_in: "Sin sesi√≥n",
    signed_in_as: "Conectado como: {email}",
    login: "Iniciar sesi√≥n",
    logout: "Cerrar sesi√≥n",
    register: "Registrarse",
    login_title: "Iniciar sesi√≥n",
    close: "Cerrar",
    email: "Email",
    password: "Contrase√±a",
    register_title: "Crear cuenta",
    register_sub: "Te enviaremos un email de verificaci√≥n. Tras confirmar, volver√°s aqu√≠.",
    select_country: "Selecciona tu pa√≠s",
    cancel: "Cancelar",
    verified_title: "Cuenta verificada ‚úÖ",
    verified_sub: "Ya puedes votar. Volveremos a Inicio autom√°ticamente.",
    go_home: "Ir a Inicio",
    back: "‚Üê Atr√°s",
    events: "Eventos",
    loading: "Cargando‚Ä¶",
    no_events: "A√∫n no hay eventos para este pa√≠s.",
    vote_title: "Votar",
    vote_yes: "S√≠",
    vote_no: "No",
    vote_neutral: "Sin opini√≥n",
    vote_need_login: "Inicia sesi√≥n para votar.",
    vote_need_verify: "Verifica tu email para votar.",
    voted_already: "Ya votaste en este evento.",
    voted_saved: "Voto guardado ‚úÖ",
    stats_title: "Estad√≠sticas",
    stats_total_votes: "Votos totales:",
    citizens_of: "Ciudadanos de {country} ({code})",
    other_countries: "Otros pa√≠ses",
    location: "Ubicaci√≥n",
    countries_in: "Pa√≠ses en {continent}",
    selected_country: "Pa√≠s seleccionado",
    found_countries: "Encontrados: {n}. Haz clic en un pa√≠s.",
    pick_country_sub: "Elige un pa√≠s para ver eventos.",
    back_to_countries: "Pulsa atr√°s para elegir otro pa√≠s en {continent}."
  },
  fr: {
    brand_sub: "Vue globale des opinions du monde entier",
    home: "Accueil",
    map_title: "Carte",
    map_sub: "Cliquez sur un pays pour voir ses √©v√©nements, ou utilisez la recherche.",
    clear_country: "Effacer le pays",
    top3_title: "Top 3 √©v√©nements",
    top3_sub: "√âv√©nements les plus vot√©s",
    refresh: "Rafra√Æchir",
    search_ph: "Rechercher un pays ou un √©v√©nement‚Ä¶",
    country_pill_all: "Pays : (tous)",
    continent_pill_all: "Continent : Tous",
    not_signed_in: "Non connect√©",
    signed_in_as: "Connect√© : {email}",
    login: "Connexion",
    logout: "D√©connexion",
    register: "Inscription",
    login_title: "Connexion",
    close: "Fermer",
    email: "Email",
    password: "Mot de passe",
    register_title: "Cr√©er un compte",
    register_sub: "Nous enverrons un email de v√©rification. Apr√®s confirmation, vous reviendrez ici.",
    select_country: "Choisissez votre pays",
    cancel: "Annuler",
    verified_title: "Compte v√©rifi√© ‚úÖ",
    verified_sub: "Vous pouvez voter. Retour √† l‚Äôaccueil automatiquement.",
    go_home: "Aller √† l‚Äôaccueil",
    back: "‚Üê Retour",
    events: "√âv√©nements",
    loading: "Chargement‚Ä¶",
    no_events: "Aucun √©v√©nement pour ce pays.",
    vote_title: "Voter",
    vote_yes: "Oui",
    vote_no: "Non",
    vote_neutral: "Sans avis",
    vote_need_login: "Connectez‚Äëvous pour voter.",
    vote_need_verify: "V√©rifiez votre email pour voter.",
    voted_already: "Vous avez d√©j√† vot√©.",
    voted_saved: "Vote enregistr√© ‚úÖ",
    stats_title: "Statistiques",
    stats_total_votes: "Total des votes :",
    citizens_of: "Citoyens de {country} ({code})",
    other_countries: "Autres pays",
    location: "Lieu",
    countries_in: "Pays en {continent}",
    selected_country: "Pays s√©lectionn√©",
    found_countries: "Trouv√©s : {n}. Cliquez sur un pays.",
    pick_country_sub: "Choisissez un pays pour voir les √©v√©nements.",
    back_to_countries: "Retour pour choisir un autre pays en {continent}."
  },
  de: {
    brand_sub: "Globale Sicht auf Meinungen aus aller Welt",
    home: "Start",
    map_title: "Karte",
    map_sub: "Klicke auf ein Land, um Ereignisse zu sehen ‚Äì oder nutze die Suche.",
    clear_country: "Land l√∂schen",
    top3_title: "Top 3 Ereignisse",
    top3_sub: "Meistgew√§hlte Ereignisse",
    refresh: "Aktualisieren",
    search_ph: "Land oder Ereignis suchen‚Ä¶",
    country_pill_all: "Land: (alle)",
    continent_pill_all: "Kontinent: Alle",
    not_signed_in: "Nicht angemeldet",
    signed_in_as: "Angemeldet als: {email}",
    login: "Anmelden",
    logout: "Abmelden",
    register: "Registrieren",
    login_title: "Anmelden",
    close: "Schlie√üen",
    email: "E‚ÄëMail",
    password: "Passwort",
    register_title: "Konto erstellen",
    register_sub: "Wir senden eine Best√§tigungs‚ÄëE‚ÄëMail. Danach wirst du zur√ºckgeleitet.",
    select_country: "W√§hle dein Land",
    cancel: "Abbrechen",
    verified_title: "Konto best√§tigt ‚úÖ",
    verified_sub: "Du kannst jetzt abstimmen. Weiterleitung zur Startseite‚Ä¶",
    go_home: "Zur Startseite",
    back: "‚Üê Zur√ºck",
    events: "Ereignisse",
    loading: "L√§dt‚Ä¶",
    no_events: "Noch keine Ereignisse f√ºr dieses Land.",
    vote_title: "Abstimmen",
    vote_yes: "Ja",
    vote_no: "Nein",
    vote_neutral: "Keine Meinung",
    vote_need_login: "Bitte anmelden, um abzustimmen.",
    vote_need_verify: "Bitte E‚ÄëMail best√§tigen, um abzustimmen.",
    voted_already: "Du hast bereits abgestimmt.",
    voted_saved: "Stimme gespeichert ‚úÖ",
    stats_title: "Statistiken",
    stats_total_votes: "Stimmen gesamt:",
    citizens_of: "B√ºrger von {country} ({code})",
    other_countries: "Andere L√§nder",
    location: "Ort",
    countries_in: "L√§nder in {continent}",
    selected_country: "Ausgew√§hltes Land",
    found_countries: "Gefunden: {n}. Klicke auf ein Land.",
    pick_country_sub: "W√§hle ein Land, um Ereignisse zu sehen.",
    back_to_countries: "Zur√ºck, um ein anderes Land in {continent} zu w√§hlen."
  },
  ar: {
    brand_sub: "ŸÜÿ∏ÿ±ÿ© ÿπÿßŸÑŸÖŸäÿ© ÿπŸÑŸâ ÿ¢ÿ±ÿßÿ° ÿßŸÑŸÜÿßÿ≥ ÿ≠ŸàŸÑ ÿßŸÑÿπÿßŸÑŸÖ",
    home: "ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©",
    map_title: "ÿßŸÑÿÆÿ±Ÿäÿ∑ÿ©",
    map_sub: "ÿßÿ∂ÿ∫ÿ∑ ÿπŸÑŸâ ÿØŸàŸÑÿ© ŸÑÿ±ÿ§Ÿäÿ© ÿßŸÑÿ£ÿ≠ÿØÿßÿ´ ÿ£Ÿà ÿßÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑÿ®ÿ≠ÿ´.",
    clear_country: "ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿØŸàŸÑÿ©",
    top3_title: "ÿ£ŸÅÿ∂ŸÑ 3 ÿ£ÿ≠ÿØÿßÿ´",
    top3_sub: "ÿßŸÑÿ£ŸÉÿ´ÿ± ÿ™ÿµŸàŸäÿ™Ÿãÿß ÿßŸÑÿ¢ŸÜ",
    refresh: "ÿ™ÿ≠ÿØŸäÿ´",
    search_ph: "ÿßÿ®ÿ≠ÿ´ ÿπŸÜ ÿØŸàŸÑÿ© ÿ£Ÿà ÿ≠ÿØÿ´‚Ä¶",
    country_pill_all: "ÿßŸÑÿØŸàŸÑÿ©: (ÿßŸÑŸÉŸÑ)",
    continent_pill_all: "ÿßŸÑŸÇÿßÿ±ÿ©: ÿßŸÑŸÉŸÑ",
    not_signed_in: "ÿ∫Ÿäÿ± ŸÖÿ≥ÿ¨ŸëŸÑ",
    signed_in_as: "ŸÖÿ≥ÿ¨ŸëŸÑ ŸÉŸÄ: {email}",
    login: "ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ",
    logout: "ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨",
    register: "ÿ•ŸÜÿ¥ÿßÿ° ÿ≠ÿ≥ÿßÿ®",
    login_title: "ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ",
    close: "ÿ•ÿ∫ŸÑÿßŸÇ",
    email: "ÿßŸÑÿ®ÿ±ŸäÿØ",
    password: "ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±",
    register_title: "ÿ•ŸÜÿ¥ÿßÿ° ÿ≠ÿ≥ÿßÿ®",
    register_sub: "ÿ≥ŸÜÿ±ÿ≥ŸÑ ÿ±ÿ≥ÿßŸÑÿ© ÿ™ÿ≠ŸÇŸÇ. ÿ®ÿπÿØ ÿßŸÑÿ™ÿ£ŸÉŸäÿØ ÿ≥ÿ™ÿπŸàÿØ ÿ•ŸÑŸâ ŸáŸÜÿß.",
    select_country: "ÿßÿÆÿ™ÿ± ÿØŸàŸÑÿ™ŸÉ",
    cancel: "ÿ•ŸÑÿ∫ÿßÿ°",
    verified_title: "ÿ™ŸÖ ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿ≠ÿ≥ÿßÿ® ‚úÖ",
    verified_sub: "ŸäŸÖŸÉŸÜŸÉ ÿßŸÑÿ™ÿµŸàŸäÿ™ ÿßŸÑÿ¢ŸÜ. ÿ≥ŸÜÿπŸäÿØŸÉ ŸÑŸÑÿµŸÅÿ≠ÿ© ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©.",
    go_home: "ÿßÿ∞Ÿáÿ® ŸÑŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©",
    back: "‚Üê ÿ±ÿ¨Ÿàÿπ",
    events: "ÿßŸÑÿ£ÿ≠ÿØÿßÿ´",
    loading: "ÿ¨ÿßÿ±Ÿç ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ‚Ä¶",
    no_events: "ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ£ÿ≠ÿØÿßÿ´ ŸÑŸáÿ∞Ÿá ÿßŸÑÿØŸàŸÑÿ© ÿ®ÿπÿØ.",
    vote_title: "ÿßŸÑÿ™ÿµŸàŸäÿ™",
    vote_yes: "ŸÜÿπŸÖ",
    vote_no: "ŸÑÿß",
    vote_neutral: "ŸÑÿß ÿ±ÿ£Ÿä",
    vote_need_login: "ÿ≥ÿ¨ŸëŸÑ ÿßŸÑÿØÿÆŸàŸÑ ŸÑŸÑÿ™ÿµŸàŸäÿ™.",
    vote_need_verify: "ÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ®ÿ±ŸäÿØŸÉ ŸÑŸÑÿ™ÿµŸàŸäÿ™.",
    voted_already: "ŸÑŸÇÿØ ÿµŸàŸëÿ™ÿ™ ÿ®ÿßŸÑŸÅÿπŸÑ.",
    voted_saved: "ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿßŸÑÿµŸàÿ™ ‚úÖ",
    stats_title: "ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™",
    stats_total_votes: "ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿ£ÿµŸàÿßÿ™:",
    citizens_of: "ŸÖŸàÿßÿ∑ŸÜŸà {country} ({code})",
    other_countries: "ÿØŸàŸÑ ÿ£ÿÆÿ±Ÿâ",
    location: "ÿßŸÑŸÖŸàŸÇÿπ",
    countries_in: "ÿØŸàŸÑ ŸÅŸä {continent}",
    selected_country: "ÿßŸÑÿØŸàŸÑÿ© ÿßŸÑŸÖÿÆÿ™ÿßÿ±ÿ©",
    found_countries: "ÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ {n}. ÿßÿÆÿ™ÿ± ÿØŸàŸÑÿ©.",
    pick_country_sub: "ÿßÿÆÿ™ÿ± ÿØŸàŸÑÿ© ŸÑÿ±ÿ§Ÿäÿ© ÿßŸÑÿ£ÿ≠ÿØÿßÿ´.",
    back_to_countries: "ÿßÿ±ÿ¨ÿπ ŸÑÿßÿÆÿ™Ÿäÿßÿ± ÿØŸàŸÑÿ© ÿ£ÿÆÿ±Ÿâ ŸÅŸä {continent}."
  },
  ru: {
    brand_sub: "–ì–ª–æ–±–∞–ª—å–Ω—ã–π –≤–∑–≥–ª—è–¥ –Ω–∞ –º–Ω–µ–Ω–∏—è –ª—é–¥–µ–π —Å–æ –≤—Å–µ–≥–æ –º–∏—Ä–∞",
    home: "–ì–ª–∞–≤–Ω–∞—è",
    map_title: "–ö–∞—Ä—Ç–∞",
    map_sub: "–ù–∞–∂–º–∏—Ç–µ –Ω–∞ —Å—Ç—Ä–∞–Ω—É, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Å–æ–±—ã—Ç–∏—è, –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–æ–∏—Å–∫.",
    clear_country: "–°–±—Ä–æ—Å–∏—Ç—å —Å—Ç—Ä–∞–Ω—É",
    top3_title: "–¢–æ–ø‚Äë3 —Å–æ–±—ã—Ç–∏–π",
    top3_sub: "–°–∞–º—ã–µ –≥–æ–ª–æ—Å—É–µ–º—ã–µ —Å–µ–π—á–∞—Å",
    refresh: "–û–±–Ω–æ–≤–∏—Ç—å",
    search_ph: "–ò—Å–∫–∞—Ç—å —Å—Ç—Ä–∞–Ω—É –∏–ª–∏ —Å–æ–±—ã—Ç–∏–µ‚Ä¶",
    country_pill_all: "–°—Ç—Ä–∞–Ω–∞: (–≤—Å–µ)",
    continent_pill_all: "–ö–æ–Ω—Ç–∏–Ω–µ–Ω—Ç: –í—Å–µ",
    not_signed_in: "–ù–µ –≤–æ—à–ª–∏",
    signed_in_as: "–í–æ—à–ª–∏ –∫–∞–∫: {email}",
    login: "–í–æ–π—Ç–∏",
    logout: "–í—ã–π—Ç–∏",
    register: "–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è",
    login_title: "–í—Ö–æ–¥",
    close: "–ó–∞–∫—Ä—ã—Ç—å",
    email: "Email",
    password: "–ü–∞—Ä–æ–ª—å",
    register_title: "–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç",
    register_sub: "–ú—ã –æ—Ç–ø—Ä–∞–≤–∏–º –ø–∏—Å—å–º–æ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è. –ü–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –≤—ã –≤–µ—Ä–Ω—ë—Ç–µ—Å—å —Å—é–¥–∞.",
    select_country: "–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—Ä–∞–Ω—É",
    cancel: "–û—Ç–º–µ–Ω–∞",
    verified_title: "–ê–∫–∫–∞—É–Ω—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω ‚úÖ",
    verified_sub: "–¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –≥–æ–ª–æ—Å–æ–≤–∞—Ç—å. –°–µ–π—á–∞—Å –≤–µ—Ä–Ω—ë–º –Ω–∞ –≥–ª–∞–≤–Ω—É—é.",
    go_home: "–ù–∞ –≥–ª–∞–≤–Ω—É—é",
    back: "‚Üê –ù–∞–∑–∞–¥",
    events: "–°–æ–±—ã—Ç–∏—è",
    loading: "–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶",
    no_events: "–ü–æ–∫–∞ –Ω–µ—Ç —Å–æ–±—ã—Ç–∏–π –¥–ª—è —ç—Ç–æ–π —Å—Ç—Ä–∞–Ω—ã.",
    vote_title: "–ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ",
    vote_yes: "–î–∞",
    vote_no: "–ù–µ—Ç",
    vote_neutral: "–ù–µ—Ç –º–Ω–µ–Ω–∏—è",
    vote_need_login: "–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –≥–æ–ª–æ—Å–æ–≤–∞—Ç—å.",
    vote_need_verify: "–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ email, —á—Ç–æ–±—ã –≥–æ–ª–æ—Å–æ–≤–∞—Ç—å.",
    voted_already: "–í—ã —É–∂–µ –≥–æ–ª–æ—Å–æ–≤–∞–ª–∏.",
    voted_saved: "–ì–æ–ª–æ—Å —Å–æ—Ö—Ä–∞–Ω—ë–Ω ‚úÖ",
    stats_title: "–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞",
    stats_total_votes: "–í—Å–µ–≥–æ –≥–æ–ª–æ—Å–æ–≤:",
    citizens_of: "–ì—Ä–∞–∂–¥–∞–Ω–µ {country} ({code})",
    other_countries: "–î—Ä—É–≥–∏–µ —Å—Ç—Ä–∞–Ω—ã",
    location: "–õ–æ–∫–∞—Ü–∏—è",
    countries_in: "–°—Ç—Ä–∞–Ω—ã –≤ {continent}",
    selected_country: "–í—ã–±—Ä–∞–Ω–∞ —Å—Ç—Ä–∞–Ω–∞",
    found_countries: "–ù–∞–π–¥–µ–Ω–æ: {n}. –ù–∞–∂–º–∏—Ç–µ –Ω–∞ —Å—Ç—Ä–∞–Ω—É.",
    pick_country_sub: "–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—Ä–∞–Ω—É –¥–ª—è —Å–æ–±—ã—Ç–∏–π.",
    back_to_countries: "–ù–∞–∑–∞–¥, —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å –¥—Ä—É–≥—É—é —Å—Ç—Ä–∞–Ω—É –≤ {continent}."
  },
  zh: {
    brand_sub: "Êù•Ëá™‰∏ñÁïåÂêÑÂú∞ÁöÑÂÖ®ÁêÉÊÑèËßÅËßÜÂõæ",
    home: "‰∏ªÈ°µ",
    map_title: "Âú∞Âõæ",
    map_sub: "ÁÇπÂáªÂõΩÂÆ∂Êü•Áúã‰∫ã‰ª∂ÔºåÊàñ‰ΩøÁî®ÊêúÁ¥¢„ÄÇ",
    clear_country: "Ê∏ÖÈô§ÂõΩÂÆ∂",
    top3_title: "Top 3 ‰∫ã‰ª∂",
    top3_sub: "ÂΩìÂâçÊäïÁ•®ÊúÄÂ§öÁöÑ‰∫ã‰ª∂",
    refresh: "Âà∑Êñ∞",
    search_ph: "ÊêúÁ¥¢ÂõΩÂÆ∂Êàñ‰∫ã‰ª∂‚Ä¶",
    country_pill_all: "ÂõΩÂÆ∂Ôºö (ÂÖ®ÈÉ®)",
    continent_pill_all: "Ê¥≤ÔºöÂÖ®ÈÉ®",
    not_signed_in: "Êú™ÁôªÂΩï",
    signed_in_as: "Â∑≤ÁôªÂΩïÔºö{email}",
    login: "ÁôªÂΩï",
    logout: "ÈÄÄÂá∫",
    register: "Ê≥®ÂÜå",
    login_title: "ÁôªÂΩï",
    close: "ÂÖ≥Èó≠",
    email: "ÈÇÆÁÆ±",
    password: "ÂØÜÁ†Å",
    register_title: "ÂàõÂª∫Ë¥¶Âè∑",
    register_sub: "Êàë‰ª¨‰ºöÂèëÈÄÅÈ™åËØÅÈÇÆ‰ª∂„ÄÇÁ°ÆËÆ§Âêé‰ºöË∑≥ÂõûÊ≠§È°µÈù¢„ÄÇ",
    select_country: "ÈÄâÊã©‰Ω†ÁöÑÂõΩÂÆ∂",
    cancel: "ÂèñÊ∂à",
    verified_title: "Ë¥¶Âè∑Â∑≤È™åËØÅ ‚úÖ",
    verified_sub: "Áé∞Âú®ÂèØ‰ª•ÊäïÁ•®„ÄÇÂ∞ÜËá™Âä®ËøîÂõû‰∏ªÈ°µ„ÄÇ",
    go_home: "ËøîÂõû‰∏ªÈ°µ",
    back: "‚Üê ËøîÂõû",
    events: "‰∫ã‰ª∂",
    loading: "Âä†ËΩΩ‰∏≠‚Ä¶",
    no_events: "ËØ•ÂõΩÂÆ∂ÊöÇÊó†‰∫ã‰ª∂„ÄÇ",
    vote_title: "ÊäïÁ•®",
    vote_yes: "ÊòØ",
    vote_no: "Âê¶",
    vote_neutral: "Êó†ÊÑèËßÅ",
    vote_need_login: "ËØ∑ÁôªÂΩïÂêéÊäïÁ•®„ÄÇ",
    vote_need_verify: "ËØ∑È™åËØÅÈÇÆÁÆ±ÂêéÊäïÁ•®„ÄÇ",
    voted_already: "‰Ω†Â∑≤ÂØπÊ≠§‰∫ã‰ª∂ÊäïÁ•®„ÄÇ",
    voted_saved: "ÊäïÁ•®Â∑≤‰øùÂ≠ò ‚úÖ",
    stats_title: "ÁªüËÆ°",
    stats_total_votes: "ÊÄªÁ•®Êï∞Ôºö",
    citizens_of: "{country}Ôºà{code}ÔºâÂÖ¨Ê∞ë",
    other_countries: "ÂÖ∂‰ªñÂõΩÂÆ∂",
    location: "‰ΩçÁΩÆ",
    countries_in: "{continent} ÁöÑÂõΩÂÆ∂",
    selected_country: "Â∑≤ÈÄâÂõΩÂÆ∂",
    found_countries: "ÊâæÂà∞Ôºö{n}„ÄÇÁÇπÂáªÂõΩÂÆ∂Êü•Áúã„ÄÇ",
    pick_country_sub: "ÈÄâÊã©ÂõΩÂÆ∂Êü•Áúã‰∫ã‰ª∂„ÄÇ",
    back_to_countries: "ËøîÂõû‰ª•ÈÄâÊã© {continent} ÁöÑÂÖ∂‰ªñÂõΩÂÆ∂„ÄÇ"
  }
};




function countriesForSearch(){
  if (selectedContinent === "ALL") return countries;
  return countries.filter(c => (c.continent_name || "") === selectedContinent);
}
function continentOfCountry(code){
  return countriesByCode[code]?.continent_name || "";
}
function eventsForSearch(){
  if (selectedContinent === "ALL") return eventsCache;
  return eventsCache.filter(e => continentOfCountry(e.country_code) === selectedContinent);
}

/* ================== UI refs ================== */
const screenHome = document.getElementById("screenHome");
const screenCountry = document.getElementById("screenCountry");
const screenEvent = document.getElementById("screenEvent");

const selectedCountryPill = document.getElementById("selectedCountryPill");
const selectedContinentPill = document.getElementById("selectedContinentPill");

const continentsBar = document.getElementById("continentsBar");

const searchInput = document.getElementById("search");
const suggestBox = document.getElementById("searchSuggest");

const countryTitle = document.getElementById("countryTitle");
const countrySubtitle = document.getElementById("countrySubtitle");
const eventsList = document.getElementById("eventsList");

const eventTitle = document.getElementById("eventTitle");
const eventMeta = document.getElementById("eventMeta");
const eventDesc = document.getElementById("eventDesc");


function applyI18n(){
  // header
  document.querySelector(".brand .muted").textContent = t("brand_sub");
  document.getElementById("homeBtn").textContent = t("home");
  document.getElementById("search").placeholder = t("search_ph");

  // home
  const mapTitle = document.querySelector("#screenHome h3");
  if (mapTitle) mapTitle.textContent = t("map_title");
  const mapSub = document.querySelector("#screenHome .muted");
  if (mapSub) mapSub.textContent = t("map_sub");
  const clearBtn = document.getElementById("clearCountryBtn");
  if (clearBtn) clearBtn.textContent = t("clear_country");

  // top3
  const topTitle = document.querySelector("#top3Box")?.closest(".card")?.querySelector("h3");
  if (topTitle) topTitle.textContent = t("top3_title");
  const topSub = document.querySelector("#top3Box")?.closest(".card")?.querySelector(".muted");
  if (topSub) topSub.textContent = t("top3_sub");
  const refreshTop = document.getElementById("refreshTopBtn");
  if (refreshTop) refreshTop.textContent = t("refresh");

  // auth
  document.getElementById("loginToggleBtn").textContent = t("login");
  document.getElementById("registerNavBtn").textContent = t("register");
  document.getElementById("logoutBtn").textContent = t("logout");

  // login panel
  const lpTitle = document.querySelector("#loginPanelWrap strong");
  if (lpTitle) lpTitle.textContent = t("login_title");
  document.getElementById("loginCloseBtn").textContent = t("close");
  document.getElementById("loginEmail").placeholder = t("email");
  document.getElementById("loginPassword").placeholder = t("password");
  document.getElementById("loginBtn").textContent = t("login");

  // register screen
  const regH2 = document.querySelector("#screenRegister h2");
  if (regH2) regH2.textContent = t("register_title");
  const regSub = document.querySelector("#screenRegister .muted");
  if (regSub) regSub.textContent = t("register_sub");
  document.getElementById("regEmail").placeholder = t("email");
  document.getElementById("regPassword").placeholder = t("password");
  const regCountry = document.getElementById("regCountry");
  if (regCountry && regCountry.options.length){
    regCountry.options[0].textContent = t("select_country");
  }
  document.getElementById("regCancelBtn").textContent = t("cancel");
  document.getElementById("regSubmitBtn").textContent = t("register");
  document.getElementById("backFromRegister").textContent = t("back");

  // verified
  const vH2 = document.querySelector("#screenVerified h2");
  if (vH2) vH2.textContent = t("verified_title");
  const vSub = document.querySelector("#screenVerified .muted");
  if (vSub) vSub.textContent = t("verified_sub");
  document.getElementById("verifiedGoHomeBtn").textContent = t("go_home");

  // country / event nav
  document.getElementById("backFromCountry").textContent = t("back");
  document.getElementById("backFromEvent").textContent = t("back");

  // vote / stats
  const voteH3 = document.querySelector("#screenEvent #voteArea")?.closest(".card")?.querySelector("h3");
  if (voteH3) voteH3.textContent = t("vote_title");
  document.getElementById("voteYesBtn").textContent = t("vote_yes");
  document.getElementById("voteNoBtn").textContent = t("vote_no");
  document.getElementById("voteNeutralBtn").textContent = t("vote_neutral");
  const statsH3 = document.querySelector("#statsBox")?.closest(".card")?.querySelector("h3");
  if (statsH3) statsH3.textContent = t("stats_title");

  // minimap label
  const locLabel = document.querySelector("#miniMap")?.parentElement?.querySelector(".muted");
  if (locLabel) locLabel.textContent = t("location");

  // pills (default text; actual value set by functions)
  setContinentPill();
  setCountryPill();

  // auth pill refresh
  setAuthUI();
  try{ applyI18n(); }catch(e){}
}


/* ================== Voting UI refs ================== */
const voteYesBtn = document.getElementById("voteYesBtn");
const voteNoBtn = document.getElementById("voteNoBtn");
const voteNeutralBtn = document.getElementById("voteNeutralBtn");
const voteButtonsRow = document.getElementById("voteButtonsRow");
const voteMsg = document.getElementById("voteMsg");
const statsBox = document.getElementById("statsBox");

const VOTE = { YES: "YES", NO: "NO", NEUTRAL: "NEUTRAL" };

// Local fallback: if we know the user voted in this session, lock UI immediately
const votedLocal = new Set();

function pct(part, total){ return total ? Math.round((part/total)*100) : 0; }
function barHTML(label, count, total){
  const p = pct(count, total);
  let cls = "barNeutral";
  if (label === "Yes") cls = "barYes";
  if (label === "No") cls = "barNo";

  return `
    <div class="barRow ${cls}">
      <div class="barLabel">${escapeHtml(label)}</div>
      <div class="barOuter"><div class="barInner" style="width:${p}%;"></div></div>
      <div class="barValue">${count} (${p}%)</div>
    </div>
  `;
}

async function getMyProfile(){
  if (!currentUser) return null;

  // Some setups use profiles.id, others profiles.user_id. We'll try both.
  // Attempt 1: profiles.id
  try{
    const r1 = await supabaseClient
      .from("profiles")
      .select("country_code, language")
      .eq("id", currentUser.id)
      .maybeSingle();
    if (!r1.error && r1.data) return r1.data;
    if (r1.error && !String(r1.error.message||"").toLowerCase().includes("column")) {
      // non-column error (e.g., RLS), still return null but log
      console.warn("getMyProfile(id) error:", r1.error);
    }
  }catch(e){}

  // Attempt 2: profiles.user_id
  try{
    const r2 = await supabaseClient
      .from("profiles")
      .select("country_code, language")
      .eq("user_id", currentUser.id)
      .maybeSingle();
    if (r2.error){
      console.warn("getMyProfile(user_id) error:", r2.error);
      return null;
    }
    return r2.data || null;
  }catch(e){
    console.warn("getMyProfile unexpected error:", e);
    return null;
  }
}

function isEmailVerified(){
  return !!(currentUser && (currentUser.email_confirmed_at || currentUser.confirmed_at));
}

function setVoteUIState(state){
  if (state === "NEED_LOGIN"){
    voteButtonsRow.style.display = "none";
    voteMsg.textContent = t("vote_need_login");
    return;
  }
  if (state === "NEED_VERIFY"){
    voteButtonsRow.style.display = "none";
    voteMsg.textContent = t("vote_need_verify");
    return;
  }
  if (state === "ALREADY_VOTED"){
    voteButtonsRow.style.display = "none";
    return;
  }
  voteButtonsRow.style.display = "flex";
}

async function refreshStats(eventId, eventCountryCode){
  statsBox.textContent = "Loading‚Ä¶";

  const { data, error } = await supabaseClient
    .from("votes")
    .select("vote,country_code")
    .eq("event_id", eventId);

  if (error){
    console.error("refreshStats error:", error);
    statsBox.textContent = "Cannot load statistics.";
    return;
  }

  const rows = data || [];
  const total = rows.length;

  const yes = rows.filter(r => r.vote === VOTE.YES).length;
  const no = rows.filter(r => r.vote === VOTE.NO).length;
  const neutral = rows.filter(r => r.vote === VOTE.NEUTRAL).length;

  const citizens = eventCountryCode ? rows.filter(r => r.country_code === eventCountryCode) : [];
  const others = eventCountryCode ? rows.filter(r => r.country_code !== eventCountryCode) : rows;

  const cTotal = citizens.length;
  const oTotal = others.length;

  const cYes = citizens.filter(r => r.vote === VOTE.YES).length;
  const cNo = citizens.filter(r => r.vote === VOTE.NO).length;
  const cNeutral = citizens.filter(r => r.vote === VOTE.NEUTRAL).length;

  const oYes = others.filter(r => r.vote === VOTE.YES).length;
  const oNo = others.filter(r => r.vote === VOTE.NO).length;
  const oNeutral = others.filter(r => r.vote === VOTE.NEUTRAL).length;

  const countryLabel = eventCountryCode ? (countriesByCode[eventCountryCode]?.name || eventCountryCode) : "";

  statsBox.innerHTML = `
    <div class="stats-wide">
      <div><strong>${t("stats_total_votes")}</strong> ${total}</div>
      <div class="barWrap bars-large">
        ${barHTML("Yes", yes, total)}
        ${barHTML("No", no, total)}
        ${barHTML("No opinion", neutral, total)}
      </div>
    </div>

    <div class="stats-medium" style="margin-top:14px;">
      <div><strong>${t("citizens_of", {country: escapeHtml(countryLabel), code: escapeHtml(eventCountryCode||"")})}</strong>: ${cTotal}</div>
      <div class="barWrap bars-medium">
        ${barHTML("Yes", cYes, cTotal)}
        ${barHTML("No", cNo, cTotal)}
        ${barHTML("No opinion", cNeutral, cTotal)}
      </div>
    </div>

    <div class="stats-narrow" style="margin-top:14px;">
      <div><strong>${t("other_countries")}</strong>: ${oTotal}</div>
      <div class="barWrap bars-small">
        ${barHTML("Yes", oYes, oTotal)}
        ${barHTML("No", oNo, oTotal)}
        ${barHTML("No opinion", oNeutral, oTotal)}
      </div>
    </div>
  `;
}

async function checkAlreadyVoted(eventId){
  if (!currentUser) return false;

  // Fast path: we already voted during this session
  if (votedLocal.has(eventId)) return true;

  const { data, error } = await supabaseClient
    .from("votes")
    .select("vote")
    .eq("user_id", currentUser.id)
    .eq("event_id", eventId)
    .maybeSingle();

  if (error){
    // If RLS blocks SELECT, we can‚Äôt reliably detect across refresh,
    // but at least don‚Äôt keep the UI unlocked after a successful vote in this session.
    console.warn("checkAlreadyVoted error:", error);
    return votedLocal.has(eventId);
  }
  return !!data;
}

async function refreshVoteArea(eventId, eventCountryCode){
  voteMsg.textContent = "";

  // Closed event: allow viewing stats, but no voting
  try{
    if (currentEventEndsAt){
      const d = new Date(currentEventEndsAt);
      if (!isNaN(d) && d.getTime() <= Date.now()){
        setVoteUIState("ALREADY_VOTED");
        voteMsg.classList.add("okText");
        voteMsg.textContent = t("event_closed");
        return;
      }
    }
  }catch(e){}


  if (!currentUser){
    setVoteUIState("NEED_LOGIN");
    return;
  }
  if (!isEmailVerified()){
    setVoteUIState("NEED_VERIFY");
    return;
  }

  const already = await checkAlreadyVoted(eventId);
  if (already){
    setVoteUIState("ALREADY_VOTED");
    voteMsg.classList.add("okText");
    voteMsg.textContent = t("voted_already");
    return;
  }

  setVoteUIState("CAN_VOTE");
}

async function submitVote(value){
  if (!currentUser){ setVoteUIState("NEED_LOGIN"); return; }

  try{
    if (currentEventEndsAt){
      const d = new Date(currentEventEndsAt);
      if (!isNaN(d) && d.getTime() <= Date.now()){
        voteMsg.classList.add("errorText");
        voteMsg.textContent = t("event_closed");
        setVoteUIState("ALREADY_VOTED");
        return;
      }
    }
  }catch(e){}

  if (!isEmailVerified()){ setVoteUIState("NEED_VERIFY"); return; }
  if (!currentEventId){ return; }

  voteMsg.classList.remove("errorText","okText");
  voteMsg.textContent = "Saving‚Ä¶";
  voteButtonsRow.style.display = "none";

  const prof = await getMyProfile();
  const myCountry = prof?.country_code || currentUser.user_metadata?.country_code || null;

  if (!myCountry){
    voteMsg.classList.add("errorText");
    voteMsg.textContent = "Missing your country in profile. Please re-register or contact admin.";
    return;
  }

  const { error } = await supabaseClient.from("votes").insert({
    user_id: currentUser.id,
    event_id: currentEventId,
    vote: value,
    country_code: myCountry
  });

  if (error){
    if (error.code === "23505" || error.status === 409){
      voteMsg.classList.add("okText");
      voteMsg.classList.add("okText");
    voteMsg.textContent = t("voted_already");
      await refreshVoteArea(currentEventId, currentEventCountryCode || "");
      return;
    }
    console.error("Vote insert error:", error);
    voteMsg.classList.add("errorText");
    voteMsg.textContent = error.message;
    voteButtonsRow.style.display = "flex";
    return;
  }

  votedLocal.add(currentEventId);
  voteMsg.classList.add("okText");
  voteMsg.textContent = t("voted_saved");
  setVoteUIState("ALREADY_VOTED");
  await refreshStats(currentEventId, currentEventCountryCode || "");
  try{ await loadTop3(); }catch(e){}
}

voteYesBtn.onclick = () => submitVote(VOTE.YES);
voteNoBtn.onclick = () => submitVote(VOTE.NO);
voteNeutralBtn.onclick = () => submitVote(VOTE.NEUTRAL);




/* ================== Continent countries UI ================== */
const continentCountriesWrap = document.getElementById("continentCountriesWrap");
const continentCountriesTitle = document.getElementById("continentCountriesTitle");
const continentCountriesSub = document.getElementById("continentCountriesSub");
const continentCountriesList = document.getElementById("continentCountriesList");
const hideCountriesBtn = document.getElementById("hideCountriesBtn");

hideCountriesBtn.onclick = () => {
  continentCountriesWrap.style.display = "none";
};

/* Rough map bounds per continent (lng/lat). We can refine later. */
const CONTINENT_BOUNDS = {
  "Europe": [[-25, 34], [45, 72]],
  "Asia": [[25, -10], [180, 80]],
  "Africa": [[-25, -40], [60, 38]],
  "North America": [[-170, 7], [-50, 83]],
  "South America": [[-92, -56], [-30, 13]],
  "Oceania": [[110, -50], [180, 5]],
};

function renderContinentCountries(){
  // Only show this panel when a specific continent is selected
  if (selectedContinent === "ALL"){
    continentCountriesWrap.style.display = "none";
    continentCountriesList.innerHTML = "";
    return;
  }

  continentCountriesWrap.style.display = "block";

  // If a country is selected, collapse to a single chip + back button (more room for events)
  if (selectedCountryCode){
    const c = countriesByCode[selectedCountryCode];
    const label = c ? `${c.name} (${c.code})` : selectedCountryCode;

    continentCountriesTitle.textContent = t("selected_country");
    continentCountriesSub.textContent = t("back_to_countries", { continent: selectedContinent });

    // two-column layout: left selected country chip, right back button
    continentCountriesList.innerHTML = `
      <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;width:100%;">
        <button class="countryChip active" data-cc="${escapeHtml(selectedCountryCode)}" style="cursor:default;">${escapeHtml(label)}</button>
        <button class="ghost" id="continentBackBtn" style="padding:6px 10px;">‚Üê Back</button>
      </div>
    `;

    const backBtn = document.getElementById("continentBackBtn");
    if (backBtn){
      backBtn.onclick = async () => {
        // clear current selection but keep continent
        selectedCountryCode = "";
        selectedCountryName = "";
        setCountryPill();
        setBigMapSelected("");
        // go back to country list + home (so user can pick again)
        showScreen("HOME");
        renderContinentCountries();
      };
    }
    return;
  }

  // Otherwise render all countries for this continent
  const list = countriesForSearch().slice().sort((a,b)=>a.name.localeCompare(b.name));
  continentCountriesTitle.textContent = t("countries_in", { continent: selectedContinent });
  continentCountriesSub.textContent = t("found_countries", { n: list.length });

  continentCountriesList.innerHTML = list.map(c => {
    return `<button class="countryChip" data-cc="${escapeHtml(c.code)}">${escapeHtml(c.name)} (${escapeHtml(c.code)})</button>`;
  }).join("");

  for (const btn of continentCountriesList.querySelectorAll("button[data-cc]")){
    btn.addEventListener("click", async () => {
      const cc = btn.getAttribute("data-cc");
      await selectCountry(cc);
      // collapse to selected view
      renderContinentCountries();
    });
  }
}

let pendingContinentView = "ALL";
function applyContinentView(){
  // Called when continent changes; zoom map if available.
  const c = selectedContinent;
  pendingContinentView = c;

  if (!map) return;

  if (c === "ALL"){
    map.easeTo({ center:[10,20], zoom:1.2, duration:450 });
    return;
  }

  const b = CONTINENT_BOUNDS[c];
  if (b){
    map.fitBounds(b, { padding: 30, duration: 450 });
  }
}


/* ================== Navigation ================== */
function showScreen(name){
  screenHome.classList.toggle("active", name === "HOME");
  screenCountry.classList.toggle("active", name === "COUNTRY");
  screenEvent.classList.toggle("active", name === "EVENT");
  if (name === "HOME" && map) setTimeout(() => map.resize(), 0);
  screenRegister.classList.toggle("active", name === "REGISTER");
  screenVerified.classList.toggle("active", name === "VERIFIED");
}
document.getElementById("homeBtn").onclick = () => {
  currentEventId = null;
  hideSuggest();
  showScreen("HOME");
};
document.getElementById("backFromCountry").onclick = () => {
  hideSuggest();
  showScreen("HOME");
};
document.getElementById("backFromEvent").onclick = () => {
  hideSuggest();
  showScreen("COUNTRY");
};

registerNavBtn.onclick = () => openRegister();
loginToggleBtn.onclick = () => {
  loginError.textContent = "";
  loginPanelWrap.style.display = (loginPanelWrap.style.display === "none" || loginPanelWrap.style.display === "") ? "block" : "none";
  safeHideSuggest();
};
loginCloseBtn.onclick = () => { loginPanelWrap.style.display = "none"; };
logoutBtn.onclick = async () => { await supabaseClient.auth.signOut(); };

backFromRegister.onclick = () => { showScreen("HOME"); };
regCancelBtn.onclick = () => { showScreen("HOME"); };

verifiedGoHomeBtn.onclick = () => { showScreen("HOME"); };

loginBtn.onclick = async () => {
  loginError.textContent = "";
  const em = (loginEmail.value || "").trim();
  const pw = loginPassword.value || "";
  if (!em || !pw){ loginError.textContent = "Enter email and password."; return; }

  const { data, error } = await supabaseClient.auth.signInWithPassword({ email: em, password: pw });
  if (error){ loginError.textContent = error.message; return; }

  currentSession = data.session || null;
  currentUser = data.user || currentSession?.user || null;
  setAuthUI();
  loginPanelWrap.style.display = "none";
};

regSubmitBtn.onclick = async () => {
  regError.textContent = "";
  const em = (regEmail.value || "").trim();
  const pw = regPassword.value || "";
  const cc = regCountry.value || "";
  const lang = regLanguage.value || "en";

  if (!em || !pw){ regError.textContent = "Enter email and password."; return; }
  if (!cc){ regError.textContent = "Select your country."; return; }

  const redirectTo = window.location.origin + window.location.pathname + "#verified";

  const { error } = await supabaseClient.auth.signUp({
    email: em,
    password: pw,
    options: {
      emailRedirectTo: redirectTo,
      data: { country_code: cc, language: lang }
    }
  });

  if (error){ regError.textContent = error.message; return; }

  alert("Verification email sent. Please check your inbox and confirm your account.");
  showScreen("HOME");
};

const top3Box = document.getElementById("top3Box");
const refreshTopBtn = document.getElementById("refreshTopBtn");
if (refreshTopBtn){
  refreshTopBtn.onclick = () => loadTop3();
}
document.getElementById("clearCountryBtn").onclick = () => {
  selectedCountryCode = "";
  selectedCountryName = "";
  setCountryPill();
  setBigMapSelected("");
  renderContinentCountries();
};

/* ================== Pills ================== */
function setCountryPill(){
  selectedCountryPill.textContent = selectedCountryCode
    ? `Country: ${selectedCountryName} (${selectedCountryCode})`
    : t("country_pill_all");
}
function setContinentPill(){
  selectedContinentPill.textContent = `${t("continent_pill_all").split(":")[0]}: ${selectedContinent === "ALL" ? t("continent_pill_all").split(":")[1].trim() : selectedContinent}`;
}

/* ================== Continents bar ================== */
(function bindContinentBar(){
  continentsBar.addEventListener("click", (e) => {
    const btn = e.target.closest("button[data-cont]");
    if (!btn) return;

    selectedContinent = btn.getAttribute("data-cont") || "ALL";
    setContinentPill();

    // visual active
    for (const b of continentsBar.querySelectorAll("button[data-cont]")){
      const active = (b === btn);
      b.style.border = active ? "1px solid #bbb" : "0";
      b.style.background = active ? "#ddd" : "#eee";
    }

    // reset country selection when continent changes
    selectedCountryCode = "";
    selectedCountryName = "";
    setCountryPill();
    setBigMapSelected("");

    hideSuggest();
    showScreen("HOME");

    // show list of countries under the continent bar and zoom map
    renderContinentCountries();
    applyContinentView();
  });
})();

/* ================== Search suggest ================== */
function hideSuggest(){
  suggestBox.style.display = "none";
  suggestBox.innerHTML = "";
}
document.addEventListener("click", (e) => {
  if (!e.target.closest(".searchWrap")) hideSuggest();
});

searchInput.addEventListener("input", () => buildSuggest(searchInput.value));
searchInput.addEventListener("focus", () => buildSuggest(searchInput.value));

function buildSuggest(raw){
  const term = norm(raw);
  if (term.length < 2){ hideSuggest(); return; }

  const cMatches = countriesForSearch()
    .filter(c => norm(c.name).includes(term) || norm(c.code).startsWith(term))
    .slice(0, 6)
    .map(c => ({
      type: "country",
      key: c.code,
      title: `${c.name} (${c.code})`,
      sub: c.continent_name || ""
    }));

  const eMatches = eventsForSearch()
    .filter(e => norm(e.title).includes(term) || norm(e.description).includes(term))
    .slice(0, 6)
    .map(e => ({
      type: "event",
      key: String(e.id),
      title: e.title || "(no title)",
      sub: e.country_code ? `${e.country_code} ‚Ä¢ ${countriesByCode[e.country_code]?.name || ""}` : ""
    }));

  const merged = [...cMatches, ...eMatches].slice(0, 10);
  if (!merged.length){ hideSuggest(); return; }

  suggestBox.innerHTML = merged.map(item => `
    <div class="sItem" data-type="${item.type}" data-key="${escapeHtml(item.key)}">
      <div class="sLeft">
        <div class="sTitle">${escapeHtml(item.title)}</div>
        <div class="sSub">${escapeHtml(item.sub)}</div>
      </div>
      <div class="tag">${item.type === "country" ? "Country" : "Event"}</div>
    </div>
  `).join("");

  suggestBox.style.display = "block";

  for (const el of suggestBox.querySelectorAll(".sItem")){
    el.addEventListener("click", async () => {
      const type = el.getAttribute("data-type");
      const key = el.getAttribute("data-key");
      hideSuggest();
      searchInput.value = "";

      if (type === "country") {
        await selectCountry(key);
        renderContinentCountries();
      } else {
        await openEvent(Number(key));
      }
    });
  }
}

/* ================== Country selection + events list ================== */
async function selectCountry(code){
  selectedCountryCode = code || "";
  selectedCountryName = countriesByCode[selectedCountryCode]?.name || selectedCountryCode;
  setCountryPill();
  setBigMapSelected(selectedCountryCode);

  countryTitle.textContent = `Events`;
  countrySubtitle.textContent = selectedCountryCode
    ? `${selectedCountryName} (${selectedCountryCode})`
    : "Select a country.";

  showScreen("COUNTRY");
  await loadEventsForCountry(selectedCountryCode);
}

async function loadEventsForCountry(code){
  eventsList.innerHTML = `<div class="muted" style="margin:0 16px;">${t("loading")}</div>`;

  if (!code){
    eventsList.innerHTML = `<div class="muted" style="margin:0 16px;">No country selected.</div>`;
    return;
  }

  const { data, error } = await supabaseClient
    .from("events")
    .select("id,title,description,country_code,created_at,is_active")
    .eq("is_active", true)
    .eq("country_code", code)
    .order("created_at", { ascending:false });

  if (error){
    console.error("loadEventsForCountry error:", error);
    eventsList.innerHTML = `<div class="muted" style="margin:0 16px;">Cannot load events.</div>`;
    return;
  }

  const list = data || [];

  // Load translations for current language + EN fallback
  try{
    const ids = list.map(e => e.id);
    const langs = Array.from(new Set([currentLang, "en"].filter(Boolean)));
    await loadEventTranslations(ids, langs);
  }catch(e){}
  
  if (!list.length){
    eventsList.innerHTML = `<div class="muted" style="margin:0 16px;">${t("no_events")}</div>`;
    return;
  }

  const now = Date.now();
  const isEnded = (e) => {
    try{
      if (e.is_active === false) return true;
      if (!e.ends_at) return false;
      const d = new Date(e.ends_at);
      return (!isNaN(d) && d.getTime() <= now);
    }catch(err){ return false; }
  };

  const top = list.filter(e => (e.is_top === true) && !isEnded(e))
                  .sort((a,b) => new Date(b.created_at) - new Date(a.created_at));

  const active = list.filter(e => !(e.is_top === true) && !isEnded(e))
                     .sort((a,b) => new Date(b.created_at) - new Date(a.created_at));

  const ended = list.filter(e => isEnded(e))
                    .sort((a,b) => new Date(b.created_at) - new Date(a.created_at));

  function dateLabel(iso){
    try{
      const d = new Date(iso);
      if (isNaN(d)) return "";
      return d.toLocaleDateString(undefined, { year:"numeric", month:"short", day:"2-digit" });
    }catch(e){ return ""; }
  }

  function renderItem(e){
    const endedFlag = isEnded(e);
    const endText = e.ends_at ? (endedFlag ? t("ended_on",{date: dateLabel(e.ends_at)}) : t("ends_on",{date: dateLabel(e.ends_at)})) : "";
    return `
      <div class="eventItem" data-id="${e.id}">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
        <strong>${escapeHtml(getEventText(e, "title") || "")}</strong>
        <div style="display:flex; gap:8px; align-items:center;">
          ${fallbackBadgeHTML(e)}
          ${endedFlag ? `<span class="pill" style="background:#f2f2f2;border-color:#e6e6e6;">${escapeHtml(t("event_closed"))}</span>` : ""}
        </div>
      </div>
    `;
  }

  let html = "";
  if (top.length){
    html += `<div class="muted" style="margin:0 16px 10px; font-weight:600;">${escapeHtml(t("top"))}</div>`;
    html += top.map(renderItem).join("");
  }

  if (active.length){
    html += `<div class="muted" style="margin:18px 16px 10px; font-weight:600;">${escapeHtml(t("active_events"))}</div>`;
    html += active.map(renderItem).join("");
  }

  if (ended.length){
    html += `<div style="margin:18px 16px 10px; border-top:1px solid #eee;"></div>`;
    html += `<div class="muted" style="margin:10px 16px 10px; font-weight:600;">${escapeHtml(t("ended_events"))}</div>`;
    html += ended.map(renderItem).join("");
  }

  eventsList.innerHTML = html;

  for (const el of eventsList.querySelectorAll(".eventItem")){
    el.addEventListener("click", async () => {
      const eid = Number(el.getAttribute("data-id"));
      await openEvent(eid);
    });
  }

  setBigMapSelected(selectedCountryCode);

}

/* ================== Event detail ================== */
async function openEvent(id){
  if (!id) return;
  currentEventId = id;

  // Try cache first
  let evt = eventsCache.find(x => x.id === id);
  if (!evt){
    const { data, error } = await supabaseClient
      .from("events")
      .select("id,title,description,country_code,created_at,is_active")
      .eq("id", id)
      .maybeSingle();
    if (error || !data) return;
    evt = data;
  }

  // Ensure translations are available (currentLang + EN fallback)
  try{ await loadEventTranslations([evt.id], Array.from(new Set([currentLang, "en"].filter(Boolean)))); }catch(e){}

  // ensure country pill sync
  if (evt.country_code){
    selectedCountryCode = evt.country_code;
    selectedCountryName = countriesByCode[selectedCountryCode]?.name || selectedCountryCode;
    setCountryPill();
    setBigMapSelected(selectedCountryCode);
  }

    eventTitle.textContent = getEventText(evt, "title") || "‚Äî";
  const cName = evt.country_code ? (countriesByCode[evt.country_code]?.name || "") : "";
  eventMeta.textContent = evt.country_code ? `Country: ${cName} (${evt.country_code})` : "";
  try{
    const d = currentEventEndsAt ? new Date(currentEventEndsAt) : null;
    if (d && !isNaN(d)){
      const ds = d.toLocaleDateString(undefined, { year:"numeric", month:"short", day:"2-digit" });
      const ended = (d.getTime() <= Date.now());
      eventMeta.textContent += " ‚Ä¢ " + (ended ? t("ended_on", {date: ds}) : t("ends_on", {date: ds}));
    }
  }catch(e){}
  const badgeWrap = document.getElementById("eventLangBadge");
if (badgeWrap) badgeWrap.remove();
const h2 = document.getElementById("eventTitle");
if (h2){
  const span = document.createElement("span");
  span.id = "eventLangBadge";
  span.style.marginLeft = "10px";
  span.innerHTML = fallbackBadgeHTML(evt);
  h2.parentElement.appendChild(span);
}


    eventDesc.textContent = getEventText(evt, "description") || "";

  currentEventCountryCode = evt.country_code || null;
  currentEventEndsAt = evt.ends_at || null;

  showScreen("EVENT");
  initMiniMap();
  updateMiniMap(currentEventCountryCode || "");
  await refreshStats(currentEventId, currentEventCountryCode || "");
  await refreshVoteArea(currentEventId, currentEventCountryCode || "");
  renderContinentCountries();
}

/* ================== Data loading ================== */
async function loadContinents(){
  const { data, error } = await supabaseClient.from("continents").select("id,name").order("id", { ascending:true });
  if (error){ console.error("loadContinents error:", error); continentsById = {}; return; }
  continentsById = {};
  for (const c of (data || [])) continentsById[c.id] = c.name;
}

async function loadCountries(){
  const { data, error } = await supabaseClient
    .from("countries")
    .select("code,name,continent_id")
    .order("name", { ascending:true });

  if (error){ console.error("loadCountries error:", error); countries = []; countriesByCode = {}; return; }

  countries = (data || []).map(c => ({
    ...c,
    continent_name: continentsById[c.continent_id] || ""
  }));

  countriesByCode = {};
  for (const c of countries) countriesByCode[c.code] = c;

  // Populate registration country dropdown
  if (regCountry){
    regCountry.innerHTML = '<option value="">Select your country</option>' +
      countries.map(c => `<option value="${c.code}">${escapeHtml(c.name)} (${c.code})</option>`).join("");
  }
}

async function loadEventsCache(){
  const { data, error } = await supabaseClient
    .from("events")
    .select("id,title,description,country_code,is_active,created_at")
    .eq("is_active", true)
    .order("created_at", { ascending:false })
    .limit(1000);

  if (error){ console.error("loadEventsCache error:", error); eventsCache = []; return; }
  eventsCache = data || [];
}

/* ================== TOP 3 ==================
   Best practice is to use a DB view/RPC for vote counts.
   This code tries a view "event_vote_counts" first (event_id, votes).
   If it doesn't exist, it falls back to counting the latest 5000 votes client-side.
*/
async function loadTop3(){
  if (!top3Box) return;
  top3Box.textContent = "Loading‚Ä¶";

  // Attempt 1: view with precomputed counts
  try{
    const r = await supabaseClient
      .from("event_vote_counts")
      .select("event_id,votes")
      .order("votes", { ascending:false })
      .limit(3);

    if (!r.error && r.data && r.data.length){
      renderTop3FromCounts(r.data.map(x => ({ event_id: x.event_id, votes: x.votes })));
      return;
    }
  }catch(e){}

  // Attempt 2: fallback - count latest votes client-side
  const { data, error } = await supabaseClient
    .from("votes")
    .select("event_id")
    .order("created_at", { ascending:false })
    .limit(5000);

  if (error){
    console.error("loadTop3 votes fallback error:", error);
    top3Box.textContent = "Cannot load Top 3 (check votes SELECT policy).";
    return;
  }

  const counts = {};
  for (const row of (data || [])){
    const id = row.event_id;
    counts[id] = (counts[id] || 0) + 1;
  }

  const top = Object.entries(counts)
    .map(([event_id, votes]) => ({ event_id: Number(event_id), votes }))
    .sort((a,b) => b.votes - a.votes)
    .slice(0,3);

  if (!top.length){
    top3Box.textContent = "No votes yet.";
    return;
  }

  renderTop3FromCounts(top);
}

function renderTop3FromCounts(items){
  if (!top3Box) return;

  // Join with eventsCache (already loaded)
  const enriched = items.map(it => {
    const evt = eventsCache.find(e => e.id === it.event_id);
    return {
      ...it,
      title: evt?.title || `Event #${it.event_id}`,
      country_code: evt?.country_code || "",
      description: evt?.description || ""
    };
  });

  top3Box.innerHTML = enriched.map((e, idx) => {
    const cName = e.country_code ? (countriesByCode[e.country_code]?.name || "") : "";
    return `
      <div class="topItem" data-eid="${e.event_id}">
        <strong>${escapeHtml((idx+1) + ". " + e.title)}</strong>
        <div class="topMeta">
          Votes: <strong>${e.votes}</strong>
          ${e.country_code ? ` ‚Ä¢ ${escapeHtml(cName)} (${escapeHtml(e.country_code)})` : ""}
        </div>
        ${e.description ? `<div class="topMeta">${escapeHtml(e.description)}</div>` : ""}
      </div>
    `;
  }).join("");

  for (const el of top3Box.querySelectorAll(".topItem")){
    el.addEventListener("click", async () => {
      const eid = Number(el.getAttribute("data-eid"));
      await openEvent(eid);
    });
  }
}


/* ================== Map ================== */
function initMap(){
  map = new mapboxgl.Map({
    container: "map",
    style: "mapbox://styles/mapbox/light-v11",
    center: [10, 20],
    zoom: 1.2
  });

  map.on("load", () => {
    // apply continent view after style loads
    setTimeout(() => applyContinentView(), 0);

    map.addSource("countryBoundaries", { type:"vector", url:"mapbox://mapbox.country-boundaries-v1" });

    map.addLayer({
      id: "country-fill",
      type: "fill",
      source: "countryBoundaries",
      "source-layer": "country_boundaries",
      paint: { "fill-color":"#000", "fill-opacity":0.05 }
    });

    map.addLayer({
      id: "country-selected",
      type: "fill",
      source: "countryBoundaries",
      "source-layer": "country_boundaries",
      paint: { "fill-color":"#000", "fill-opacity":0.18 },
      filter: ["==", ["get","iso_3166_1"], ""]
    });

    let hoveredISO = "";
    map.addLayer({
      id: "country-hover",
      type: "fill",
      source: "countryBoundaries",
      "source-layer": "country_boundaries",
      paint: { "fill-color":"#000", "fill-opacity":0.12 },
      filter: ["==", ["get","iso_3166_1"], ""]
    });

    map.on("mousemove", "country-fill", (e) => {
      const iso = e.features?.[0]?.properties?.iso_3166_1 || "";
      if (iso !== hoveredISO){
        hoveredISO = iso;
        map.setFilter("country-hover", ["==", ["get","iso_3166_1"], hoveredISO]);
      }
      map.getCanvas().style.cursor = "pointer";
    });

    map.on("mouseleave", "country-fill", () => {
      hoveredISO = "";
      map.setFilter("country-hover", ["==", ["get","iso_3166_1"], ""]);
      map.getCanvas().style.cursor = "";
    });

    map.on("click", "country-fill", async (e) => {
      const iso = e.features?.[0]?.properties?.iso_3166_1 || "";
      if (!iso) return;

      // If continent filter is active, ignore clicks outside it
      if (selectedContinent !== "ALL"){
        const cont = continentOfCountry(iso);
        if (cont !== selectedContinent){
          // brief feedback
          console.log("Country outside selected continent:", iso, cont, "selected:", selectedContinent);
          return;
        }
      }

      await selectCountry(iso);
    });
  });
}

function setBigMapSelected(code){
  if (!map || !map.getLayer("country-selected")) return;
  map.setFilter("country-selected", ["==", ["get","iso_3166_1"], code || ""]);
}

/* ================== INIT ================== */
(async function init(){
  // default pills
  setContinentPill();
  setCountryPill();


  // If arriving from email confirmation, Supabase may include ?code=... (PKCE)
  // Try exchanging the code for a session.
  try{
    const url = new URL(window.location.href);
    const code = url.searchParams.get("code");
    if (code){
      const { data, error } = await supabaseClient.auth.exchangeCodeForSession(code);
      if (!error){
        currentSession = data.session || null;
        currentUser = data.user || currentSession?.user || null;
        // Clean URL (remove code params)
        url.searchParams.delete("code");
        url.searchParams.delete("type");
        window.history.replaceState({}, document.title, url.toString());
      }
    }
  }catch(e){}

  // Read current session (if already logged in)
  const { data: sessData } = await supabaseClient.auth.getSession();
  currentSession = sessData.session || null;
  currentUser = currentSession?.user || null;
  setAuthUI();

  // Language: stored -> profile -> metadata -> default
  try{
    let lang = "en";
    const stored = getStoredLang();
    if (stored && I18N && I18N[stored]) lang = stored;

    if (currentUser){
      const prof = await getMyProfile();
      const fromProfile = (prof?.language || currentUser.user_metadata?.language || "");
      if (!stored && fromProfile && I18N && I18N[fromProfile]) lang = fromProfile;
    }

    currentLang = (I18N && I18N[lang]) ? lang : "en";
    const ls = document.getElementById("langSelect");
    if (ls) ls.value = currentLang;
    applyI18n();
  }catch(e){
    currentLang = "en";
    const ls = document.getElementById("langSelect");
    if (ls) ls.value = "en";
    applyI18n();
  }

  // Language selector: apply + save + refresh
  try{
    const langSel = document.getElementById("langSelect");
    if (langSel){
      langSel.onchange = async () => {
        const lang = (langSel.value || "en").toLowerCase();
        currentLang = (I18N && I18N[lang]) ? lang : "en";
        setStoredLang(currentLang);

        // Save preference if logged in (best-effort)
        if (currentUser){
          try{
            let r1 = await supabaseClient.from("profiles").update({ language: currentLang }).eq("id", currentUser.id);
            let err = r1.error || null;
            if (err){
              let r2 = await supabaseClient.from("profiles").update({ language: currentLang }).eq("user_id", currentUser.id);
              err = r2.error || null;
            }
            if (err) console.warn("save language error:", err);
          }catch(e){}
        }

        // Refresh page so everything re-renders in selected language
        location.reload();
      };
    }
  }catch(e){}


  // Upsert profile after verification/login using user_metadata
  if (currentUser){
    const meta = currentUser.user_metadata || {};
    const cc = meta.country_code;
    const lang = meta.language;
    if (cc || lang){
      // Try upsert into profiles (some schemas use id, others user_id)
      let pErr = null;
      try{
        const r1 = await supabaseClient
          .from("profiles")
          .upsert([{ id: currentUser.id, country_code: cc || null, language: lang || null }], { onConflict: "id" });
        pErr = r1.error || null;
      }catch(e){
        pErr = { message: String(e) };
      }

      if (pErr){
        try{
          const r2 = await supabaseClient
            .from("profiles")
            .upsert([{ user_id: currentUser.id, country_code: cc || null, language: lang || null }], { onConflict: "user_id" });
          pErr = r2.error || null;
        }catch(e){
          pErr = { message: String(e) };
        }
      }
      if (pErr) console.warn("profiles upsert error:", pErr);
    }
  }

  // If hash indicates verified, show confirmation screen briefly.
  if (window.location.hash === "#verified"){
    showScreen("VERIFIED");
    setTimeout(() => showScreen("HOME"), 2200);
  }


  await loadContinents();
  await loadCountries();
  await loadEventsCache();

  await loadTop3();

  initMap();
  renderContinentCountries();
  applyContinentView();
})();

// Auth state listener
supabaseClient.auth.onAuthStateChange((event, session) => {
  currentSession = session || null;
  currentUser = session?.user || null;
  setAuthUI();
  // If user logs in/out while viewing an event, refresh vote/stats UI
  try{
    const ev = document.getElementById("screenEvent");
    if (ev && ev.classList.contains("active") && currentEventId){
      refreshVoteArea(currentEventId, currentEventCountryCode || "");
      refreshStats(currentEventId, currentEventCountryCode || "");
    }
  }catch(e){}

});

</script>
</body>
</html>
