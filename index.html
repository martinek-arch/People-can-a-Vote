<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<title>People can a Vote</title>

<link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet"/>

<style>
  body { margin:0; font-family:Arial, sans-serif; background:#f4f6f8; }
  header { background:#fff; padding:20px; box-shadow:0 2px 4px rgba(0,0,0,.1); }
  section { padding:20px; }
  .card { background:#fff; padding:15px; border-radius:8px; margin:20px; }
  .event { background:#fff; padding:12px; border-radius:8px; margin:10px 20px; cursor:pointer; }
  .row { display:flex; gap:10px; flex-wrap:wrap; }
  input, select { padding:8px; min-width:240px; }
  button { padding:8px 14px; cursor:pointer; }
  #map { height:450px; margin-top:10px; }
  .muted { color:#666; }
</style>
</head>

<body>

<header>
  <h1>People can a Vote</h1>
  <p class="muted">Global view of opinions from around the world</p>
</header>

<!-- AUTH -->
<section class="card" id="auth">
  <div id="auth-forms">
    <h3>P≈ôihl√°≈°en√≠ / Registrace</h3>
    <div class="row">
      <input id="email" type="email" placeholder="Email">
      <input id="password" type="password" placeholder="Heslo">
      <select id="country-select">
        <option value="">Naƒç√≠t√°m zemƒõ‚Ä¶</option>
      </select>
    </div>
    <div class="row" style="margin-top:10px;">
      <button id="signup-btn">Registrovat</button>
      <button id="login-btn">P≈ôihl√°sit</button>
    </div>
    <p id="auth-error" style="color:#b00020; margin-top:10px;"></p>
  </div>

  <div id="auth-logged" style="display:none;">
    <div class="row" style="align-items:center;">
      <span id="auth-message"></span>
      <span id="auth-country" class="muted"></span>
      <button id="logout-btn">Odhl√°sit</button>
    </div>
    <p id="auth-hint" class="muted" style="margin-top:10px;"></p>
  </div>
</section>

<!-- EVENTS -->
<section>
  <h2 style="margin:0 20px;">Hlasovac√≠ ud√°losti</h2>
  <div id="events"></div>
</section>

<!-- VOTE -->
<section class="card" id="vote-section">
  <h3 id="vote-title" style="margin-top:0;">Vyber ud√°lost</h3>

  <div id="vote-buttons" style="display:none;">
    <div class="row">
      <button id="vote-yes">Ano</button>
      <button id="vote-no">Ne</button>
      <button id="vote-neutral">Nem√°m n√°zor</button>
    </div>
  </div>

  <p id="vote-message" style="margin-top:10px;"></p>
</section>

<!-- STATS -->
<section class="card">
  <h3 style="margin-top:0;">Statistiky</h3>
  <div id="vote-stats" class="muted">Zat√≠m nejsou data.</div>
</section>

<div id="map"></div>

<script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<script>
/* ================== KONFIG ================== */
const supabaseClient = supabase.createClient(
  'https://jqoomnhpyuikbntnrukw.supabase.co',
  'sb_publishable_SjZ_HQWN0XRE9ebbf_OwQg_kmJeS43h'
);

mapboxgl.accessToken =
  'pk.eyJ1IjoiaGVyZ290dCIsImEiOiJjbWttdHQ3cmYwZ2hmM2pyMjd2bmk1c3ZmIn0.-9CViuw1h3-gy49EsKvFiQ';

/* ================== STAV ================== */
let currentEventId = null;
let currentEventCountryCode = null;   // zemƒõ ud√°losti (nap≈ô. GL)
let currentUserCountryCode = null;    // zemƒõ u≈æivatele z profiles

/* ================== ELEMENTY ================== */
const voteButtons = document.getElementById('vote-buttons');
const voteMessage = document.getElementById('vote-message');
const voteStats = document.getElementById('vote-stats');
const voteTitle = document.getElementById('vote-title');

const authForms = document.getElementById('auth-forms');
const authLogged = document.getElementById('auth-logged');
const authMessage = document.getElementById('auth-message');
const authCountry = document.getElementById('auth-country');
const authHint = document.getElementById('auth-hint');
const authError = document.getElementById('auth-error');

const email = document.getElementById('email');
const password = document.getElementById('password');
const countrySelect = document.getElementById('country-select');

voteButtons.style.display = 'none';

/* ================== POMOCN√â ================== */
function setAuthError(msg) { authError.textContent = msg || ''; }
function setVoteMessage(msg) { voteMessage.textContent = msg || ''; }

/* ================== NAƒåTI ZEMƒö DO SELECTU ================== */
async function loadCountriesForSelect() {
  // Aby tohle fungovalo, mus√≠ b√Ωt na `countries` povolen√Ω SELECT pro anon/authenticated.
  const { data, error } = await supabaseClient
    .from('countries')
    .select('code, name')
    .order('name', { ascending: true });

  if (error) {
    countrySelect.innerHTML = '<option value="">Zemƒõ nelze naƒç√≠st</option>';
    return;
  }

  const opts = ['<option value="">Vyber zemi (pro registraci)</option>'];
  for (const c of data) {
    opts.push(`<option value="${c.code}">${c.name} (${c.code})</option>`);
  }
  countrySelect.innerHTML = opts.join('');
}

/* ================== AUTH ================== */
document.getElementById('login-btn').onclick = async () => {
  setAuthError('');
  const { error } = await supabaseClient.auth.signInWithPassword({
    email: email.value,
    password: password.value
  });
  if (error) setAuthError(error.message);
};

document.getElementById('signup-btn').onclick = async () => {
  setAuthError('');

  const selected = countrySelect.value;
  if (!selected) {
    setAuthError('P≈ôi registraci vyber svoji zemi.');
    return;
  }

  const { error: signUpErr } = await supabaseClient.auth.signUp({
    email: email.value,
    password: password.value
  });

  if (signUpErr) {
    setAuthError(signUpErr.message);
    return;
  }

  // Po registraci se rovnou p≈ôihl√°s√≠me (pokud m√°≈° vypnut√© email potvrzen√≠).
  const { error: signInErr } = await supabaseClient.auth.signInWithPassword({
    email: email.value,
    password: password.value
  });

  if (signInErr) {
    // Pokud bys mƒõl zapnut√© potvrzen√≠ emailu, tady se to m≈Ø≈æe zastavit.
    setAuthError(signInErr.message);
    authHint.textContent = 'Pokud m√°≈° zapnut√© potvrzen√≠ emailu, mus√≠≈° nejd≈ô√≠v potvrdit registraci.';
    return;
  }

  // Vytvo≈ô√≠me profil s vybranou zem√≠
  const { data: sess } = await supabaseClient.auth.getSession();
  const user = sess.session?.user;
  if (!user) return;

  const { error: profErr } = await supabaseClient
    .from('profiles')
    .insert([{ id: user.id, country_code: selected }]);

  // Kdy≈æ u≈æ profil existuje, insert m≈Ø≈æe selhat ‚Äì to nevad√≠.
  if (profErr && profErr.code !== '23505') {
    setAuthError(profErr.message);
  }
};

document.getElementById('logout-btn').onclick = async () => {
  await supabaseClient.auth.signOut();
};

/* Kdy≈æ se zmƒõn√≠ auth stav, v≈ædy srovn√°me UI a zkontrolujeme hlas */
supabaseClient.auth.onAuthStateChange(async () => {
  await updateAuthUI();
  if (currentEventId) await refreshVoteUI();
});

/* ================== UI / PROFIL ================== */
async function loadMyProfile() {
  currentUserCountryCode = null;

  const { data: sess } = await supabaseClient.auth.getSession();
  const user = sess.session?.user;
  if (!user) return;

  const { data, error } = await supabaseClient
    .from('profiles')
    .select('country_code')
    .eq('id', user.id)
    .maybeSingle();

  if (!error && data?.country_code) currentUserCountryCode = data.country_code;
}

async function updateAuthUI() {
  const { data } = await supabaseClient.auth.getSession();
  const user = data.session?.user;

  if (user) {
    authForms.style.display = 'none';
    authLogged.style.display = 'block';
    authMessage.textContent = `P≈ôihl√°≈°en jako: ${user.email}`;
    authHint.textContent = '';

    await loadMyProfile();
    authCountry.textContent = currentUserCountryCode ? `Zemƒõ: ${currentUserCountryCode}` : 'Zemƒõ: (nenastavena)';
  } else {
    authForms.style.display = 'block';
    authLogged.style.display = 'none';
    authMessage.textContent = '';
    authCountry.textContent = '';
    authHint.textContent = '';
    currentUserCountryCode = null;

    voteButtons.style.display = 'none';
    setVoteMessage('');
  }
}

/* ================== UD√ÅLOSTI ================== */
async function loadEvents() {
  const { data, error } = await supabaseClient
    .from('events')
    .select('id, title, description, country_id')
    .eq('is_active', true);

  if (error) return;

  const eventsDiv = document.getElementById('events');
  eventsDiv.innerHTML = '';

  if (!data.length) {
    eventsDiv.innerHTML = '<p class="muted" style="margin:0 20px;">≈Ω√°dn√© aktivn√≠ ud√°losti.</p>';
    return;
  }

  // nastav√≠me defaultn√≠ ud√°lost
  currentEventId = data[0].id;

  for (const e of data) {
    const div = document.createElement('div');
    div.className = 'event';
    div.innerHTML = `<strong>${e.title}</strong><div class="muted" style="margin-top:4px;">${e.description || ''}</div>`;
    div.onclick = async () => {
      currentEventId = e.id;
      await refreshVoteUI();
    };
    eventsDiv.appendChild(div);
  }

  await refreshVoteUI();
}

/* ================== REFRESH VOTE UI (KL√çƒåOV√â) ================== */
async function refreshVoteUI() {
  voteButtons.style.display = 'none';
  setVoteMessage('');
  voteTitle.textContent = 'Hlasov√°n√≠';

  if (!currentEventId) return;

  // 1) zjist√≠me zemi ud√°losti (country_code)
  const { data: evt, error: evtErr } = await supabaseClient
    .from('events')
    .select('id, title, country_id, countries(code, name)')
    .eq('id', currentEventId)
    .maybeSingle();

  if (evtErr || !evt) return;

  currentEventCountryCode = evt.countries?.code || null;
  voteTitle.textContent = evt.title || 'Hlasov√°n√≠';

  // 2) naƒçteme statistiky (funguje i pro nep≈ôihl√°≈°en√©)
  await loadVoteStats(currentEventId, currentEventCountryCode);

  // 3) pokud nen√≠ p≈ôihl√°≈°en√Ω u≈æivatel, konec
  const { data: sess } = await supabaseClient.auth.getSession();
  const user = sess.session?.user;
  if (!user) {
    setVoteMessage('Pro hlasov√°n√≠ se p≈ôihlas.');
    return;
  }

  // 4) naƒçteme profil (zemƒõ u≈æivatele) pokud je≈°tƒõ nen√≠
  if (!currentUserCountryCode) await loadMyProfile();

  // 5) zkontrolujeme, jestli u≈æ hlasoval
  await checkUserVote(currentEventId);
}

/* ================== CHECK VOTE ================== */
async function checkUserVote(eventId) {
  voteButtons.style.display = 'none';
  setVoteMessage('');

  const { data } = await supabaseClient.auth.getSession();
  const user = data.session?.user;
  if (!user) return;

  const { data: existing, error } = await supabaseClient
    .from('votes')
    .select('vote')
    .eq('user_id', user.id)
    .eq('event_id', eventId)
    .maybeSingle();

  if (!error && existing) {
    setVoteMessage(`U≈æ jste hlasoval (${existing.vote}).`);
    voteButtons.style.display = 'none';
  } else {
    voteButtons.style.display = 'block';
  }
}

/* ================== SUBMIT VOTE ================== */
async function submitVote(value) {
  setVoteMessage('');

  const { data } = await supabaseClient.auth.getSession();
  const user = data.session?.user;
  if (!user) {
    setVoteMessage('Mus√≠≈° b√Ωt p≈ôihl√°≈°en.');
    return;
  }

  if (!currentUserCountryCode) await loadMyProfile();
  if (!currentUserCountryCode) {
    setVoteMessage('Nem√°≈° nastavenou zemi v profilu.');
    return;
  }

  const { error } = await supabaseClient.from('votes').insert({
    user_id: user.id,
    event_id: currentEventId,
    vote: value,
    country_code: currentUserCountryCode
  });

  if (error) {
    if (error.code === '23505') {
      setVoteMessage('U≈æ jste hlasoval pro tuto ud√°lost.');
      voteButtons.style.display = 'none';
    } else {
      setVoteMessage(error.message);
    }
    return;
  }

  voteButtons.style.display = 'none';
  setVoteMessage('Hlas ulo≈æen.');
  await refreshVoteUI();
}

/* BUTTONS */
document.getElementById('vote-yes').onclick = () => submitVote('Ano');
document.getElementById('vote-no').onclick = () => submitVote('Ne');
document.getElementById('vote-neutral').onclick = () => submitVote('Nem√°m n√°zor');

/* ================== STATS ================== */
async function loadVoteStats(eventId, eventCountryCode) {
  const { data, error } = await supabaseClient
    .from('votes')
    .select('vote, country_code')
    .eq('event_id', eventId);

  if (error) return;

  const total = data.length;
  const yes = data.filter(v => v.vote === 'Ano').length;
  const no = data.filter(v => v.vote === 'Ne').length;
  const neutral = data.filter(v => v.vote === 'Nem√°m n√°zor').length;

  const citizens = eventCountryCode
    ? data.filter(v => v.country_code === eventCountryCode).length
    : 0;

  const others = total - citizens;

  const pct = (n) => total ? Math.round((n / total) * 100) : 0;

  voteStats.innerHTML = `
    <div><strong>Celkem:</strong> ${total} hlas≈Ø</div>
    <div>‚úÖ Ano: ${yes} (${pct(yes)}%) | ‚ùå Ne: ${no} (${pct(no)}%) | ü§∑ Nem√°m n√°zor: ${neutral} (${pct(neutral)}%)</div>
    <div style="margin-top:8px;"><strong>Rozdƒõlen√≠ podle zemƒõ ud√°losti</strong> ${eventCountryCode ? '('+eventCountryCode+')' : ''}</div>
    <div>üè† Obƒçan√© zemƒõ: ${citizens} (${pct(citizens)}%)</div>
    <div>üåç Ostatn√≠ st√°ty: ${others} (${pct(others)}%)</div>
  `;
}

/* ================== MAP ================== */
const map = new mapboxgl.Map({
  container: 'map',
  style: 'mapbox://styles/mapbox/light-v11',
  center: [-42, 72],
  zoom: 2
});

/* ================== INIT ================== */
(async function init() {
  await loadCountriesForSelect();
  await updateAuthUI();
  await loadEvents();
})();
</script>

</body>
</html>
