<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>People Can Vote</title>
<style>
  :root {
    --muted:#5d6470;
    --border:#e5e7eb;
    --bg:#f7f8fb;
    --card:#ffffff;
    --text:#111827;
    --accent:#2563eb;
    --yes:#16a34a;
    --no:#dc2626;
    --dk:#f59e0b;
  }
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 0; background: var(--bg); color: var(--text); }
  main { padding: 20px 24px 64px; max-width: 1100px; margin: 0 auto; }
  h1 { margin: 12px 0 12px; }
  #boot { position: fixed; bottom: 10px; left: 10px; font-size: 12px; color: var(--muted);
          background: rgba(255,255,255,0.92); padding: 6px 8px; border-radius: 10px; border: 1px solid var(--border); }
  .row { display:flex; gap: 12px; align-items:center; flex-wrap:wrap; }
  .card { border: 1px solid var(--border); border-radius: 14px; padding: 12px; margin: 12px 0; background:var(--card); }
  .muted { color: var(--muted); }
  .hidden { display:none !important; }
  select, button, input { padding: 8px 10px; border-radius: 10px; border: 1px solid var(--border); background: white; }
  input { min-width: 260px; }
  button { cursor: pointer; }
  button.primary { font-weight: 800; }
  button.answer-yes { background: color-mix(in srgb, var(--yes) 14%, #fff); border-color: color-mix(in srgb, var(--yes) 40%, var(--border)); }
  button.answer-no { background: color-mix(in srgb, var(--no) 14%, #fff); border-color: color-mix(in srgb, var(--no) 40%, var(--border)); }
  button.answer-dk { background: color-mix(in srgb, var(--dk) 14%, #fff); border-color: color-mix(in srgb, var(--dk) 40%, var(--border)); }
  button.ghost { background: transparent; }
  button.link { border: none; background: transparent; padding: 0; text-decoration: underline; color: inherit; cursor: pointer; }
  button[disabled] { opacity: 0.55; cursor: not-allowed; }
  .list { display:flex; flex-direction:column; gap: 10px; }
  .eventTitle { font-weight:900; margin-bottom:4px; }
  .pill { display:inline-block; padding:2px 8px; border:1px solid var(--border); border-radius:999px; font-size:12px; color:#333; margin-left:6px; }
  .top3grid { display:flex; flex-direction:column; gap: 10px; }
  .top3Item { cursor:pointer; }
  .top3Meta { display:flex; align-items:center; gap:8px; margin-top:6px; }
  .top3Bar { flex:1; height:8px; border:1px solid var(--border); border-radius:999px; overflow:hidden; background:#f3f4f6; }
  .top3BarFill { height:100%; width:0%; background: var(--accent); }

  /* navbar */
  .nav {
    position: sticky; top: 0; z-index: 10;
    border-bottom: 1px solid var(--border);
    background: rgba(255,255,255,0.97);
    backdrop-filter: blur(8px);
  }
  .navInner { max-width: 1100px; margin: 0 auto; padding: 10px 24px; display:flex; justify-content:space-between; align-items:center; gap: 12px; }
  .brand { font-weight: 900; letter-spacing: 0.2px; }
  .navRight { display:flex; align-items:center; gap: 8px; flex-wrap: wrap; justify-content:flex-end; }
  .small { font-size: 12px; }
  .navStatus { display:flex; flex-direction:column; align-items:flex-end; gap:2px; }
  .navHint { font-size:11px; color: var(--muted); }
  .searchWrap { display:flex; align-items:center; gap:6px; }
  .searchInput { min-width: 220px; }

  .subnav {
    border-bottom: 1px solid var(--border);
    background: #fff;
  }
  .subnavInner { max-width: 1100px; margin: 0 auto; padding: 10px 24px; display:flex; flex-direction:column; gap:10px; position: relative; }
  .continentTabs { display:flex; flex-wrap:wrap; gap:8px; }
  .continentBtn { border:1px solid var(--border); background:#fff; border-radius:999px; padding:6px 10px; cursor:pointer; }
  .continentBtn.active { font-weight:800; }
  .countryPopover {
    position: absolute;
    top: 52px;
    left: 24px;
    right: 24px;
    background: #fff;
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 10px;
    box-shadow: 0 12px 30px rgba(0,0,0,0.08);
    max-height: 240px;
    overflow-y: auto;
    display: none;
    z-index: 20;
  }
  .countryPopover.open { display: block; }
  .countryList { display:flex; flex-wrap:wrap; gap:8px; }
  .countryBtn { border:1px solid var(--border); background:#fff; border-radius:999px; padding:6px 10px; cursor:pointer; font-size:12px; }

  /* modal */
  .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.35); display:none; align-items:center; justify-content:center; z-index: 50; }
  .overlay.open { display:flex; }
  .modal { width: min(540px, calc(100vw - 32px)); background:#fff; border-radius: 16px; border:1px solid var(--border); box-shadow: 0 10px 30px rgba(0,0,0,0.18); }
  .modalHeader { display:flex; justify-content:space-between; align-items:center; padding: 12px 14px; border-bottom:1px solid var(--border); }
  .modalTitle { font-weight: 900; }
  .modalBody { padding: 14px; }
  .field { display:flex; flex-direction:column; gap:6px; margin-bottom: 12px; }
  .actions { display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap; }
  .actionsRight { display:flex; gap:10px; align-items:center; justify-content:flex-end; flex-wrap:wrap; }
  .tabs { display:flex; gap:8px; flex-wrap:wrap; }
  .tab { border:1px solid var(--border); border-radius: 999px; padding: 6px 10px; cursor:pointer; background:#fff; }
  .tab.active { font-weight: 800; }
  .msg { margin-top: 10px; }

  /* Voting answers + result blocks */
  .answers { display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; }
  .answers button { font-weight:800; }
  .resultsWrap { margin-top: 12px; display:flex; flex-direction:column; gap:10px; }
  .resultBlock { border:1px solid var(--border); border-radius: 14px; padding:10px; background:#fff; }
  .resultBlock.large { padding:12px; }
  .resultBlock.medium { padding:10px; opacity:0.98; transform: scale(0.985); transform-origin: left top; }
  .resultBlock.small { padding:9px; opacity:0.96; transform: scale(0.97); transform-origin: left top; }
  .resultTitle { font-weight:900; margin-bottom:8px; }
  .resultBlock.large .resultTitle { font-size: 18px; }
  .rowBar { display:grid; grid-template-columns: 58px 1fr 62px; gap:10px; align-items:center; margin:6px 0; }
  .bar { height:10px; border:1px solid var(--border); border-radius:999px; overflow:hidden; background:#fafafa; }
  .barFill { height:100%; width:0%; background:#111; }
  .barFill[data-k="yes"] { background: var(--yes); }
  .barFill[data-k="no"] { background: var(--no); }
  .barFill[data-k="dk"] { background: var(--dk); }
  .pct { text-align:right; font-variant-numeric: tabular-nums; }
  .countLine { margin-top:6px; font-size:12px; color: var(--muted); }
  .view { display:none; }
  .view.active { display:block; }
  .mapPlaceholder { border:1px dashed var(--border); border-radius:14px; padding:18px; text-align:center; color: var(--muted); }
  .eventItem { cursor:pointer; }
  .eventDetailHeader { display:flex; justify-content:space-between; align-items:flex-start; flex-wrap:wrap; gap:10px; }
  .eventQuestion { font-size: 20px; font-weight: 800; color: var(--accent); margin-top: 6px; }
  .eventStatus { font-weight:700; font-size:13px; padding:5px 12px; border-radius:999px; border:1px solid var(--border); background:#fff; }
  .eventStatus.active { border-color: color-mix(in srgb, var(--yes) 40%, var(--border)); color: var(--yes); }
  .eventStatus.closed { border-color: var(--border); color: var(--muted); }
  .eventTitleRow { display:flex; justify-content:space-between; align-items:flex-start; gap:10px; }
  .eventVotedPill { margin-left:auto; white-space:nowrap; }
  .top3TitleRow { display:flex; justify-content:space-between; align-items:flex-start; gap:10px; }
  .top3VotedPill { margin-left:auto; white-space:nowrap; }
  .eventMetaRow { display:grid; grid-template-columns: 1fr auto; align-items:center; gap:12px; margin-top:6px; }
  .eventMetaRow.single { grid-template-columns: 1fr; }
  .eventCountry { font-weight:600; }
  .eventRemaining { text-align:right; }
  .eventHeaderRight { display:flex; flex-direction:column; align-items:flex-end; gap:6px; }
  .eventCountryRow { display:flex; justify-content:flex-end; margin-top:6px; }
  .eventCountryHeader { font-weight:600; }
  .votedBadge { display:inline-block; font-weight:700; color: var(--accent); border:1px solid color-mix(in srgb, var(--accent) 30%, var(--border)); border-radius:999px; padding:4px 10px; background:#f1f5ff; }
  .backBtn { border:1px solid var(--border); border-radius:999px; padding:7px 12px; background:#fff; cursor:pointer; font-size:13px; }

</style>
</head>
<body>

<div class="nav">
  <div class="navInner">
    <div class="row" style="gap:10px;">
      <span class="brand">People Can Vote</span>
      <button id="homeBtn" class="ghost">Domů</button>
    </div>
    <div class="navRight">
      <div class="searchWrap">
        <input id="globalSearch" class="searchInput" type="search" placeholder="Hledat zemi nebo událost">
        <datalist id="searchOptions"></datalist>
      </div>
      <div class="navStatus">
        <span id="navUser" class="muted small">Načítání…</span>
        <span id="navHint" class="navHint"></span>
      </div>
      <button id="loginNavBtn">Přihlásit</button>
      <button id="registerNavBtn">Registrovat</button>
      <button id="changePassNavBtn" class="hidden">Změnit heslo</button>
      <button id="logoutNavBtn" class="hidden">Odhlásit</button>
    </div>
  </div>
</div>

<div class="subnav">
  <div class="subnavInner">
    <div id="continentTabs" class="continentTabs"></div>
    <div id="countryPopover" class="countryPopover">
      <div id="countryList" class="countryList"></div>
    </div>
  </div>
</div>

<main>
  <section id="homeView" class="view active">
    <h1 id="homeTitle">Vyber zemi</h1>

    <div class="card">
      <div class="row" style="justify-content:space-between;">
        <b>TOP 3 události (nejvíc hlasujících)</b>
        <button id="refreshTop3Btn">Obnovit</button>
      </div>
      <div id="top3" class="top3grid" style="margin-top:10px;"></div>
    </div>

    <div class="card">
      <div class="row" style="justify-content:space-between;">
        <b>Interaktivní mapa světa</b>
      </div>
      <div class="mapPlaceholder" style="margin-top:10px;">
        Mapa světa se připravuje. Po spuštění bude možné kliknout na zemi a zobrazit její události.
      </div>
    </div>
  </section>

  <section id="countryView" class="view">
    <div class="eventDetailHeader">
      <div>
        <h1 id="countryTitle">Země</h1>
        <div id="countrySubtitle" class="muted">Výběr země podle kontinentu</div>
      </div>
      <button id="backToHomeBtn" class="backBtn" type="button">Zpět na úvod</button>
    </div>

    <div class="card">
      <div class="row" style="justify-content:space-between;">
        <b>TOP událost v zemi</b>
      </div>
      <div id="countryTop" class="muted" style="margin-top:10px;">Načítání…</div>
    </div>

    <div class="card">
      <div class="row" style="justify-content:space-between;">
        <b>Aktivní události</b>
      </div>
      <div id="eventsActive" class="list" style="margin-top:10px;"></div>
    </div>

    <div class="card">
      <div class="row" style="justify-content:space-between;">
        <b>Archiv / ukončené hlasování</b>
      </div>
      <div id="eventsArchive" class="list" style="margin-top:10px;"></div>
    </div>
  </section>

  <section id="eventView" class="view">
    <div class="eventDetailHeader">
      <div>
        <h1 id="eventTitle">Událost</h1>
        <div id="eventMeta" class="muted"></div>
      </div>
      <div class="eventHeaderRight">
        <div class="row" style="gap:8px;">
          <span id="eventStatus" class="eventStatus">Aktivní</span>
          <button id="backToCountryBtn" class="backBtn" type="button">Zpět na zemi</button>
        </div>
      </div>
    </div>
    <div class="eventCountryRow">
      <div id="eventCountryHeader" class="eventCountryHeader muted"></div>
    </div>

    <div id="eventDetailCard" class="card"></div>
  </section>
</main>

<!-- AUTH MODAL -->
<div id="overlay" class="overlay" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="modalHeader">
      <div class="row" style="gap:10px;">
        <div id="modalTitle" class="modalTitle">Účet</div>
        <div class="tabs">
          <button id="tabLogin" class="tab active" type="button">Přihlášení</button>
          <button id="tabRegister" class="tab" type="button">Registrace</button>
          <button id="tabUpdate" class="tab hidden" type="button">Nové heslo</button>
        </div>
      </div>
      <button id="closeModalBtn" class="ghost" type="button" aria-label="Zavřít">✕</button>
    </div>
    <div class="modalBody">
      <div class="field" id="emailField">
        <label for="authEmail"><b>Email</b></label>
        <input id="authEmail" type="email" autocomplete="email" placeholder="email@domena.cz">
      </div>

      <div class="field" id="passwordField">
        <label for="authPassword"><b>Heslo</b></label>
        <input id="authPassword" type="password" autocomplete="current-password" placeholder="••••••••">
        <div class="muted small">Doporučeno aspoň 8 znaků.</div>
      </div>

      <div class="field hidden" id="password2Field">
        <label for="authPassword2"><b>Heslo znovu</b></label>
        <input id="authPassword2" type="password" autocomplete="new-password" placeholder="••••••••">
      </div>

      <div class="actions">
        <div id="forgotWrap">
          <button id="forgotBtn" class="link" type="button">Zapomenuté heslo</button>
        </div>
        <div class="actionsRight">
          <button id="submitAuthBtn" class="primary" type="button">Přihlásit</button>
        </div>
      </div>

      <div id="authMsg" class="msg muted"></div>
    </div>
  </div>
</div>

<div id="boot">Booting…</div>

<script>
if (window.__PCV_INIT_DONE__) {
  console.warn("PCV: duplicate init prevented");
} else {
  window.__PCV_INIT_DONE__ = true;

  function boot(msg) {
    const el = document.getElementById("boot");
    if (el) el.textContent = msg;
    console.log(msg);
  }

  async function loadSupabase() {
    boot("Init: loading Supabase…");
    return new Promise((resolve, reject) => {
      const s = document.createElement("script");
      s.src = "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2";
      s.async = true;
      s.onload = () => resolve(window.supabase);
      s.onerror = () => reject(new Error("Supabase load failed"));
      document.head.appendChild(s);
      setTimeout(() => reject(new Error("Supabase load timeout")), 12000);
    });
  }

  const SUPABASE_URL = "https://jqoomnhpyuikbntnrukw.supabase.co";
  const SUPABASE_ANON_KEY = "sb_publishable_SjZ_HQWN0XRE9ebbf_OwQg_kmJeS43h";
  const APP_BASE_URL = "https://martinek-arch.github.io/People-can-a-Vote/";
  const MAPBOX_TOKEN = "pk.eyJIjoiaGVyZ290dCIsImEiOiJjbWttdHQ3cmYwZ2hmM2pyMjd2bmk1c3ZmIn0.-9CViuw1h3-gy49EsKvFiQ";

  let supabaseClient = null;
  let session = null;
  let isVerified = false;
  let cachedContinents = [];
  let cachedCountries = [];
  let searchIndex = new Map();
  let currentCountry = null;

  /* ===== Modal state ===== */
  // login | register | update
  let authMode = "login";

  const overlay = document.getElementById("overlay");
  const tabLogin = document.getElementById("tabLogin");
  const tabRegister = document.getElementById("tabRegister");
  const tabUpdate = document.getElementById("tabUpdate");
  const submitAuthBtn = document.getElementById("submitAuthBtn");
  const authMsg = document.getElementById("authMsg");
  const authEmail = document.getElementById("authEmail");
  const authPassword = document.getElementById("authPassword");
  const authPassword2 = document.getElementById("authPassword2");

  const emailField = document.getElementById("emailField");
  const passwordField = document.getElementById("passwordField");
  const password2Field = document.getElementById("password2Field");
  const forgotWrap = document.getElementById("forgotWrap");
  const forgotBtn = document.getElementById("forgotBtn");

  function openModal(mode) {
    authMode = mode;
    authMsg.textContent = "";
    authPassword.value = "";
    authPassword2.value = "";
    setModeUI();
    overlay.classList.add("open");
    overlay.setAttribute("aria-hidden", "false");
    setTimeout(() => {
      if (!emailField.classList.contains("hidden")) authEmail.focus();
      else authPassword.focus();
    }, 0);
  }
  function closeModal() {
    overlay.classList.remove("open");
    overlay.setAttribute("aria-hidden", "true");
    authMsg.textContent = "";
  }
  function setModeUI() {
    // tabs
    tabLogin.classList.toggle("active", authMode === "login");
    tabRegister.classList.toggle("active", authMode === "register");
    tabUpdate.classList.toggle("active", authMode === "update");

    // show update tab only when relevant
    const canShowUpdateTab = (authMode === "update");
    tabUpdate.classList.toggle("hidden", !canShowUpdateTab);

    if (authMode === "login") {
      submitAuthBtn.textContent = "Přihlásit";
      emailField.classList.remove("hidden");
      passwordField.classList.remove("hidden");
      password2Field.classList.add("hidden");
      forgotWrap.classList.remove("hidden");
      authPassword.setAttribute("autocomplete", "current-password");
    } else if (authMode === "register") {
      submitAuthBtn.textContent = "Registrovat";
      emailField.classList.remove("hidden");
      passwordField.classList.remove("hidden");
      password2Field.classList.remove("hidden");
      forgotWrap.classList.add("hidden");
      authPassword.setAttribute("autocomplete", "new-password");
      authPassword2.setAttribute("autocomplete", "new-password");
    } else {
      // update password (for logged-in "change password" OR recovery)
      submitAuthBtn.textContent = "Nastavit nové heslo";
      emailField.classList.add("hidden");
      passwordField.classList.remove("hidden");
      password2Field.classList.remove("hidden");
      forgotWrap.classList.add("hidden");
      authPassword.setAttribute("autocomplete", "new-password");
      authPassword2.setAttribute("autocomplete", "new-password");
    }
  }

  document.getElementById("closeModalBtn").onclick = closeModal;
  overlay.addEventListener("click", (e) => { if (e.target === overlay) closeModal(); });
  window.addEventListener("keydown", (e) => { if (e.key === "Escape" && overlay.classList.contains("open")) closeModal(); });

  tabLogin.onclick = () => { authMode = "login"; authMsg.textContent = ""; setModeUI(); };
  tabRegister.onclick = () => { authMode = "register"; authMsg.textContent = ""; setModeUI(); };

  async function runAuth() {
    const email = (authEmail.value || "").trim();
    const p1 = authPassword.value || "";
    const p2 = authPassword2.value || "";

    if (authMode !== "update") {
      if (!email) { authMsg.textContent = "Zadej email."; return; }
    }
    if (p1.length < 8) { authMsg.textContent = "Heslo musí mít alespoň 8 znaků."; return; }
    if (authMode !== "login") {
      if (p1 !== p2) { authMsg.textContent = "Hesla se neshodují."; return; }
    }

    submitAuthBtn.disabled = true;
    authMsg.textContent = authMode === "login" ? "Přihlašuji…" : (authMode === "register" ? "Registruji…" : "Nastavuji nové heslo…");
    boot("Auth: working…");

    try {
      if (authMode === "login") {
        const { error } = await supabaseClient.auth.signInWithPassword({ email, password: p1 });
        if (error) throw error;
        closeModal();
        boot("Auth: signed in");
        return;
      }

      if (authMode === "register") {
        const { error } = await supabaseClient.auth.signUp({
          email,
          password: p1,
          options: {
            emailRedirectTo: `${APP_BASE_URL}#verify`
          }
        });
        if (error) throw error;
        authMsg.textContent = "Zkontroluj email a potvrď registraci.";
        boot("Auth: registered");
        return;
      }

      if (authMode === "update") {
        const { error } = await supabaseClient.auth.updateUser({ password: p1 });
        if (error) throw error;
        authMsg.textContent = "Heslo bylo změněno. Přihlas se.";
        boot("Auth: password updated");
        return;
      }
    } catch (err) {
      authMsg.textContent = "Chyba: " + (err.message || "Neznámá chyba");
      boot("Auth: error");
    } finally {
      submitAuthBtn.disabled = false;
    }
  }

  submitAuthBtn.onclick = runAuth;

  forgotBtn.onclick = async () => {
    const email = (authEmail.value || "").trim();
    if (!email) { authMsg.textContent = "Zadej email."; return; }

    authMsg.textContent = "Odesílám reset…";
    boot("Auth: reset request");

    const { error } = await supabaseClient.auth.resetPasswordForEmail(email, {
      redirectTo: `${APP_BASE_URL}#reset`
    });

    if (error) {
      authMsg.textContent = "Chyba: " + error.message;
      boot("Auth: reset error");
    } else {
      authMsg.textContent = "Reset odkaz poslán. Zkontroluj email.";
      boot("Auth: reset sent");
    }
  };

  function setAuthUI() {
    const userEl = document.getElementById("navUser");
    const hintEl = document.getElementById("navHint");
    const loginBtn = document.getElementById("loginNavBtn");
    const registerBtn = document.getElementById("registerNavBtn");
    const changePassBtn = document.getElementById("changePassNavBtn");
    const logoutBtn = document.getElementById("logoutNavBtn");

    if (session && session.user) {
      userEl.textContent = session.user.email || "Přihlášen";
      loginBtn.classList.add("hidden");
      registerBtn.classList.add("hidden");
      logoutBtn.classList.remove("hidden");
      changePassBtn.classList.remove("hidden");

      if (session.user.email_confirmed_at) {
        isVerified = true;
        hintEl.textContent = "Ověřeno ✅";
      } else {
        isVerified = false;
        hintEl.textContent = "Prosím ověř email.";
      }
    } else {
      userEl.textContent = "Nepřihlášen";
      hintEl.textContent = "";
      loginBtn.classList.remove("hidden");
      registerBtn.classList.remove("hidden");
      logoutBtn.classList.add("hidden");
      changePassBtn.classList.add("hidden");
      isVerified = false;
    }
  }

  async function signOut() {
    await supabaseClient.auth.signOut();
    session = null;
    setAuthUI();
  }

  function canVote() {
    return session && session.user && isVerified;
  }

  function escapeHtml(str) {
    return String(str || "")
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll("\"", "&quot;");
  }

  function formatRemainingTime(endAt) {
    if (!endAt || Number.isNaN(endAt)) return "";
    const diff = Math.max(0, endAt - Date.now());
    const mins = Math.floor(diff / 60000);
    const hrs = Math.floor(mins / 60);
    const days = Math.floor(hrs / 24);
    if (days > 0) return `${days} dní`;
    if (hrs > 0) return `${hrs} hodin`;
    return `${mins} minut`;
  }

  function getEventEnd(eventItem) {
    if (!eventItem?.ends_at) return NaN;
    const ts = Date.parse(eventItem.ends_at);
    return Number.isNaN(ts) ? NaN : ts;
  }

  function setActiveView(id) {
    document.querySelectorAll(".view").forEach(v => v.classList.remove("active"));
    document.getElementById(id).classList.add("active");
  }

  function navigateHome() {
    window.location.hash = "";
    setActiveView("homeView");
  }

  function navigateCountry(code) {
    currentCountry = code;
    window.location.hash = `#country=${encodeURIComponent(code)}`;
    setActiveView("countryView");
    loadCountryDetail(code);
  }

  function navigateEvent(eventId) {
    window.location.hash = `#event=${encodeURIComponent(eventId)}`;
    setActiveView("eventView");
    loadEventDetail(eventId);
  }

  async function loadTop3() {
    boot("Data: loading TOP3…");
    const target = document.getElementById("top3");
    target.innerHTML = "<div class='muted'>Načítání…</div>";

    // Order by votes (view)
    const { data, error } = await supabaseClient
      .from("event_vote_counts")
      .select("event_id,votes,events(title,description,country_code,ends_at,is_active)")
      .order("votes", { ascending: false })
      .limit(3);

    if (error || !data?.length) {
      target.innerHTML = "<div class='muted'>Zatím nejsou data pro TOP3.</div>";
      boot("Data: TOP3 empty");
      return;
    }

    const normalized = data.map(row => ({
      id: row.event_id,
      votes: row.votes,
      title: row.events?.title || "Událost",
      description: row.events?.description || "",
      country_code: row.events?.country_code || "",
      ends_at: row.events?.ends_at,
      is_active: row.events?.is_active
    }));

    // Mark whether current user voted on each top3 event
    let votedMap = new Map();
    if (session?.user?.id) {
      try {
        const ids = normalized.map(x => x.id);
        const { data: myVotes, error: vErr } = await supabaseClient
          .from("votes")
          .select("event_id")
          .eq("user_id", session.user.id)
          .in("event_id", ids);
        if (!vErr && myVotes) {
          votedMap = new Map(myVotes.map(v => [v.event_id, true]));
        }
      } catch (e) {
        console.warn("Top3 votes lookup failed", e);
      }
    }

    renderTop3(normalized, votedMap);
    boot("Data: TOP3 ready");
  }

  function renderTop3(items, votedMap) {
    const target = document.getElementById("top3");
    target.innerHTML = "";
    if (!items?.length) {
      target.innerHTML = "<div class='muted'>Zatím nejsou data pro TOP3.</div>";
      return;
    }

    items.forEach((eventItem, idx) => {
      const hasVoted = votedMap && votedMap.has(eventItem.id);
      const div = document.createElement("div");
      div.className = "card top3Item";
      div.onclick = () => navigateEvent(eventItem.id);

      const endAt = getEventEnd(eventItem);
      const ended = eventItem.is_active === false
        ? true
        : (Number.isNaN(endAt) ? false : endAt < Date.now());
      const statusPill = ended ? "<span class='pill'>ukončeno</span>" : "<span class='pill'>aktivní</span>";

      div.innerHTML = `
        <div class="top3TitleRow">
          <div class="eventTitle">${escapeHtml(eventItem.title)} ${statusPill}</div>
          ${hasVoted ? `<span class="pill top3VotedPill">Odhlasováno</span>` : ""}
        </div>
        <div class="muted">${escapeHtml(eventItem.description)}</div>
        <div class="top3Meta">
          <div class="muted">Země: ${escapeHtml(eventItem.country_code || "")}</div>
        </div>
      `;
      target.appendChild(div);
    });
  }

  function renderEventList(container, items, votesMap, resultsMap, emptyMessage, clickable) {
    container.innerHTML = "";
    if (!items?.length) {
      container.innerHTML = `<div class='muted'>${emptyMessage}</div>`;
      return;
    }

    for (const eventItem of items) {
      const hasVoted = votesMap && votesMap.has(eventItem.id);

      const div = document.createElement("div");
      div.className = "card" + (clickable ? " eventItem" : "");
      if (clickable) {
        div.onclick = (evt) => {
          if (evt.target.closest("button")) return;
          navigateEvent(eventItem.id);
        };
      }

      const endAt = getEventEnd(eventItem);
      const ended = eventItem.is_active === false
        ? true
        : (Number.isNaN(endAt) ? false : endAt < Date.now());
      const statusPill = ended ? "<span class='pill'>ukončeno</span>" : "<span class='pill'>aktivní</span>";

      const remainingLabel = ended
        ? "Hlasování ukončeno"
        : `Do konce hlasování zbývá: ${escapeHtml(formatRemainingTime(endAt))}`;
      const titleLine = clickable
        ? `
          <div class="eventTitleRow">
            <div class="eventTitle">${escapeHtml(eventItem.title || "Untitled")} ${statusPill}</div>
            ${hasVoted ? `<span class="pill eventVotedPill">Odhlasováno</span>` : ""}
          </div>
        `
        : "";
      const descClass = clickable ? "muted" : "eventQuestion";
      div.innerHTML = `
        ${titleLine}
        <div class="${descClass}">${escapeHtml(eventItem.description || "")}</div>
        <div class="eventMetaRow${clickable ? "" : " single"}">
          ${clickable ? `<div class="eventCountry muted">Země: ${escapeHtml(eventItem.country_code || "")}</div>` : ""}
          <div class="eventRemaining muted">${remainingLabel}</div>
        </div>
      `;

      // Answers
      const answers = document.createElement("div");
      answers.className = "answers";

      function mkAnswer(label, choice, className) {
        const b = document.createElement("button");
        b.textContent = label;
        b.className = `primary ${className || ""}`.trim();
        b.disabled = ended || !canVote() || hasVoted;

        b.onclick = async () => {
          if (!canVote()) {
            alert("Hlasování je dostupné jen pro přihlášené a ověřené uživatele.");
            return;
          }
          if (ended) {
            alert("Tato událost už je ukončená.");
            return;
          }
          if (hasVoted) {
            alert("Už jste pro tuto událost hlasoval.");
            return;
          }

          boot("Vote: submitting…");
          const normalizedChoice = String(choice || "")
            .trim()
            .toLowerCase() === "dk"
            ? "na"
            : String(choice || "").trim().toLowerCase();
          const payload = { event_id: eventItem.id, user_id: session.user.id, choice: normalizedChoice };
          const { error } = await supabaseClient.from("votes").insert(payload);

          if (error) {
            // Duplicate vote (unique constraint) -> show friendly message
            if (error.code === "23505") {
              alert("Už jste pro tuto událost hlasoval.");
            } else {
              alert("Hlasování se nepodařilo: " + error.message);
            }
            boot("Vote: error");
            return;
          }

          alert("Díky! Hlas byl uložen.");
          boot("Vote: OK");

          // Refresh events + TOP3 so results update immediately
          await loadEventsForCountry(eventItem.country_code);
          await loadTop3();
        };

        return b;
      }

      answers.appendChild(mkAnswer("Ano", "yes", "answer-yes"));
      answers.appendChild(mkAnswer("Ne", "no", "answer-no"));
      answers.appendChild(mkAnswer("Nevím", "na", "answer-dk"));
      if (!clickable) {
        if (hasVoted) {
          const votedMsg = document.createElement("div");
          votedMsg.className = "votedBadge";
          votedMsg.textContent = "Odhlasováno";
          div.appendChild(votedMsg);
        } else {
          div.appendChild(answers);
        }
      }

      if (!clickable) {
        // Results (public)
        const resWrap = document.createElement("div");
        resWrap.className = "resultsWrap";

        const r = resultsMap && resultsMap.has(eventItem.id) ? resultsMap.get(eventItem.id) : null;
        if (r) {
          resWrap.appendChild(renderResultBlock("Celkem (všichni)", { yes: r.yes_total, no: r.no_total, dk: r.dk_total, total: r.votes_total }, "large"));
          resWrap.appendChild(renderResultBlock("Občané cílové země", { yes: r.yes_dom, no: r.no_dom, dk: r.dk_dom, total: r.votes_dom_total }, "medium"));
          resWrap.appendChild(renderResultBlock("Ostatní země", { yes: r.yes_for, no: r.no_for, dk: r.dk_for, total: r.votes_for_total }, "small"));
        } else {
          resWrap.innerHTML = "<div class='muted'>Výsledky se načítají…</div>";
        }

        div.appendChild(resWrap);
      }
      container.appendChild(div);
    }
  }

  function renderEvents(items, votesMap, resultsMap) {
    const activeWrap = document.getElementById("eventsActive");
    const archiveWrap = document.getElementById("eventsArchive");
    const now = Date.now();

    const active = [];
    const archived = [];
    for (const e of items || []) {
      const endAt = getEventEnd(e);
      const ended = e.is_active === false
        ? true
        : (Number.isNaN(endAt) ? false : endAt < now);
      if (ended || e.is_active === false) {
        archived.push(e);
      } else {
        active.push(e);
      }
    }

    renderEventList(
      activeWrap,
      active,
      votesMap,
      resultsMap,
      "V této zemi zatím nejsou žádné aktivní události.",
      true
    );
    renderEventList(
      archiveWrap,
      archived,
      votesMap,
      resultsMap,
      "Zatím tu nejsou žádné ukončené události.",
      true
    );
  }


  async function loadEventsForCountry(countryCode) {
    if (!countryCode) return;
    boot("Data: loading events…");
    currentCountry = countryCode;
    const { data, error } = await supabaseClient
      .from("events")
      .select("id,title,description,country_code,is_active,is_top,ends_at,created_at")
      .eq("country_code", countryCode)
      .order("created_at", { ascending: false });

    
if (error) throw new Error("Events load failed: " + error.message);

    const events = data || [];
    const ids = events.map(x => x.id);

    // My votes (for disabling buttons) - only when logged in
    let votesMap = new Map();
    if (session?.user?.id && ids.length) {
      try {
        const { data: myVotes, error: vErr } = await supabaseClient
          .from("votes")
          .select("event_id")
          .eq("user_id", session.user.id)
          .in("event_id", ids);

        if (!vErr && myVotes) {
          votesMap = new Map(myVotes.map(v => [v.event_id, true]));
        }
      } catch (e) {
        console.warn("Votes lookup failed", e);
      }
    }

    // Public results (visible to everyone) via RPC
    let resultsMap = new Map();
    if (ids.length) {
      try {
        const { data: rows, error: rErr } = await supabaseClient.rpc("get_event_results", { event_ids: ids });
        if (!rErr && rows) {
          resultsMap = new Map(rows.map(r => [r.event_id, r]));
        } else if (rErr) {
          console.warn("Results RPC error", rErr);
        }
      } catch (e) {
        console.warn("Results lookup failed", e);
      }
    }

    renderEvents(events, votesMap, resultsMap);
    await loadCountryTop(events);
    const countryName = cachedCountries.find(c => c.code === countryCode)?.name || countryCode;
    document.getElementById("countryTitle").textContent = countryName;
    document.getElementById("countrySubtitle").textContent = `Země: ${countryName} (${countryCode})`;
    const homeTitle = document.getElementById("homeTitle");
    if (homeTitle) {
      homeTitle.textContent = `Země: ${countryCode}`;
    }
    boot("Data: events ready");
  }

  async function loadCountryDetail(code) {
    await loadEventsForCountry(code);
  }

  async function loadEventDetail(eventId) {
    const detailCard = document.getElementById("eventDetailCard");
    detailCard.innerHTML = "<div class='muted'>Načítání události…</div>";

    const { data: eventData, error } = await supabaseClient
      .from("events")
      .select("id,title,description,country_code,is_active,ends_at,created_at")
      .eq("id", eventId)
      .single();

    if (error || !eventData) {
      detailCard.innerHTML = "<div class='muted'>Událost se nepodařilo načíst.</div>";
      return;
    }

    const { data: rows } = await supabaseClient.rpc("get_event_results", { event_ids: [eventId] });
    const resultsMap = new Map((rows || []).map(r => [r.event_id, r]));

    let votesMap = new Map();
    if (session?.user?.id) {
      const { data: myVotes } = await supabaseClient
        .from("votes")
        .select("event_id")
        .eq("user_id", session.user.id)
        .eq("event_id", eventId);
      if (myVotes?.length) {
        votesMap.set(eventId, true);
      }
    }

    const eventMeta = document.getElementById("eventMeta");
    document.getElementById("eventTitle").textContent = eventData.title || "Událost";
    if (eventMeta) {
      eventMeta.textContent = "";
      eventMeta.classList.add("hidden");
      eventMeta.classList.remove("eventQuestion");
    }
    const eventCountryHeader = document.getElementById("eventCountryHeader");
    if (eventCountryHeader) {
      eventCountryHeader.textContent = `Země: ${eventData.country_code || ""}`;
    }
    const statusEl = document.getElementById("eventStatus");
    const eventEndAt = getEventEnd(eventData);
    const isClosed = eventData.is_active === false || (Number.isNaN(eventEndAt) ? false : eventEndAt < Date.now());
    if (statusEl) {
      statusEl.textContent = isClosed ? "Uzavřeno" : "Aktivní";
      statusEl.classList.toggle("active", !isClosed);
      statusEl.classList.toggle("closed", isClosed);
    }
    detailCard.innerHTML = "";
    const wrap = document.createElement("div");
    renderEventList(wrap, [eventData], votesMap, resultsMap, "", false);
    detailCard.appendChild(wrap.firstElementChild || wrap);
  }

  async function loadCountryTop(events) {
    const target = document.getElementById("countryTop");
    if (!events?.length) {
      target.textContent = "Zatím žádná data pro TOP událost.";
      return;
    }

    const ids = events.map(e => e.id);
    const { data, error } = await supabaseClient
      .from("event_vote_counts")
      .select("event_id,votes")
      .in("event_id", ids)
      .order("votes", { ascending: false })
      .limit(1);

    if (error || !data?.length) {
      target.textContent = "Zatím žádná data pro TOP událost.";
      return;
    }

    const top = data[0];
    const event = events.find(e => e.id === top.event_id);
    target.innerHTML = `
      <div class="eventTitle">${escapeHtml(event?.title || "Událost")}</div>
      <div class="muted">Hlasujících celkem: <b>${top.votes || 0}</b></div>
    `;
  }

  async function loadContinentsAndCountries() {
    boot("Init: loading continents/countries…");

    const { data: continents, error: cErr } = await supabaseClient
      .from("continents")
      .select("id,name,code")
      .order("id", { ascending: true });

    if (cErr) throw new Error("Continents load failed: " + cErr.message);

    cachedContinents = continents || [];
    const continentTabs = document.getElementById("continentTabs");
    const countryList = document.getElementById("countryList");
    const countryPopover = document.getElementById("countryPopover");
    continentTabs.innerHTML = "";

    async function fillCountries(continentId, shouldOpen = true) {
      countryList.innerHTML = "";
      if (shouldOpen) {
        countryPopover.classList.add("open");
      }
      const { data: countries, error: coErr } = await supabaseClient
        .from("countries")
        .select("code,name,continent_id")
        .eq("continent_id", Number(continentId))
        .order("name", { ascending: true });

      if (coErr) throw new Error("Countries load failed: " + coErr.message);
      cachedCountries = countries || [];
      for (const co of cachedCountries) {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "countryBtn";
        btn.textContent = co.name + " (" + co.code + ")";
        btn.onclick = () => {
          navigateCountry(co.code);
          countryPopover.classList.remove("open");
        };
        countryList.appendChild(btn);
      }
      rebuildSearchIndex();
    }

    for (const c of cachedContinents) {
      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "continentBtn";
      btn.textContent = c.name;
      btn.onclick = async () => {
        document.querySelectorAll(".continentBtn").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        await fillCountries(c.id, true);
      };
      continentTabs.appendChild(btn);
    }

    if (cachedContinents[0]) {
      const firstBtn = continentTabs.querySelector(".continentBtn");
      if (firstBtn) firstBtn.classList.add("active");
      await fillCountries(cachedContinents[0].id, false);
    }

    boot("Init: geo ready");
  }

  function goHome() {
    window.scrollTo({ top: 0, behavior: "smooth" });
    navigateHome();
    const countryPopover = document.getElementById("countryPopover");
    if (countryPopover) countryPopover.classList.remove("open");
    boot("UI: home");
  }

  function maybeOpenRecoveryModal() {
    // If user comes back from reset email link, Supabase usually triggers PASSWORD_RECOVERY event.
    // We also check hash for "type=recovery" or our "#reset" marker.
    const h = window.location.hash || "";
    const isRecoveryHint = h.includes("type=recovery") || h.includes("access_token") || h.includes("#reset");
    if (isRecoveryHint) {
      authMode = "update";
      setModeUI();
      openModal("update");
      authMsg.textContent = "Nastav nové heslo (z reset odkazu).";
    }
  }

  function handleInitialRoute() {
    const hash = window.location.hash || "";
    if (hash.startsWith("#country=")) {
      const code = hash.replace("#country=", "").trim();
      if (code) {
        navigateCountry(code);
        return;
      }
    }
    if (hash.startsWith("#event=")) {
      const id = hash.replace("#event=", "").trim();
      if (id) {
        setActiveView("eventView");
        loadEventDetail(id);
        return;
      }
    }
    navigateHome();
  }

  function rebuildSearchIndex() {
    const list = document.getElementById("searchOptions");
    list.innerHTML = "";
    searchIndex = new Map();
    for (const c of cachedCountries) {
      const label = `Země: ${c.name} (${c.code})`;
      const opt = document.createElement("option");
      opt.value = label;
      list.appendChild(opt);
      searchIndex.set(label.toLowerCase(), { type: "country", code: c.code });
    }
  }

  let searchTimer = null;
  async function updateSearch(term) {
    const list = document.getElementById("searchOptions");
    const trimmed = (term || "").trim();
    const normalized = trimmed.toLowerCase();
    if (!trimmed || trimmed.length < 2) {
      rebuildSearchIndex();
      return;
    }
    if (searchIndex.has(normalized)) {
      return;
    }
    if (searchTimer) clearTimeout(searchTimer);
    searchTimer = setTimeout(async () => {
      rebuildSearchIndex();
      const { data, error } = await supabaseClient
        .from("events")
        .select("id,title,country_code")
        .ilike("title", `%${trimmed}%`)
        .limit(8);
      if (error || !data) return;
      for (const ev of data) {
        const label = `Událost: ${ev.title} (${ev.country_code || "??"})`;
        const opt = document.createElement("option");
        opt.value = label;
        list.appendChild(opt);
        searchIndex.set(label.toLowerCase(), { type: "event", id: ev.id, country: ev.country_code });
      }
    }, 250);
  }

  function handleSearchSubmit() {
    const input = document.getElementById("globalSearch");
    const value = (input.value || "").trim();
    const normalized = value.toLowerCase();
    if (!value) return;
    const hit = searchIndex.get(normalized);
    if (hit?.type === "country") {
      navigateCountry(hit.code);
      return;
    }
    if (hit?.type === "event") {
      if (hit.country) {
        currentCountry = hit.country;
      }
      navigateEvent(hit.id);
      return;
    }
  }

  (async function init() {
    try {
      boot("Init: JS running");
      const supabaseLib = await loadSupabase();

      supabaseClient = supabaseLib.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
        auth: {
          persistSession: true,
          autoRefreshToken: true,
          detectSessionInUrl: true
        }
      });

      boot("Init: Supabase ready");

      // Navbar actions
      document.getElementById("homeBtn").onclick = goHome;
      document.getElementById("backToHomeBtn").onclick = goHome;
      document.getElementById("backToCountryBtn").onclick = () => {
        if (currentCountry) {
          navigateCountry(currentCountry);
        } else {
          navigateHome();
        }
      };
      document.getElementById("loginNavBtn").onclick = () => openModal("login");
      document.getElementById("registerNavBtn").onclick = () => openModal("register");
      document.getElementById("changePassNavBtn").onclick = () => openModal("update");
      document.getElementById("logoutNavBtn").onclick = signOut;

      // Refresh actions
      document.getElementById("refreshTop3Btn").onclick = loadTop3;
      const globalSearch = document.getElementById("globalSearch");
      globalSearch.setAttribute("list", "searchOptions");
      globalSearch.addEventListener("input", (e) => updateSearch(e.target.value));
      globalSearch.addEventListener("change", handleSearchSubmit);
      globalSearch.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          handleSearchSubmit();
        }
      });
      document.addEventListener("click", (event) => {
        const popover = document.getElementById("countryPopover");
        const tabs = document.getElementById("continentTabs");
        if (!popover || !tabs) return;
        if (!popover.classList.contains("open")) return;
        const clickedInside = popover.contains(event.target) || tabs.contains(event.target);
        if (!clickedInside) {
          popover.classList.remove("open");
        }
      });

      // Session
      const { data: sessData } = await supabaseClient.auth.getSession();
      session = sessData?.session || null;
      setAuthUI();

      supabaseClient.auth.onAuthStateChange(async (event, newSession) => {
        session = newSession;
        setAuthUI();

        if (event === "PASSWORD_RECOVERY") {
          // open change password modal automatically
          openModal("update");
          authMsg.textContent = "Nastav nové heslo (reset).";
        }

        if (currentCountry) await loadEventsForCountry(currentCountry);
      });

      await loadContinentsAndCountries();
      await loadTop3();
      handleInitialRoute();

      // If user lands with recovery hash, open the update modal
      maybeOpenRecoveryModal();

      boot("Boot: ready");
    } catch (err) {
      boot("Startup error: " + err.message);
      console.error(err);
    }
  })();
}
</script>
</body>
</html>
