<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>People Can Vote</title>
<style>
  :root { --muted:#555; --border:#e6e6e6; --bg:#fff; }
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 0; background: var(--bg); }
  main { padding: 20px 24px 64px; max-width: 1100px; margin: 0 auto; }
  h1 { margin: 12px 0 12px; }
  #boot { position: fixed; bottom: 10px; left: 10px; font-size: 12px; color: var(--muted);
          background: rgba(255,255,255,0.92); padding: 6px 8px; border-radius: 10px; border: 1px solid var(--border); }
  .row { display:flex; gap: 12px; align-items:center; flex-wrap:wrap; }
  .card { border: 1px solid var(--border); border-radius: 14px; padding: 12px; margin: 12px 0; background:#fff; }
  .muted { color: var(--muted); }
  .hidden { display:none !important; }
  select, button, input { padding: 8px 10px; border-radius: 10px; border: 1px solid var(--border); background: white; }
  input { min-width: 260px; }
  button { cursor: pointer; }
  button.primary { font-weight: 800; }
  button.ghost { background: transparent; }
  button[disabled] { opacity: 0.55; cursor: not-allowed; }
  .list { display:flex; flex-direction:column; gap: 10px; }
  .eventTitle { font-weight:900; margin-bottom:4px; }
  .pill { display:inline-block; padding:2px 8px; border:1px solid var(--border); border-radius:999px; font-size:12px; color:#333; margin-left:6px; }
  .top3grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 10px; }

  /* navbar */
  .nav {
    position: sticky; top: 0; z-index: 10;
    border-bottom: 1px solid var(--border);
    background: rgba(255,255,255,0.95);
    backdrop-filter: blur(8px);
  }
  .navInner { max-width: 1100px; margin: 0 auto; padding: 10px 24px; display:flex; justify-content:space-between; align-items:center; gap: 12px; }
  .brand { font-weight: 900; letter-spacing: 0.2px; }
  .navRight { display:flex; align-items:center; gap: 8px; flex-wrap: wrap; justify-content:flex-end; }
  .small { font-size: 12px; }

  /* modal */
  .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.35); display:none; align-items:center; justify-content:center; z-index: 50; }
  .overlay.open { display:flex; }
  .modal { width: min(520px, calc(100vw - 32px)); background:#fff; border-radius: 16px; border:1px solid var(--border); box-shadow: 0 10px 30px rgba(0,0,0,0.18); }
  .modalHeader { display:flex; justify-content:space-between; align-items:center; padding: 12px 14px; border-bottom:1px solid var(--border); }
  .modalTitle { font-weight: 900; }
  .modalBody { padding: 14px; }
  .field { display:flex; flex-direction:column; gap:6px; margin-bottom: 12px; }
  .actions { display:flex; gap:10px; align-items:center; justify-content:flex-end; flex-wrap:wrap; }
  .tabs { display:flex; gap:8px; }
  .tab { border:1px solid var(--border); border-radius: 999px; padding: 6px 10px; cursor:pointer; background:#fff; }
  .tab.active { font-weight: 800; }
  .msg { margin-top: 10px; }
</style>
</head>
<body>

<div class="nav">
  <div class="navInner">
    <div class="row" style="gap:10px;">
      <span class="brand">People Can Vote</span>
      <button id="homeBtn" class="ghost">Domů</button>
    </div>
    <div class="navRight">
      <span id="navUser" class="muted small">Načítání…</span>
      <button id="loginNavBtn">Přihlásit</button>
      <button id="registerNavBtn">Registrovat</button>
      <button id="logoutNavBtn" class="hidden">Odhlásit</button>
    </div>
  </div>
</div>

<main>
  <h1>Hlasování a statistiky</h1>

  <div class="card" id="authCard">
    <div id="authStatus" class="muted">Načítání uživatele…</div>
    <div id="voteGateMsg" class="muted" style="margin-top:8px;"></div>
  </div>

  <div class="card" id="homeCard">
    <div class="row">
      <label for="continentSel"><b>Kontinent</b></label>
      <select id="continentSel"></select>

      <label for="countrySel"><b>Země</b></label>
      <select id="countrySel"></select>

      <button id="refreshEventsBtn">Obnovit události</button>
    </div>
    <div class="muted" style="margin-top:8px;">
      Statistiky jsou veřejné. Hlasovat může jen přihlášený a ověřený uživatel.
    </div>
  </div>

  <div class="card">
    <div class="row" style="justify-content:space-between;">
      <b>TOP 3 události (nejvíc hlasujících)</b>
      <button id="refreshTop3Btn">Obnovit</button>
    </div>
    <div id="top3" class="top3grid" style="margin-top:10px;"></div>
  </div>

  <div class="card">
    <div class="row" style="justify-content:space-between;">
      <b>Události v zemi</b>
    </div>
    <div id="events" class="list" style="margin-top:10px;"></div>
  </div>
</main>

<!-- AUTH MODAL -->
<div id="overlay" class="overlay" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="modalHeader">
      <div class="row" style="gap:10px;">
        <div id="modalTitle" class="modalTitle">Účet</div>
        <div class="tabs">
          <button id="tabLogin" class="tab active" type="button">Přihlášení</button>
          <button id="tabRegister" class="tab" type="button">Registrace</button>
        </div>
      </div>
      <button id="closeModalBtn" class="ghost" type="button" aria-label="Zavřít">✕</button>
    </div>
    <div class="modalBody">
      <div class="field">
        <label for="authEmail"><b>Email</b></label>
        <input id="authEmail" type="email" autocomplete="email" placeholder="email@domena.cz">
      </div>
      <div class="field">
        <label for="authPassword"><b>Heslo</b></label>
        <input id="authPassword" type="password" autocomplete="current-password" placeholder="••••••••">
        <div class="muted small">Doporučeno aspoň 8 znaků.</div>
      </div>

      <div class="actions">
        <button id="submitAuthBtn" class="primary" type="button">Přihlásit</button>
      </div>

      <div id="authMsg" class="msg muted"></div>
    </div>
  </div>
</div>

<div id="boot">Booting…</div>

<script>
if (window.__PCV_INIT_DONE__) {
  console.warn("PCV: duplicate init prevented");
} else {
  window.__PCV_INIT_DONE__ = true;

  function boot(msg) {
    const el = document.getElementById("boot");
    if (el) el.textContent = msg;
    console.log(msg);
  }

  async function loadSupabase() {
    boot("Init: loading Supabase…");
    return new Promise((resolve, reject) => {
      const s = document.createElement("script");
      s.src = "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2";
      s.async = true;
      s.onload = () => resolve(window.supabase);
      s.onerror = () => reject(new Error("Supabase load failed"));
      document.head.appendChild(s);
      setTimeout(() => reject(new Error("Supabase load timeout")), 12000);
    });
  }

  const SUPABASE_URL = "https://jqoomnhpyuikbntnrukw.supabase.co";
  const SUPABASE_ANON_KEY = "sb_publishable_SjZ_HQWN0XRE9ebbf_OwQg_kmJeS43h";

  // GitHub Pages base URL (musí sedět s Redirect URLs v Supabase)
  const APP_BASE_URL = "https://martinek-arch.github.io/People-can-a-Vote/";

  let supabaseClient = null;
  let session = null;
  let isVerified = false;

  /* ===== Modal state ===== */
  let authMode = "login"; // "login" | "register"

  const overlay = document.getElementById("overlay");
  const tabLogin = document.getElementById("tabLogin");
  const tabRegister = document.getElementById("tabRegister");
  const submitAuthBtn = document.getElementById("submitAuthBtn");
  const authMsg = document.getElementById("authMsg");
  const authEmail = document.getElementById("authEmail");
  const authPassword = document.getElementById("authPassword");

  function openModal(mode) {
    authMode = mode;
    authMsg.textContent = "";
    authPassword.value = "";
    setModeUI();
    overlay.classList.add("open");
    overlay.setAttribute("aria-hidden", "false");
    setTimeout(() => authEmail.focus(), 0);
  }
  function closeModal() {
    overlay.classList.remove("open");
    overlay.setAttribute("aria-hidden", "true");
    authMsg.textContent = "";
  }
  function setModeUI() {
    if (authMode === "login") {
      tabLogin.classList.add("active");
      tabRegister.classList.remove("active");
      submitAuthBtn.textContent = "Přihlásit";
      authPassword.setAttribute("autocomplete", "current-password");
    } else {
      tabLogin.classList.remove("active");
      tabRegister.classList.add("active");
      submitAuthBtn.textContent = "Registrovat";
      authPassword.setAttribute("autocomplete", "new-password");
    }
  }

  document.getElementById("closeModalBtn").onclick = closeModal;
  overlay.addEventListener("click", (e) => { if (e.target === overlay) closeModal(); });
  window.addEventListener("keydown", (e) => { if (e.key === "Escape" && overlay.classList.contains("open")) closeModal(); });
  tabLogin.onclick = () => { authMode = "login"; authMsg.textContent = ""; setModeUI(); };
  tabRegister.onclick = () => { authMode = "register"; authMsg.textContent = ""; setModeUI(); };

  async function runAuth() {
    const email = (authEmail.value || "").trim();
    const password = authPassword.value || "";

    if (!email) { authMsg.textContent = "Zadej email."; return; }
    if (password.length < 8) { authMsg.textContent = "Heslo musí mít alespoň 8 znaků."; return; }

    submitAuthBtn.disabled = true;
    authMsg.textContent = authMode === "login" ? "Přihlašuji…" : "Registruji…";
    boot("Auth: working…");

    try {
      if (authMode === "login") {
        const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
        if (error) throw error;
        // session se nastaví přes onAuthStateChange, ale zavřeme modal hned
        authMsg.textContent = "Přihlášeno.";
        closeModal();
        boot("Auth: signed in");
        return;
      }

      // REGISTER
      const { data, error } = await supabaseClient.auth.signUp({
        email,
        password,
        options: {
          // po potvrzení emailu se uživatel vrátí sem
          emailRedirectTo: APP_BASE_URL + "#auth"
        }
      });
      if (error) throw error;

      // Pokud je v projektu zapnuté "Confirm email", user bude neověřený dokud nepotvrdí email.
      authMsg.textContent = "Registrace vytvořena. Zkontroluj email a potvrď adresu. Pak se přihlas heslem.";
      boot("Auth: signUp ok");
    } catch (err) {
      console.error(err);
      authMsg.textContent = (err && err.message) ? err.message : "Neznámá chyba";
      boot("Auth: error");
    } finally {
      submitAuthBtn.disabled = false;
    }
  }

  submitAuthBtn.onclick = runAuth;
  authPassword.addEventListener("keydown", (e) => { if (e.key === "Enter") runAuth(); });
  authEmail.addEventListener("keydown", (e) => { if (e.key === "Enter") authPassword.focus(); });

  /* ===== App auth UI ===== */
  function disableVoteButtons(disabled) {
    document.querySelectorAll("button[data-vote-btn='1']").forEach(b => { b.disabled = disabled; });
  }

  function setAuthUI() {
    const authStatus = document.getElementById("authStatus");
    const voteGateMsg = document.getElementById("voteGateMsg");
    const navUser = document.getElementById("navUser");

    const loginBtn = document.getElementById("loginNavBtn");
    const registerBtn = document.getElementById("registerNavBtn");
    const logoutBtn = document.getElementById("logoutNavBtn");

    if (!session) {
      isVerified = false;
      authStatus.textContent = "Nepřihlášený uživatel";
      voteGateMsg.textContent = "Hlasování je dostupné pouze pro přihlášené a ověřené uživatele.";
      navUser.textContent = "Nepřihlášený";

      loginBtn.classList.remove("hidden");
      registerBtn.classList.remove("hidden");
      logoutBtn.classList.add("hidden");

      disableVoteButtons(true);
      return;
    }

    isVerified = !!session.user?.email_confirmed_at;
    const email = session.user?.email || "uživatel";

    navUser.textContent = email + (isVerified ? " (ověřený)" : " (neověřený)");
    authStatus.textContent = isVerified
      ? "Přihlášený a ověřený uživatel"
      : "Přihlášený, ale NEověřený uživatel";

    voteGateMsg.textContent = isVerified
      ? ""
      : "Prosím potvrď email (odkaz v emailu) – bez ověření nejde hlasovat.";

    loginBtn.classList.add("hidden");
    registerBtn.classList.add("hidden");
    logoutBtn.classList.remove("hidden");

    disableVoteButtons(!isVerified);
  }

  function canVote() { return !!session && !!isVerified; }

  async function signOut() {
    boot("Auth: signing out…");
    await supabaseClient.auth.signOut();
    boot("Auth: signed out");
  }

  /* ===== Data rendering ===== */
  function escapeHtml(s) {
    return String(s ?? "")
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  function renderTop3(items) {
    const top3 = document.getElementById("top3");
    top3.innerHTML = "";
    if (!items?.length) {
      top3.innerHTML = "<div class='muted'>Zatím žádná data pro TOP 3.</div>";
      return;
    }
    for (const it of items) {
      const div = document.createElement("div");
      div.className = "card";
      div.innerHTML = `
        <div class="eventTitle">${escapeHtml(it.title || "Untitled")}</div>
        <div class="muted">${escapeHtml(it.country_code || "")}</div>
        <div style="margin-top:6px;"><span class="pill">hlasujících: ${it.votes ?? 0}</span></div>
      `;
      top3.appendChild(div);
    }
  }

  async function loadTop3() {
    boot("Data: loading TOP3…");
    const { data, error } = await supabaseClient
      .from("event_vote_counts")
      .select("event_id,votes,events(title,country_code,is_active)")
      .order("votes", { ascending: false })
      .limit(3);

    if (error) throw new Error("TOP3 load failed: " + error.message);

    const normalized = (data || [])
      .map(r => ({
        event_id: r.event_id,
        votes: r.votes,
        title: r.events?.title,
        country_code: r.events?.country_code,
        is_active: r.events?.is_active
      }))
      .filter(x => x.is_active !== false);

    renderTop3(normalized);
    boot("Data: TOP3 ready");
  }

  function renderEvents(items) {
    const events = document.getElementById("events");
    events.innerHTML = "";
    if (!items?.length) {
      events.innerHTML = "<div class='muted'>V této zemi zatím nejsou žádné aktivní události.</div>";
      return;
    }

    for (const e of items) {
      const div = document.createElement("div");
      div.className = "card";

      const btn = document.createElement("button");
      btn.textContent = "Hlasovat";
      btn.className = "primary";
      btn.dataset.voteBtn = "1";
      btn.disabled = !canVote();

      btn.onclick = async () => {
        if (!canVote()) {
          alert("Hlasování je dostupné jen pro přihlášené a ověřené uživatele.");
          return;
        }
        boot("Vote: submitting…");
        const payload = { event_id: e.id, user_id: session.user.id, choice: "support" };
        const { error } = await supabaseClient.from("votes").insert(payload);
        if (error) {
          alert("Hlasování se nepodařilo: " + error.message);
          boot("Vote: error");
          return;
        }
        alert("Díky! Hlas byl uložen.");
        await loadTop3();
        boot("Vote: OK");
      };

      const ended = e.ends_at ? (new Date(e.ends_at).getTime() < Date.now()) : false;
      const statusPill = ended ? "<span class='pill'>ukončeno</span>" : "<span class='pill'>aktivní</span>";

      div.innerHTML = `
        <div class="eventTitle">${escapeHtml(e.title || "Untitled")} ${statusPill}</div>
        <div class="muted">${escapeHtml(e.description || "")}</div>
        <div class="muted" style="margin-top:6px;">Země: ${escapeHtml(e.country_code || "")}</div>
      `;
      div.appendChild(btn);
      events.appendChild(div);
    }
  }

  async function loadEventsForCountry(countryCode) {
    if (!countryCode) return;
    boot("Data: loading events…");
    const { data, error } = await supabaseClient
      .from("events")
      .select("id,title,description,country_code,is_active,is_top,ends_at,created_at")
      .eq("country_code", countryCode)
      .eq("is_active", true)
      .order("created_at", { ascending: false });

    if (error) throw new Error("Events load failed: " + error.message);

    renderEvents(data || []);
    boot("Data: events ready");
  }

  async function loadContinentsAndCountries() {
    boot("Init: loading continents/countries…");

    const continentSel = document.getElementById("continentSel");
    const countrySel = document.getElementById("countrySel");

    const { data: continents, error: cErr } = await supabaseClient
      .from("continents")
      .select("id,name,code")
      .order("id", { ascending: true });

    if (cErr) throw new Error("Continents load failed: " + cErr.message);

    continentSel.innerHTML = "";
    for (const c of continents) {
      const opt = document.createElement("option");
      opt.value = String(c.id);
      opt.textContent = c.name;
      continentSel.appendChild(opt);
    }

    async function fillCountries(continentId) {
      countrySel.innerHTML = "";
      const { data: countries, error: coErr } = await supabaseClient
        .from("countries")
        .select("code,name,continent_id")
        .eq("continent_id", Number(continentId))
        .order("name", { ascending: true });

      if (coErr) throw new Error("Countries load failed: " + coErr.message);

      for (const co of countries) {
        const opt = document.createElement("option");
        opt.value = co.code;
        opt.textContent = co.name + " (" + co.code + ")";
        countrySel.appendChild(opt);
      }
    }

    continentSel.onchange = async () => {
      await fillCountries(continentSel.value);
      if (countrySel.value) await loadEventsForCountry(countrySel.value);
    };

    countrySel.onchange = async () => {
      if (countrySel.value) await loadEventsForCountry(countrySel.value);
    };

    const firstContinent = continentSel.value || (continents[0] ? String(continents[0].id) : "");
    if (firstContinent) {
      continentSel.value = firstContinent;
      await fillCountries(firstContinent);
      if (countrySel.value) await loadEventsForCountry(countrySel.value);
    }

    boot("Init: geo ready");
  }

  function goHome() {
    window.scrollTo({ top: 0, behavior: "smooth" });
    const continentSel = document.getElementById("continentSel");
    if (continentSel?.options?.length) {
      continentSel.selectedIndex = 0;
      continentSel.dispatchEvent(new Event("change"));
    }
    boot("UI: home");
  }

  (async function init() {
    try {
      boot("Init: JS running");
      const supabaseLib = await loadSupabase();

      supabaseClient = supabaseLib.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
        auth: {
          persistSession: true,
          autoRefreshToken: true,
          detectSessionInUrl: true
        }
      });

      boot("Init: Supabase ready");

      // Navbar actions
      document.getElementById("homeBtn").onclick = goHome;
      document.getElementById("loginNavBtn").onclick = () => openModal("login");
      document.getElementById("registerNavBtn").onclick = () => openModal("register");
      document.getElementById("logoutNavBtn").onclick = signOut;

      // Refresh actions
      document.getElementById("refreshTop3Btn").onclick = loadTop3;
      document.getElementById("refreshEventsBtn").onclick = async () => {
        const cc = document.getElementById("countrySel").value;
        await loadEventsForCountry(cc);
      };

      // Session
      const { data: sessData } = await supabaseClient.auth.getSession();
      session = sessData?.session || null;
      setAuthUI();

      supabaseClient.auth.onAuthStateChange(async (_event, newSession) => {
        session = newSession;
        setAuthUI();
        const cc = document.getElementById("countrySel").value;
        if (cc) await loadEventsForCountry(cc);
      });

      await loadContinentsAndCountries();
      await loadTop3();

      // If redirected from confirm email link, we just land here; session may or may not exist yet
      boot("Boot: ready");
    } catch (err) {
      boot("Startup error: " + err.message);
      console.error(err);
    }
  })();
}
</script>
</body>
</html>
